/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";var ut=Object.defineProperty;var kt=Object.getOwnPropertyDescriptor;var Et=Object.getOwnPropertyNames;var wt=Object.prototype.hasOwnProperty;var Tt=(h,r)=>{for(var t in r)ut(h,t,{get:r[t],enumerable:!0})},St=(h,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Et(r))!wt.call(h,s)&&s!==t&&ut(h,s,{get:()=>r[s],enumerable:!(e=kt(r,s))||e.enumerable});return h};var Dt=h=>St(ut({},"__esModule",{value:!0}),h);var Ct={};Tt(Ct,{default:()=>ct});module.exports=Dt(Ct);var f=require("obsidian");var b=require("obsidian"),Q=class extends b.PluginSettingTab{constructor(r,t){super(r,t),this.plugin=t}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:"\u6EF4\u7B54\u6E05\u5355\u540C\u6B65\u8BBE\u7F6E v2.0 (OAuth2\u7248\u672C)"}),this.addOAuthSettings(r),this.addSyncSettings(r),this.addFormatSettings(r),this.addAdvancedSettings(r)}addOAuthSettings(r){r.createEl("h3",{text:"OAuth2 \u8BA4\u8BC1\u914D\u7F6E"});let t=r.createEl("p");t.innerHTML=`
            <strong>\u91CD\u8981\u8BF4\u660E\uFF1A</strong>\u6EF4\u7B54\u6E05\u5355\u5DF2\u5347\u7EA7\u4E3A\u5B98\u65B9API\uFF0C\u9700\u8981OAuth2\u8BA4\u8BC1\u3002<br/>
            \u8BF7\u5148\u5230 <a href="https://developer.dida365.com/manage" target="_blank">\u6EF4\u7B54\u6E05\u5355\u5F00\u53D1\u8005\u4E2D\u5FC3</a> \u521B\u5EFA\u5E94\u7528\u83B7\u53D6Client ID\u548CSecret\u3002<br/><br/>
            <strong>\u914D\u7F6E\u8981\u6C42\uFF1A</strong><br/>
            \u2022 \u56DE\u8C03\u5730\u5740\u5FC5\u987B\u8BBE\u7F6E\u4E3A\uFF1A<code>http://localhost:8080/callback</code><br/>
            \u2022 \u6743\u9650\u8303\u56F4\u5FC5\u987B\u5305\u542B\uFF1A<code>tasks:read</code> \u548C <code>tasks:write</code>
        `,t.style.backgroundColor="#f0f8ff",t.style.padding="10px",t.style.borderRadius="5px",t.style.marginBottom="15px",new b.Setting(r).setName("Client ID").setDesc("\u4ECE\u6EF4\u7B54\u6E05\u5355\u5F00\u53D1\u8005\u4E2D\u5FC3\u83B7\u53D6\u7684Client ID").addText(i=>i.setPlaceholder("\u8BF7\u8F93\u5165Client ID").setValue(this.plugin.settings.oauth.clientId).onChange(async o=>{this.plugin.settings.oauth.clientId=o,await this.plugin.saveSettings()})),new b.Setting(r).setName("Client Secret").setDesc("\u4ECE\u6EF4\u7B54\u6E05\u5355\u5F00\u53D1\u8005\u4E2D\u5FC3\u83B7\u53D6\u7684Client Secret").addText(i=>{i.setPlaceholder("\u8BF7\u8F93\u5165Client Secret").setValue(this.plugin.settings.oauth.clientSecret).onChange(async o=>{this.plugin.settings.oauth.clientSecret=o,await this.plugin.saveSettings()}),i.inputEl.type="password"}),new b.Setting(r).setName("Redirect URI").setDesc("OAuth\u56DE\u8C03\u5730\u5740\uFF08\u901A\u5E38\u4FDD\u6301\u9ED8\u8BA4\u503C\u5373\u53EF\uFF09").addText(i=>i.setPlaceholder("http://localhost:8080/callback").setValue(this.plugin.settings.oauth.redirectUri).onChange(async o=>{this.plugin.settings.oauth.redirectUri=o,await this.plugin.saveSettings()}));let e=new b.Setting(r).setName("OAuth\u6388\u6743").setDesc("\u70B9\u51FB\u5F00\u59CB\u6388\u6743\u4EE5\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C"),s=e.descEl.createEl("div");s.style.marginTop="8px",this.updateAuthStatus(s),e.addButton(i=>{i.setButtonText("\u5F00\u59CB\u6388\u6743").setTooltip("\u6253\u5F00\u6D4F\u89C8\u5668\u8FDB\u884COAuth\u6388\u6743").onClick(async()=>{await this.startOAuthFlow()})});let a=new b.Setting(r).setName("\u6388\u6743\u7801").setDesc("\u6388\u6743\u540E\u4F1A\u8DF3\u8F6C\u5230 localhost:8080/callback?code=xxx\uFF0C\u4ECEURL\u4E2D\u590D\u5236code\u53C2\u6570\u7684\u503C"),n=a.descEl.createEl("div");n.innerHTML=`
            <br/><strong>\u{1F4CB} \u64CD\u4F5C\u6B65\u9AA4\uFF1A</strong>
            <ol style="margin: 8px 0 8px 20px;">
                <li>\u70B9\u51FB"\u5F00\u59CB\u6388\u6743"\u6309\u94AE</li>
                <li>\u5728\u6D4F\u89C8\u5668\u4E2D\u5B8C\u6210\u767B\u5F55\u6388\u6743</li>
                <li>\u6388\u6743\u540E\u4F1A\u8DF3\u8F6C\u5230\u7C7B\u4F3C\u8FD9\u6837\u7684\u5730\u5740\uFF1A<br/>
                    <code style="background: #f5f5f5; padding: 2px 4px;">http://localhost:8080/callback?code=<span style="color: red;">\u4F60\u7684\u6388\u6743\u7801</span></code>
                </li>
                <li>\u590D\u5236\u7EA2\u8272\u90E8\u5206\u7684\u6388\u6743\u7801\uFF0C\u7C98\u8D34\u5230\u4E0B\u9762\u7684\u8F93\u5165\u6846</li>
                <li>\u63D2\u4EF6\u4F1A\u81EA\u52A8\u5B8C\u6210\u4EE4\u724C\u4EA4\u6362</li>
            </ol>
        `,n.style.backgroundColor="#fff3cd",n.style.padding="10px",n.style.borderRadius="5px",n.style.marginTop="8px",a.addText(i=>i.setPlaceholder("\u7C98\u8D34\u6388\u6743\u7801").setValue("").onChange(async o=>{o&&o!==this.plugin.settings.oauth.authCode&&(this.plugin.settings.oauth.authCode=o,await this.handleAuthCode(o))})),new b.Setting(r).setName("\u6E05\u9664\u8BA4\u8BC1\u4FE1\u606F").setDesc("\u6E05\u9664\u6240\u6709\u4FDD\u5B58\u7684OAuth\u4EE4\u724C\u548C\u8BA4\u8BC1\u4FE1\u606F").addButton(i=>{i.setButtonText("\u6E05\u9664\u8BA4\u8BC1").setWarning().onClick(async()=>{await this.clearAuth(),this.display()})})}addSyncSettings(r){r.createEl("h3",{text:"\u540C\u6B65\u8BBE\u7F6E"}),new b.Setting(r).setName("\u81EA\u52A8\u540C\u6B65").setDesc("\u542F\u7528\u81EA\u52A8\u540C\u6B65\u529F\u80FD").addToggle(t=>t.setValue(this.plugin.settings.autoSync).onChange(async e=>{this.plugin.settings.autoSync=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u540C\u6B65\u95F4\u9694").setDesc("\u81EA\u52A8\u540C\u6B65\u7684\u65F6\u95F4\u95F4\u9694\uFF08\u5206\u949F\uFF09").addSlider(t=>t.setLimits(5,120,5).setValue(this.plugin.settings.syncInterval).setDynamicTooltip().onChange(async e=>{this.plugin.settings.syncInterval=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u4FDD\u7559\u624B\u52A8\u4FEE\u6539").setDesc("\u540C\u6B65\u65F6\u4FDD\u7559\u7B14\u8BB0\u4E2D\u7684\u624B\u52A8\u4FEE\u6539\u5185\u5BB9").addToggle(t=>t.setValue(this.plugin.settings.preserveManualChanges).onChange(async e=>{this.plugin.settings.preserveManualChanges=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u5305\u542B\u751F\u65E5\u63D0\u9192").setDesc('\u662F\u5426\u5728\u4EFB\u52A1\u5217\u8868\u4E2D\u5305\u542B"\u{1F382}\u751F\u65E5\u63D0\u9192"\u9879\u76EE\u7684\u4EFB\u52A1\uFF08\u9ED8\u8BA4\u4E0D\u5305\u542B\uFF0C\u4E0E\u6EF4\u7B54\u6E05\u5355\u5B98\u65B9\u884C\u4E3A\u4E00\u81F4\uFF09').addToggle(t=>t.setValue(this.plugin.settings.includeBirthdayReminders).onChange(async e=>{this.plugin.settings.includeBirthdayReminders=e,await this.plugin.saveSettings(),new b.Notice(e?"\u2705 \u5DF2\u542F\u7528\u751F\u65E5\u63D0\u9192\u4EFB\u52A1\u663E\u793A":"\u2705 \u5DF2\u7981\u7528\u751F\u65E5\u63D0\u9192\u4EFB\u52A1\u663E\u793A\uFF0C\u5237\u65B0\u540E\u751F\u6548")}))}addFormatSettings(r){r.createEl("h3",{text:"\u683C\u5F0F\u8BBE\u7F6E"}),new b.Setting(r).setName("\u4EFB\u52A1\u683C\u5F0F").setDesc("\u9009\u62E9\u4EFB\u52A1\u663E\u793A\u683C\u5F0F").addDropdown(t=>t.addOptions({standard:"\u6807\u51C6\u683C\u5F0F",detailed:"\u8BE6\u7EC6\u683C\u5F0F",minimal:"\u7CBE\u7B80\u683C\u5F0F"}).setValue(this.plugin.settings.taskFormat).onChange(async e=>{this.plugin.settings.taskFormat=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u663E\u793A\u4F18\u5148\u7EA7").setDesc("\u5728\u4EFB\u52A1\u524D\u663E\u793A\u4F18\u5148\u7EA7\u56FE\u6807").addToggle(t=>t.setValue(this.plugin.settings.showPriority).onChange(async e=>{this.plugin.settings.showPriority=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u663E\u793A\u6807\u7B7E").setDesc("\u663E\u793A\u4EFB\u52A1\u6807\u7B7E").addToggle(t=>t.setValue(this.plugin.settings.showTags).onChange(async e=>{this.plugin.settings.showTags=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u663E\u793A\u5B50\u4EFB\u52A1").setDesc("\u663E\u793A\u4EFB\u52A1\u7684\u5B50\u4EFB\u52A1").addToggle(t=>t.setValue(this.plugin.settings.showSubtasks).onChange(async e=>{this.plugin.settings.showSubtasks=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u663E\u793A\u9644\u4EF6").setDesc("\u663E\u793A\u4EFB\u52A1\u9644\u4EF6").addToggle(t=>t.setValue(this.plugin.settings.showAttachments).onChange(async e=>{this.plugin.settings.showAttachments=e,await this.plugin.saveSettings()}))}addAdvancedSettings(r){r.createEl("h3",{text:"\u9AD8\u7EA7\u8BBE\u7F6E"}),new b.Setting(r).setName("\u8C03\u8BD5\u6A21\u5F0F").setDesc("\u542F\u7528\u8BE6\u7EC6\u7684\u8C03\u8BD5\u65E5\u5FD7\u8F93\u51FA").addToggle(t=>t.setValue(this.plugin.settings.debugMode).onChange(async e=>{this.plugin.settings.debugMode=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u7F51\u7EDC\u8D85\u65F6").setDesc("API\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4\uFF08\u79D2\uFF09").addSlider(t=>t.setLimits(10,120,5).setValue(this.plugin.settings.networkTimeout).setDynamicTooltip().onChange(async e=>{this.plugin.settings.networkTimeout=e,await this.plugin.saveSettings()})),new b.Setting(r).setName("\u6700\u5927\u91CD\u8BD5\u6B21\u6570").setDesc("API\u8BF7\u6C42\u5931\u8D25\u65F6\u7684\u91CD\u8BD5\u6B21\u6570").addSlider(t=>t.setLimits(1,10,1).setValue(this.plugin.settings.maxRetries).setDynamicTooltip().onChange(async e=>{this.plugin.settings.maxRetries=e,await this.plugin.saveSettings()}))}updateAuthStatus(r){let e=this.plugin.apiClient.getAuthClient().isTokenValid(),s=!!this.plugin.settings.oauth.accessToken;if(r.empty(),e?r.createEl("span",{text:"\u2705 \u5DF2\u8BA4\u8BC1\uFF0C\u4EE4\u724C\u6709\u6548",attr:{style:"color: green; font-weight: bold;"}}):s?r.createEl("span",{text:"\u26A0\uFE0F \u4EE4\u724C\u5DF2\u8FC7\u671F\uFF0C\u9700\u8981\u91CD\u65B0\u6388\u6743",attr:{style:"color: orange; font-weight: bold;"}}):r.createEl("span",{text:"\u274C \u672A\u8BA4\u8BC1",attr:{style:"color: red; font-weight: bold;"}}),s){let a=new Date(this.plugin.settings.oauth.tokenExpiry);r.createEl("br"),r.createEl("small",{text:`\u4EE4\u724C\u8FC7\u671F\u65F6\u95F4: ${a.toLocaleString()}`})}}async startOAuthFlow(){try{await this.plugin.apiClient.getAuthClient().startOAuthFlow()}catch(r){new b.Notice(`\u542F\u52A8OAuth\u6388\u6743\u5931\u8D25: ${r.message}`)}}async handleAuthCode(r){try{await this.plugin.apiClient.getAuthClient().exchangeCodeForToken(r),new b.Notice("\u2705 OAuth\u8BA4\u8BC1\u6210\u529F\uFF01"),this.plugin.settings.oauth.authCode="",await this.plugin.saveSettings(),this.display()}catch(t){let e=`OAuth\u8BA4\u8BC1\u5931\u8D25: ${t.message}`;t instanceof Error&&(t.message.includes("invalid_client")?e+=`

\u{1F4A1} \u5EFA\u8BAE\uFF1A
\u2022 \u68C0\u67E5Client ID\u548CSecret\u662F\u5426\u6B63\u786E
\u2022 \u786E\u8BA4\u5F00\u53D1\u8005\u4E2D\u5FC3\u7684\u56DE\u8C03\u5730\u5740\u8BBE\u4E3A: http://localhost:8080/callback`:t.message.includes("invalid_grant")&&(e+=`

\u{1F4A1} \u5EFA\u8BAE\uFF1A
\u2022 \u6388\u6743\u7801\u53EF\u80FD\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u83B7\u53D6
\u2022 \u786E\u4FDD\u6388\u6743\u7801\u5B8C\u6574\u590D\u5236\uFF0C\u6CA1\u6709\u591A\u4F59\u7A7A\u683C`)),new b.Notice(e,8e3),console.error("OAuth\u8BA4\u8BC1\u9519\u8BEF:",t)}}async clearAuth(){try{await this.plugin.apiClient.getAuthClient().clearAuth(),new b.Notice("\u8BA4\u8BC1\u4FE1\u606F\u5DF2\u6E05\u9664")}catch(r){new b.Notice(`\u6E05\u9664\u8BA4\u8BC1\u4FE1\u606F\u5931\u8D25: ${r.message}`)}}};var B=require("obsidian");var gt=require("obsidian"),Z=class{constructor(r){this.baseUrl="https://dida365.com";this.apiUrl="https://api.dida365.com";this.plugin=r}async startOAuthFlow(){let r=this.plugin.settings.oauth;if(!r.clientId){new gt.Notice("\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6EOAuth Client ID");return}let t=new URLSearchParams({scope:"tasks:read tasks:write",client_id:r.clientId,state:this.generateState(),redirect_uri:r.redirectUri,response_type:"code"}),e=`${this.baseUrl}/oauth/authorize?${t.toString()}`;this.plugin.settings.debugMode&&console.log("OAuth\u6388\u6743URL:",e),window.open(e,"_blank"),new gt.Notice("\u8BF7\u5728\u65B0\u7A97\u53E3\u4E2D\u5B8C\u6210\u6388\u6743\uFF0C\u7136\u540E\u5C06\u6388\u6743\u7801\u7C98\u8D34\u5230\u8BBE\u7F6E\u4E2D")}async exchangeCodeForToken(r){let t=this.plugin.settings.oauth;if(!t.clientId||!t.clientSecret)throw new Error("OAuth\u914D\u7F6E\u4E0D\u5B8C\u6574\uFF0C\u8BF7\u68C0\u67E5Client ID\u548CClient Secret");let e=new URLSearchParams({grant_type:"authorization_code",code:r,redirect_uri:t.redirectUri,scope:"tasks:read tasks:write"}),s=btoa(`${t.clientId}:${t.clientSecret}`);try{let a=await fetch(`${this.baseUrl}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${s}`},body:e.toString()});if(!a.ok){let i=await a.text();throw new Error(`Token exchange failed: ${a.status} - ${i}`)}let n=await a.json();return this.plugin.settings.debugMode&&console.log("\u83B7\u53D6\u5230\u8BBF\u95EE\u4EE4\u724C:",n),this.plugin.settings.oauth.accessToken=n.access_token,this.plugin.settings.oauth.refreshToken=n.refresh_token||"",this.plugin.settings.oauth.tokenExpiry=Date.now()+n.expires_in*1e3,await this.plugin.saveSettings(),n}catch(a){throw this.plugin.settings.debugMode&&console.error("Token exchange error:",a),new Error(`\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25: ${a.message}`)}}async refreshToken(){let r=this.plugin.settings.oauth;if(!r.refreshToken)throw new Error("\u6CA1\u6709\u5237\u65B0\u4EE4\u724C\uFF0C\u9700\u8981\u91CD\u65B0\u6388\u6743");let t=new URLSearchParams({grant_type:"refresh_token",refresh_token:r.refreshToken}),e=btoa(`${r.clientId}:${r.clientSecret}`);try{let s=await fetch(`${this.baseUrl}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${e}`},body:t.toString()});if(!s.ok){let n=await s.text();throw new Error(`Token refresh failed: ${s.status} - ${n}`)}let a=await s.json();return this.plugin.settings.oauth.accessToken=a.access_token,a.refresh_token&&(this.plugin.settings.oauth.refreshToken=a.refresh_token),this.plugin.settings.oauth.tokenExpiry=Date.now()+a.expires_in*1e3,await this.plugin.saveSettings(),a}catch(s){throw this.plugin.settings.debugMode&&console.error("Token refresh error:",s),new Error(`\u5237\u65B0\u4EE4\u724C\u5931\u8D25: ${s.message}`)}}isTokenValid(){let r=this.plugin.settings.oauth;return!!(r.accessToken&&r.tokenExpiry&&r.tokenExpiry>Date.now())}isAuthenticated(){return this.isTokenValid()}async getValidAccessToken(){let r=this.plugin.settings.oauth;if(!r.accessToken)throw new Error("\u6CA1\u6709\u8BBF\u95EE\u4EE4\u724C\uFF0C\u9700\u8981\u5148\u8FDB\u884COAuth\u6388\u6743");if(this.isTokenValid())return r.accessToken;if(r.refreshToken)try{return(await this.refreshToken()).access_token}catch(t){throw new Error("\u4EE4\u724C\u5DF2\u8FC7\u671F\u4E14\u5237\u65B0\u5931\u8D25\uFF0C\u9700\u8981\u91CD\u65B0\u6388\u6743")}throw new Error("\u4EE4\u724C\u5DF2\u8FC7\u671F\uFF0C\u9700\u8981\u91CD\u65B0\u6388\u6743")}generateState(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}async clearAuth(){this.plugin.settings.oauth.accessToken="",this.plugin.settings.oauth.refreshToken="",this.plugin.settings.oauth.tokenExpiry=0,await this.plugin.saveSettings()}};var tt=class{constructor(r){this.baseUrl="https://api.dida365.com/open/v1";this.inboxProjectInfo=null;this.plugin=r,this.oauthClient=new Z(r)}getAuthClient(){return this.oauthClient}getInboxProjectInfo(){return this.inboxProjectInfo}async getAuthHeaders(){return{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${await this.oauthClient.getValidAccessToken()}`}}async getUserInfo(){try{this.plugin.settings.debugMode&&console.log("\u{1F4CB} \u83B7\u53D6\u7528\u6237\u4FE1\u606F...");let r=await this.getAuthHeaders(),t=await(0,B.requestUrl)({url:`${this.baseUrl}/user`,method:"GET",headers:r,throw:!1});if(t.status!==200)throw console.error("\u274C \u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25:",t.status,t.text),new Error(`\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25: HTTP ${t.status}`);let e=t.json;return this.plugin.settings.debugMode&&console.log("\u2705 \u83B7\u53D6\u5230\u7528\u6237\u4FE1\u606F:",e),e}catch(r){throw this.plugin.settings.debugMode&&console.error("\u274C \u83B7\u53D6\u7528\u6237\u4FE1\u606F\u9519\u8BEF:",r),new Error(`\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25: ${r.message}`)}}async getProjects(){try{this.plugin.settings.debugMode&&console.log("\u{1F4C1} \u83B7\u53D6\u9879\u76EE\u5217\u8868...");let r=await this.getAuthHeaders(),t=await(0,B.requestUrl)({url:`${this.baseUrl}/project`,method:"GET",headers:r,throw:!1});if(t.status!==200)throw console.error("\u274C \u83B7\u53D6\u9879\u76EE\u5931\u8D25:",t.status,t.text),new Error(`\u83B7\u53D6\u9879\u76EE\u5931\u8D25: HTTP ${t.status}`);let e=t.json||[];return this.plugin.settings.debugMode&&console.log(`\u2705 \u83B7\u53D6\u5230 ${e.length} \u4E2A\u7528\u6237\u521B\u5EFA\u7684\u9879\u76EE`),e}catch(r){throw this.plugin.settings.debugMode&&console.error("\u274C \u83B7\u53D6\u9879\u76EE\u9519\u8BEF:",r),new Error(`\u83B7\u53D6\u9879\u76EE\u5931\u8D25: ${r.message}`)}}async getProjectData(r){var t;try{this.plugin.settings.debugMode&&console.log("\u{1F4CB} \u83B7\u53D6\u9879\u76EE\u6570\u636E:",r);let e=await this.getAuthHeaders(),s=await(0,B.requestUrl)({url:`${this.baseUrl}/project/${r}/data`,method:"GET",headers:e,throw:!1});if(s.status!==200)throw console.error("\u274C \u83B7\u53D6\u9879\u76EE\u6570\u636E\u5931\u8D25:",s.status,s.text),new Error(`\u83B7\u53D6\u9879\u76EE\u6570\u636E\u5931\u8D25: HTTP ${s.status}`);let a=s.json;return this.plugin.settings.debugMode&&console.log("\u2705 \u83B7\u53D6\u5230\u9879\u76EE\u6570\u636E\uFF0C\u4EFB\u52A1\u6570:",((t=a.tasks)==null?void 0:t.length)||0),a}catch(e){throw this.plugin.settings.debugMode&&console.error("\u274C \u83B7\u53D6\u9879\u76EE\u6570\u636E\u9519\u8BEF:",e),new Error(`\u83B7\u53D6\u9879\u76EE\u6570\u636E\u5931\u8D25: ${e.message}`)}}async getAllTasksIncludingInbox(){try{console.log("\u{1F4E5} \u5F00\u59CB\u52A0\u8F7D\u4EFB\u52A1\u6570\u636E...");let r=[],t=new Set,e=new Set,s=null,a=(i,o)=>{let c=0,l=0;return i.forEach(d=>{if(!d.id){console.warn("\u26A0\uFE0F \u53D1\u73B0\u6CA1\u6709ID\u7684\u4EFB\u52A1:",d.title);return}t.has(d.id)?(l++,console.warn(`\u26A0\uFE0F \u53D1\u73B0\u91CD\u590D\u4EFB\u52A1 "${d.title}" (ID: ${d.id})\uFF0C\u6765\u6E90: ${o}\uFF0C\u5DF2\u8DF3\u8FC7`)):(t.add(d.id),r.push(d),c++)}),{addedCount:c,duplicateCount:l}};console.log("\u{1F4E5} \u5C1D\u8BD5\u83B7\u53D6\u6536\u96C6\u7BB1\u4EFB\u52A1\uFF08\u4F7F\u7528\u7A7AprojectId\uFF09...");try{let i=await this.getProjectData("inbox"),o=i.tasks||[];if(o.length>0||i.id){s=i.id||"inbox";let c="\u6536\u96C6\u7BB1",l="#4A90FB";o.forEach(p=>{p.projectId=s,p.projectName=c,p.projectColor=l});let d=a(o,"\u6536\u96C6\u7BB1");e.add(s),console.log(`\u2705 \u6536\u96C6\u7BB1\u52A0\u8F7D\u4E86 ${o.length} \u4E2A\u4EFB\u52A1\uFF0C\u5B9E\u9645\u6DFB\u52A0 ${d.addedCount} \u4E2A\uFF0C\u91CD\u590D ${d.duplicateCount} \u4E2A (ID: ${s})`)}else console.log("\u2139\uFE0F \u6536\u96C6\u7BB1\u4E3A\u7A7A")}catch(i){console.warn("\u26A0\uFE0F \u65E0\u6CD5\u83B7\u53D6\u6536\u96C6\u7BB1\u4EFB\u52A1:",i),console.log("\u{1F4E5} \u5C1D\u8BD5\u4F7F\u7528\u66FF\u4EE3\u65B9\u6CD5\u83B7\u53D6\u6536\u96C6\u7BB1...");try{let o=await this.getProjectData(""),c=o.tasks||[];if(c.length>0||o.id){s=o.id||"inbox";let l="\u6536\u96C6\u7BB1",d="#4A90FB";c.forEach(u=>{u.projectId=s,u.projectName=l,u.projectColor=d});let p=a(c,"\u6536\u96C6\u7BB1(\u66FF\u4EE3\u65B9\u6CD5)");e.add(s),console.log(`\u2705 \u6536\u96C6\u7BB1\u52A0\u8F7D\u4E86 ${c.length} \u4E2A\u4EFB\u52A1\uFF0C\u5B9E\u9645\u6DFB\u52A0 ${p.addedCount} \u4E2A\uFF0C\u91CD\u590D ${p.duplicateCount} \u4E2A (ID: ${s})`)}}catch(o){console.warn("\u26A0\uFE0F \u66FF\u4EE3\u65B9\u6CD5\u4E5F\u5931\u8D25\uFF0C\u8DF3\u8FC7\u6536\u96C6\u7BB1")}}let n=await this.getProjects();console.log(`\u{1F4C1} \u83B7\u53D6\u5230 ${n.length} \u4E2A\u7528\u6237\u521B\u5EFA\u7684\u9879\u76EE:`),n.forEach((i,o)=>{console.log(`  [${o}] ${i.name} - ID: ${i.id}, sortOrder: ${i.sortOrder}, kind: ${i.kind||"\u65E0"}`)});for(let i of n){if(i.closed){console.log(`\u23ED\uFE0F \u8DF3\u8FC7\u5DF2\u5173\u95ED\u9879\u76EE: ${i.name}`);continue}if(e.has(i.id)){console.log(`\u23ED\uFE0F \u8DF3\u8FC7\u5DF2\u5904\u7406\u7684\u9879\u76EE: ${i.name} (ID: ${i.id})`);continue}try{console.log(`\u{1F4CB} \u52A0\u8F7D\u9879\u76EE "${i.name}" \u7684\u4EFB\u52A1...`);let c=(await this.getProjectData(i.id)).tasks||[];c.forEach(d=>{d.projectName=i.name,d.projectColor=i.color});let l=a(c,`\u9879\u76EE: ${i.name}`);e.add(i.id),console.log(`  \u2705 \u9879\u76EE "${i.name}" \u8FD4\u56DE\u4E86 ${c.length} \u4E2A\u4EFB\u52A1\uFF0C\u5B9E\u9645\u6DFB\u52A0 ${l.addedCount} \u4E2A\uFF0C\u91CD\u590D ${l.duplicateCount} \u4E2A`)}catch(o){console.warn(`\u26A0\uFE0F \u8DF3\u8FC7\u9879\u76EE ${i.name}:`,o)}}return console.log("\u{1F4CA} ===== \u4EFB\u52A1\u7EDF\u8BA1\u603B\u7ED3 ====="),console.log(`\u{1F4CA} \u552F\u4E00\u4EFB\u52A1\u603B\u6570: ${r.length} \u4E2A`),console.log(`\u{1F4CA} \u552F\u4E00\u4EFB\u52A1ID\u6570: ${t.size} \u4E2A`),console.log(`\u{1F4CA} \u5904\u7406\u7684\u9879\u76EE\u6570: ${e.size} \u4E2A`),s&&(this.inboxProjectInfo={id:s,name:"\u6536\u96C6\u7BB1",color:"#4A90FB",sortOrder:-999999999},console.log(`\u{1F4E5} \u5DF2\u4FDD\u5B58\u6536\u96C6\u7BB1\u9879\u76EE\u4FE1\u606F: ID=${s}`)),r}catch(r){throw this.plugin.settings.debugMode&&console.error("\u274C \u83B7\u53D6\u6240\u6709\u4EFB\u52A1\u9519\u8BEF:",r),new Error(`\u83B7\u53D6\u6240\u6709\u4EFB\u52A1\u5931\u8D25: ${r.message}`)}}async getTask(r,t){try{this.plugin.settings.debugMode&&console.log("\u{1F4DD} \u83B7\u53D6\u4EFB\u52A1:",t);let e=await this.getAuthHeaders(),s=await(0,B.requestUrl)({url:`${this.baseUrl}/project/${r}/task/${t}`,method:"GET",headers:e,throw:!1});if(s.status!==200)throw console.error("\u274C \u83B7\u53D6\u4EFB\u52A1\u5931\u8D25:",s.status,s.text),new Error(`\u83B7\u53D6\u4EFB\u52A1\u5931\u8D25: HTTP ${s.status}`);let a=s.json;return this.plugin.settings.debugMode&&console.log("\u2705 \u83B7\u53D6\u5230\u4EFB\u52A1:",a.title),a}catch(e){throw this.plugin.settings.debugMode&&console.error("\u274C \u83B7\u53D6\u4EFB\u52A1\u9519\u8BEF:",e),new Error(`\u83B7\u53D6\u4EFB\u52A1\u5931\u8D25: ${e.message}`)}}async getTasks(r){try{this.plugin.settings.debugMode&&console.log("\u6839\u636E\u914D\u7F6E\u83B7\u53D6\u4EFB\u52A1:",r);let t=await this.getAllTasksIncludingInbox();r.projectId&&(t=t.filter(s=>s.projectId===r.projectId)),this.plugin.settings.debugMode&&console.log("\u83B7\u53D6\u5230\u6240\u6709\u4EFB\u52A1:",t.length);let e=this.applyFilters(t,r);return this.plugin.settings.debugMode&&console.log("\u8FC7\u6EE4\u540E\u4EFB\u52A1\u6570\u91CF:",e.length),e}catch(t){throw this.plugin.settings.debugMode&&console.error("\u83B7\u53D6\u4EFB\u52A1\u9519\u8BEF:",t),new Error(`\u83B7\u53D6\u4EFB\u52A1\u5931\u8D25: ${t.message}`)}}applyFilters(r,t){let e=r;if(t.status&&t.status!=="all"&&(t.status==="completed"?e=e.filter(s=>s.status===2):t.status==="uncompleted"&&(e=e.filter(s=>s.status!==2))),t.tags&&t.tags.length>0&&(e=e.filter(s=>t.tags.some(a=>s.tags&&s.tags.includes(a)))),t.excludeTags&&t.excludeTags.length>0&&(e=e.filter(s=>!t.excludeTags.some(a=>s.tags&&s.tags.includes(a)))),t.taskId&&(e=e.filter(s=>s.id===t.taskId)),t.startDate){let s=new Date(t.startDate);e=e.filter(a=>a.startDate?new Date(a.startDate)>=s:!1)}return e}async createTask(r){try{this.plugin.settings.debugMode&&console.log("\u2795 \u521B\u5EFA\u4EFB\u52A1:",r.title);let t=await this.getAuthHeaders(),e=await(0,B.requestUrl)({url:`${this.baseUrl}/task`,method:"POST",headers:t,body:JSON.stringify(r),throw:!1});if(e.status!==200&&e.status!==201)throw console.error("\u274C \u521B\u5EFA\u4EFB\u52A1\u5931\u8D25:",e.status,e.text),new Error(`\u521B\u5EFA\u4EFB\u52A1\u5931\u8D25: HTTP ${e.status}`);let s=e.json;return this.plugin.settings.debugMode&&(console.log("\u2705 \u4EFB\u52A1\u521B\u5EFA\u6210\u529F:",s.title),s.projectId&&console.log("   \u9879\u76EEID:",s.projectId)),s}catch(t){throw this.plugin.settings.debugMode&&console.error("\u274C \u521B\u5EFA\u4EFB\u52A1\u9519\u8BEF:",t),new Error(`\u521B\u5EFA\u4EFB\u52A1\u5931\u8D25: ${t.message}`)}}async updateTask(r,t){var e;try{console.log("\u270F\uFE0F \u66F4\u65B0\u4EFB\u52A1:",r),console.log("\u{1F4DD} \u66F4\u65B0\u6570\u636E:",t);let s=await this.getAuthHeaders(),a=await(0,B.requestUrl)({url:`${this.baseUrl}/task/${r}`,method:"POST",headers:s,body:JSON.stringify(t),throw:!1});if(console.log("\u{1F4E1} API\u54CD\u5E94\u72B6\u6001:",a.status),console.log("\u{1F4E1} API\u54CD\u5E94\u5934:",a.headers),console.log("\u{1F4E1} API\u54CD\u5E94\u6587\u672C\u957F\u5EA6:",((e=a.text)==null?void 0:e.length)||0),a.text&&console.log("\u{1F4E1} API\u54CD\u5E94\u5185\u5BB9\u9884\u89C8:",a.text.substring(0,200)),a.status!==200)throw console.error("\u274C \u66F4\u65B0\u4EFB\u52A1\u5931\u8D25 - HTTP\u72B6\u6001\u7801:",a.status),console.error("\u274C \u54CD\u5E94\u5185\u5BB9:",a.text),new Error(`\u66F4\u65B0\u4EFB\u52A1\u5931\u8D25: HTTP ${a.status}`);if(!a.text||a.text.trim()===""){console.log("\u2705 API\u66F4\u65B0\u6210\u529F\uFF08\u8FD4\u56DE\u7A7A\u54CD\u5E94\uFF0C\u8FD9\u662F\u6B63\u5E38\u7684\uFF09"),console.log("\u{1F4DD} \u4F7F\u7528\u53D1\u9001\u7684\u66F4\u65B0\u6570\u636E\u6784\u9020\u8FD4\u56DE\u5BF9\u8C61");let i={id:r,...t};return console.log("\u2705 \u4EFB\u52A1\u66F4\u65B0\u6210\u529F\uFF08\u672C\u5730\u6784\u9020\uFF09:",i),i}let n;try{n=a.json,console.log("\u2705 JSON\u89E3\u6790\u6210\u529F:",n)}catch(i){throw console.error("\u274C JSON\u89E3\u6790\u5931\u8D25"),console.error("\u539F\u59CB\u54CD\u5E94\u6587\u672C:",a.text),new Error(`JSON\u89E3\u6790\u5931\u8D25: ${i.message}`)}return this.plugin.settings.debugMode&&console.log("\u2705 \u4EFB\u52A1\u66F4\u65B0\u6210\u529F\uFF0C\u5B8C\u6574\u54CD\u5E94:",n),n}catch(s){throw console.error("\u274C \u66F4\u65B0\u4EFB\u52A1\u9519\u8BEF:",s),console.error("\u9519\u8BEF\u5806\u6808:",s.stack),new Error(`\u66F4\u65B0\u4EFB\u52A1\u5931\u8D25: ${s.message}`)}}async deleteTask(r,t){try{this.plugin.settings.debugMode&&console.log("\u{1F5D1}\uFE0F \u5220\u9664\u4EFB\u52A1:",r);let e=await this.getAuthHeaders(),s=await(0,B.requestUrl)({url:`${this.baseUrl}/task/${r}`,method:"DELETE",headers:e,throw:!1});if(s.status!==200&&s.status!==204)throw console.error("\u274C \u5220\u9664\u4EFB\u52A1\u5931\u8D25:",s.status,s.text),new Error(`\u5220\u9664\u4EFB\u52A1\u5931\u8D25: HTTP ${s.status}`);this.plugin.settings.debugMode&&console.log("\u2705 \u4EFB\u52A1\u5220\u9664\u6210\u529F")}catch(e){throw this.plugin.settings.debugMode&&console.error("\u274C \u5220\u9664\u4EFB\u52A1\u9519\u8BEF:",e),new Error(`\u5220\u9664\u4EFB\u52A1\u5931\u8D25: ${e.message}`)}}};var et=class{async formatTasks(r,t){let e=[],s=r.filter(o=>o.status===2),a=r.filter(o=>o.status!==2);if(a.length>0){e.push(`## \u{1F4CB} \u5F85\u5B8C\u6210\u4EFB\u52A1
`);for(let o of a)e.push(await this.formatTask(o,t)),e.push("")}if(s.length>0){e.push(`## \u2705 \u5DF2\u5B8C\u6210\u4EFB\u52A1
`);for(let o of s)e.push(await this.formatTask(o,t)),e.push("")}let i=new Date().toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});return e.push("---"),e.push(`*\u6700\u540E\u540C\u6B65\u65F6\u95F4: ${i}*`),e.join(`
`)}async formatTask(r,t){let e=[],s=r.status===2?"[x]":"[ ]",a=t.settings.showPriority?this.formatPriority(r.priority):"";if(e.push(`- ${s} ${a}${r.title}`),r.content&&r.content.trim()){let i=r.content.trim().split(`
`);for(let o of i)e.push(`  > ${o}`)}let n=this.formatTimeInfo(r);if(n&&e.push(`  *${n}*`),t.settings.showTags&&r.tags&&r.tags.length>0){let i=r.tags.map(o=>`#${o}`).join(" ");e.push(`  ${i}`)}if(t.settings.showSubtasks&&r.items&&r.items.length>0){e.push("  **\u5B50\u4EFB\u52A1:**");for(let i of r.items){let o=i.status===2?"[x]":"[ ]";e.push(`    - ${o} ${i.title}`)}}if(t.settings.showAttachments&&r.attachments&&r.attachments.length>0){e.push("  **\u9644\u4EF6:**");for(let i of r.attachments)try{let o=await this.processAttachment(i,t);e.push(`    - ${o}`)}catch(o){t.settings.debugMode&&console.error("Failed to process attachment:",o),e.push(`    - [${i.name}](${i.url})`)}}return e.join(`
`)}formatPriority(r){switch(r){case 5:return"\u{1F534} ";case 3:return"\u{1F7E1} ";case 1:return"\u{1F535} ";default:return""}}formatTimeInfo(r){let t=[];if(r.startDate)try{let e=new Date(r.startDate);t.push(`\u5F00\u59CB: ${e.toLocaleDateString("zh-CN")}`)}catch(e){t.push(`\u5F00\u59CB: ${r.startDate}`)}if(r.dueDate)try{let e=new Date(r.dueDate),a=e<new Date&&r.status!==2,n=e.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),i=a?`\u26A0\uFE0F \u622A\u6B62: ${n}`:`\u622A\u6B62: ${n}`;t.push(i)}catch(e){t.push(`\u622A\u6B62: ${r.dueDate}`)}return t.join(" | ")}async processAttachment(r,t){try{let e="attachments/dida-sync",s=`${e}/${r.name}`,a=t.app.vault.getAbstractFileByPath(s);if(!a){await this.ensureFolder(t,e);let n=await t.didaClient.downloadAttachment(r);a=await t.app.vault.createBinary(s,n)}return`[[${s}|${r.name}]]`}catch(e){return t.settings.debugMode&&console.error("Failed to process attachment:",e),`[${r.name}](${r.url})`}}async ensureFolder(r,t){r.app.vault.getAbstractFileByPath(t)||await r.app.vault.createFolder(t)}parseExistingContent(r){let t="## \u{1F4CB} \u5F85\u5B8C\u6210\u4EFB\u52A1",e="*\u6700\u540E\u540C\u6B65\u65F6\u95F4:",s=r.indexOf(t);if(s===-1&&r.indexOf("## \u2705 \u5DF2\u5B8C\u6210\u4EFB\u52A1")===-1)return{beforeSync:r,afterSync:"",syncMarkers:null};let a=r.lastIndexOf(e);if(a===-1)return{beforeSync:r,afterSync:"",syncMarkers:null};let n=r.indexOf(`
`,a+e.length),i=n===-1?r.length:n+1,o=s!==-1?s:r.indexOf("## \u2705 \u5DF2\u5B8C\u6210\u4EFB\u52A1");return{beforeSync:r.substring(0,o).trim(),afterSync:r.substring(i).trim(),syncMarkers:{start:o,end:i}}}};var st=class{async parse(r){let t=window.app;try{let e=t.metadataCache.getFileCache(r);if(e!=null&&e.frontmatter)return e.frontmatter}catch(e){console.warn("Failed to use official frontmatter API:",e)}try{let e=await t.vault.read(r);return this.parseFrontmatterManually(e)}catch(e){return console.error("Failed to read file:",e),{}}}parseFrontmatterManually(r){let t=/^---\s*\n(.*?)\n---\s*\n/s,e=r.match(t);if(!e)return{};try{let a=e[1].split(`
`),n={};for(let i of a){let o=i.trim();if(!o||o.startsWith("#"))continue;let c=o.indexOf(":");if(c===-1)continue;let l=o.substring(0,c).trim(),d=o.substring(c+1).trim();if(d.startsWith("[")&&d.endsWith("]")){let p=d.slice(1,-1);p.trim()?n[l]=p.split(",").map(u=>u.trim().replace(/^["']|["']$/g,"")):n[l]=[]}else d==="true"||d==="false"?n[l]=d==="true":!isNaN(Number(d))&&d!==""?n[l]=Number(d):n[l]=d.replace(/^["']|["']$/g,"")}return n}catch(s){return console.error("Failed to parse frontmatter:",s),{}}}extractSyncConfig(r){let t=(r==null?void 0:r.dida)||(r==null?void 0:r.ticktick);if(!t)return null;let e={};if(t.tags&&(e.tags=Array.isArray(t.tags)?t.tags:[t.tags]),t.excludeTags&&(e.excludeTags=Array.isArray(t.excludeTags)?t.excludeTags:[t.excludeTags]),t.projectId&&(e.projectId=String(t.projectId)),t.startDate&&(e.startDate=String(t.startDate)),t.status){let s=String(t.status).toLowerCase();["completed","uncompleted","all"].includes(s)?e.status=s:e.status="all"}else e.status="all";return t.taskId&&(e.taskId=String(t.taskId)),e}async updateFrontmatter(r,t){let e=window.app,s=await e.vault.read(r),a=/^---\s*\n(.*?)\n---\s*\n/s;if(!s.match(a)){let p=`---
${this.serializeFrontmatter(t)}
---

${s}`;await e.vault.modify(r,p);return}let o={...this.parseFrontmatterManually(s),...t},c=this.serializeFrontmatter(o),l=s.replace(a,`---
${c}
---
`);await e.vault.modify(r,l)}serializeFrontmatter(r){let t=[];for(let[e,s]of Object.entries(r))Array.isArray(s)?s.length===0?t.push(`${e}: []`):t.push(`${e}: [${s.map(a=>`"${a}"`).join(", ")}]`):typeof s=="string"?t.push(`${e}: "${s}"`):t.push(`${e}: ${s}`);return t.join(`
`)}};var bt=require("obsidian"),rt=class extends bt.Modal{constructor(r){super(r)}onOpen(){let{contentEl:r}=this;r.empty(),r.addClass("dida-sync-modal"),r.createEl("h2",{text:"\u6EF4\u7B54\u6E05\u5355\u540C\u6B65"}),this.statusEl=r.createEl("p",{text:"\u6B63\u5728\u51C6\u5907\u540C\u6B65...",cls:"sync-status"});let t=r.createEl("div",{cls:"progress-container"});this.progressEl=t.createEl("div",{cls:"progress-bar"});let e=r.createEl("style");e.textContent=`
            .dida-sync-modal {
                padding: 20px;
                text-align: center;
                min-width: 300px;
            }

            .sync-status {
                margin: 20px 0;
                font-size: 16px;
                color: var(--text-muted);
            }

            .progress-container {
                width: 100%;
                height: 8px;
                background-color: var(--background-secondary);
                border-radius: 4px;
                overflow: hidden;
                margin: 20px 0;
            }

            .progress-bar {
                height: 100%;
                background-color: var(--interactive-accent);
                transition: width 0.3s ease;
                width: 0%;
            }

            @keyframes pulse {
                0% { width: 0%; }
                50% { width: 100%; }
                100% { width: 0%; }
            }

            .progress-bar.indeterminate {
                animation: pulse 2s infinite;
            }
        `,this.progressEl.addClass("indeterminate")}onClose(){let{contentEl:r}=this;r.empty()}updateStatus(r){this.statusEl&&(this.statusEl.textContent=r)}updateProgress(r){this.progressEl&&(this.progressEl.removeClass("indeterminate"),this.progressEl.style.width=`${Math.min(100,Math.max(0,r))}%`)}};var vt={oauth:{clientId:"",clientSecret:"",redirectUri:"http://localhost:8080/callback",accessToken:"",refreshToken:"",tokenExpiry:0,authCode:""},authToken:"",csrfToken:"",username:"",password:"",rememberPassword:!1,autoSync:!1,syncInterval:15,preserveManualChanges:!0,includeBirthdayReminders:!1,bidirectionalSync:{enabled:!1,didaToMarkdown:!1,markdownToDida:!0,autoSync:!1,conflictResolution:"manual"},taskFormat:"standard",showPriority:!0,showTags:!0,showSubtasks:!0,showAttachments:!0,debugMode:!0,networkTimeout:30,maxRetries:3,apiBaseUrl:"https://api.dida365.com",userAgent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",viewSettings:{lastGroupBy:"time",groupTabOrder:{time:[],project:[],status:[],priority:[],tag:[]}}};var xt=require("obsidian");var M=require("obsidian"),at=class extends M.Modal{constructor(r,t,e){super(r.app),this.plugin=r,this.task=t,this.onTaskUpdate=e}onOpen(){let{contentEl:r}=this;r.empty(),r.addClass("task-detail-modal");let t=r.createEl("div",{cls:"task-detail-header"}),e=t.createEl("h2",{text:this.task.title,cls:"task-detail-title"}),s=t.createEl("button",{cls:"task-detail-close",attr:{"aria-label":"\u5173\u95ED"}});s.innerHTML="\u2715",s.addEventListener("click",()=>this.close());let a=r.createEl("div",{cls:"task-status-section"});this.createStatusSection(a);let n=r.createEl("div",{cls:"task-details-section"});this.createDetailsSection(n);let i=r.createEl("div",{cls:"task-tags-section"});if(this.createTagsSection(i),this.task.items&&this.task.items.length>0){let c=r.createEl("div",{cls:"task-subtasks-section"});this.createSubtasksSection(c)}let o=r.createEl("div",{cls:"task-actions-section"});this.createActionsSection(o)}createStatusSection(r){let t=r.createEl("div",{cls:"status-row"}),e=t.createEl("label",{cls:"status-toggle"}),s=e.createEl("input",{type:"checkbox",cls:"status-checkbox"});s.checked=this.task.status===2;let a=e.createEl("span",{text:this.task.status===2?"\u5DF2\u5B8C\u6210":"\u5F85\u5B8C\u6210",cls:"status-label"});if(s.addEventListener("change",async()=>{await this.toggleTaskStatus(s.checked)}),this.task.priority>0){let n=t.createEl("div",{cls:"priority-indicator"}),i=this.getPriorityInfo(this.task.priority);n.innerHTML=`${i.icon} ${i.text}`}if(this.task.dueDate){let n=t.createEl("div",{cls:"due-date-indicator"}),i=new Date(this.task.dueDate),o=this.formatDetailDate(i),c=i<new Date&&this.task.status!==2;n.innerHTML=`\u{1F4C5} ${o}`,c&&n.addClass("overdue")}}createDetailsSection(r){let t=r.createEl("h3",{text:"\u4EFB\u52A1\u8BE6\u60C5",cls:"section-title"});if(this.task.content){let e=r.createEl("div",{cls:"task-content"}),s=e.createEl("div",{text:"\u63CF\u8FF0\uFF1A",cls:"detail-label"}),a=e.createEl("div",{text:this.task.content,cls:"detail-text"})}if(this.task.createdTime){let e=r.createEl("div",{cls:"task-created"}),s=new Date(this.task.createdTime);e.innerHTML=`<span class="detail-label">\u521B\u5EFA\u65F6\u95F4\uFF1A</span><span class="detail-text">${s.toLocaleString()}</span>`}if(this.task.modifiedTime){let e=r.createEl("div",{cls:"task-modified"}),s=new Date(this.task.modifiedTime);e.innerHTML=`<span class="detail-label">\u4FEE\u6539\u65F6\u95F4\uFF1A</span><span class="detail-text">${s.toLocaleString()}</span>`}if(this.task.projectName){let e=r.createEl("div",{cls:"task-project"});e.innerHTML=`<span class="detail-label">\u6240\u5C5E\u9879\u76EE\uFF1A</span><span class="detail-text">${this.task.projectName}</span>`}}createTagsSection(r){if(!this.task.tags||this.task.tags.length===0)return;let t=r.createEl("h3",{text:"\u6807\u7B7E",cls:"section-title"}),e=r.createEl("div",{cls:"tags-container"});this.task.tags.forEach(s=>{let a=e.createEl("span",{text:`#${s}`,cls:"tag-item"})})}createSubtasksSection(r){let t=r.createEl("h3",{text:"\u5B50\u4EFB\u52A1",cls:"section-title"}),e=r.createEl("div",{cls:"subtasks-container"});this.task.items.forEach((s,a)=>{let n=e.createEl("div",{cls:"subtask-item"}),i=n.createEl("input",{type:"checkbox",cls:"subtask-checkbox"});i.checked=s.status===2;let o=n.createEl("span",{text:s.title,cls:s.status===2?"subtask-title completed":"subtask-title"});i.addEventListener("change",async()=>{await this.toggleSubtaskStatus(a,i.checked)})})}createActionsSection(r){let t=r.createEl("div",{cls:"actions-container"}),e=t.createEl("button",{text:"\u7F16\u8F91\u4EFB\u52A1",cls:"action-btn edit-btn"}),s=t.createEl("button",{text:"\u5220\u9664\u4EFB\u52A1",cls:"action-btn delete-btn"}),a=t.createEl("button",{text:"\u5728\u6EF4\u7B54\u6E05\u5355\u4E2D\u6253\u5F00",cls:"action-btn open-btn"});e.addEventListener("click",()=>{this.startEditMode()}),s.addEventListener("click",()=>{this.confirmDeleteTask()}),a.addEventListener("click",()=>{this.openInDidaApp()})}async toggleTaskStatus(r){try{await this.plugin.apiClient.updateTask(this.task.id,{status:r?2:0}),this.task.status=r?2:0;let t=this.contentEl.querySelector(".status-label");t&&(t.textContent=r?"\u5DF2\u5B8C\u6210":"\u5F85\u5B8C\u6210"),this.onTaskUpdate&&this.onTaskUpdate(this.task),new M.Notice(r?"\u4EFB\u52A1\u5DF2\u5B8C\u6210":"\u4EFB\u52A1\u5DF2\u6807\u8BB0\u4E3A\u672A\u5B8C\u6210")}catch(t){console.error("\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u5931\u8D25:",t),new M.Notice("\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u5931\u8D25");let e=this.contentEl.querySelector(".status-checkbox");e&&(e.checked=!r)}}async toggleSubtaskStatus(r,t){try{this.task.items[r].status=t?2:0;let e=this.contentEl.querySelectorAll(".subtask-title")[r];e&&(t?e.addClass("completed"):e.removeClass("completed")),new M.Notice(t?"\u5B50\u4EFB\u52A1\u5DF2\u5B8C\u6210":"\u5B50\u4EFB\u52A1\u5DF2\u6807\u8BB0\u4E3A\u672A\u5B8C\u6210")}catch(e){console.error("\u66F4\u65B0\u5B50\u4EFB\u52A1\u72B6\u6001\u5931\u8D25:",e),new M.Notice("\u66F4\u65B0\u5B50\u4EFB\u52A1\u72B6\u6001\u5931\u8D25")}}startEditMode(){let r=this.contentEl.querySelector(".task-detail-title");if(!r)return;let t=r.textContent||"",e=this.contentEl.createEl("input",{type:"text",value:t,cls:"title-edit-input"});r.replaceWith(e),e.select();let s=async()=>{let a=e.value.trim();if(a&&a!==t)try{await this.plugin.apiClient.updateTask(this.task.id,{title:a}),this.task.title=a;let n=this.contentEl.createEl("h2",{text:a,cls:"task-detail-title"});e.replaceWith(n),this.onTaskUpdate&&this.onTaskUpdate(this.task),new M.Notice("\u4EFB\u52A1\u6807\u9898\u5DF2\u66F4\u65B0")}catch(n){console.error("\u66F4\u65B0\u4EFB\u52A1\u6807\u9898\u5931\u8D25:",n),new M.Notice("\u66F4\u65B0\u4EFB\u52A1\u6807\u9898\u5931\u8D25")}else{let n=this.contentEl.createEl("h2",{text:t,cls:"task-detail-title"});e.replaceWith(n)}};e.addEventListener("keydown",a=>{if(a.key==="Enter")s();else if(a.key==="Escape"){let n=this.contentEl.createEl("h2",{text:t,cls:"task-detail-title"});e.replaceWith(n)}}),e.addEventListener("blur",s)}confirmDeleteTask(){confirm(`\u786E\u5B9A\u8981\u5220\u9664\u4EFB\u52A1"${this.task.title}"\u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`)&&this.deleteTask()}async deleteTask(){try{await this.plugin.apiClient.deleteTask(this.task.id),this.onTaskUpdate&&this.onTaskUpdate({...this.task,deleted:!0}),new M.Notice("\u4EFB\u52A1\u5DF2\u5220\u9664"),this.close()}catch(r){console.error("\u5220\u9664\u4EFB\u52A1\u5931\u8D25:",r),new M.Notice("\u5220\u9664\u4EFB\u52A1\u5931\u8D25")}}openInDidaApp(){let r=`https://dida365.com/tasks/${this.task.id}`;window.open(r,"_blank")}getPriorityInfo(r){switch(r){case 5:return{icon:"\u{1F534}",text:"\u9AD8\u4F18\u5148\u7EA7"};case 3:return{icon:"\u{1F7E1}",text:"\u4E2D\u4F18\u5148\u7EA7"};case 1:return{icon:"\u{1F535}",text:"\u4F4E\u4F18\u5148\u7EA7"};default:return{icon:"\u26AA",text:"\u65E0\u4F18\u5148\u7EA7"}}}formatDetailDate(r){let t=new Date,e=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(r.getFullYear(),r.getMonth(),r.getDate()).getTime()-e.getTime(),n=Math.ceil(a/(1e3*60*60*24));return n===0?"\u4ECA\u5929":n===1?"\u660E\u5929":n===-1?"\u6628\u5929":n>0?`${n}\u5929\u540E`:n<0?`${Math.abs(n)}\u5929\u524D`:r.toLocaleDateString("zh-CN")}onClose(){}};var ht=class h{constructor(){this.config=this.detectEnvironment()}static getInstance(){return h.instance||(h.instance=new h),h.instance}detectEnvironment(){let r=this.isObsidianDevMode(),t=!1,e=!1,s;return e?s="testing":r||t?s="development":s="production",this.getConfigForEnvironment(s)}isObsidianDevMode(){var r,t,e;try{if(typeof window!="undefined"&&window.require)return!0;if((e=(t=(r=globalThis.app)==null?void 0:r.vault)==null?void 0:t.adapter)!=null&&e.path){let s=globalThis.app.vault.adapter.path.toLowerCase();return s.includes("dev")||s.includes("test")||s.includes("debug")}return!1}catch(s){return!1}}getConfigForEnvironment(r){let t={environment:r,logLevel:1,enableDebug:!1,apiTimeout:1e4,retryAttempts:3,enableConsoleOutput:!1,enablePerformanceLogging:!1};switch(r){case"development":return{...t,logLevel:0,enableDebug:!0,apiTimeout:3e4,retryAttempts:1,enableConsoleOutput:!0,enablePerformanceLogging:!0};case"testing":return{...t,logLevel:2,enableDebug:!0,apiTimeout:5e3,retryAttempts:1,enableConsoleOutput:!1,enablePerformanceLogging:!1};case"production":default:return{...t,logLevel:2,enableDebug:!1,apiTimeout:1e4,retryAttempts:3,enableConsoleOutput:!1,enablePerformanceLogging:!1}}}getConfig(){return{...this.config}}getCurrentEnvironment(){return this.config.environment}isDevelopment(){return this.config.environment==="development"}isProduction(){return this.config.environment==="production"}isTesting(){return this.config.environment==="testing"}isDebugEnabled(){return this.config.enableDebug}getApiTimeout(){return this.config.apiTimeout}getRetryAttempts(){return this.config.retryAttempts}isConsoleOutputEnabled(){return this.config.enableConsoleOutput}isPerformanceLoggingEnabled(){return this.config.enablePerformanceLogging}forceEnvironment(r){this.config=this.getConfigForEnvironment(r)}updateConfig(r){this.config={...this.config,...r}}reset(){this.config=this.detectEnvironment()}},z=ht.getInstance();var mt=(a=>(a[a.DEBUG=0]="DEBUG",a[a.INFO=1]="INFO",a[a.WARN=2]="WARN",a[a.ERROR=3]="ERROR",a[a.NONE=4]="NONE",a))(mt||{}),ft=class h{constructor(){this.logLevel=1;this.logs=[];this.maxLogs=1e3;let r=z.getConfig();this.logLevel=r.logLevel}static getInstance(){return h.instance||(h.instance=new h),h.instance}setLogLevel(r){this.logLevel=r}setDevelopmentMode(r){this.logLevel=r?0:2}addLog(r,t,e,s){let a={timestamp:Date.now(),level:r,category:t,message:e,data:s};if(this.logs.push(a),this.logs.length>this.maxLogs&&this.logs.splice(0,this.logs.length-this.maxLogs),r>=this.logLevel&&z.isConsoleOutputEnabled()){let n=new Date().toISOString(),i=mt[r],o=`[${n}] [${i}] [${t}] ${e}`;switch(r){case 0:console.debug(o,s||"");break;case 1:console.info(o,s||"");break;case 2:console.warn(o,s||"");break;case 3:console.error(o,s||"");break}}}debug(r,t,e){this.addLog(0,r,t,e)}info(r,t,e){this.addLog(1,r,t,e)}warn(r,t,e){this.addLog(2,r,t,e)}error(r,t,e){this.addLog(3,r,t,e)}getLogs(r){return r!==void 0?this.logs.filter(t=>t.level>=r):[...this.logs]}clearLogs(){this.logs=[]}exportLogs(){return this.logs.map(r=>{let t=new Date(r.timestamp).toISOString(),e=mt[r.level],s=r.data?` | Data: ${JSON.stringify(r.data)}`:"";return`${t} [${e}] [${r.category}] ${r.message}${s}`}).join(`
`)}},G=ft.getInstance(),S={debug:(h,r,t)=>G.debug(h,r,t),info:(h,r,t)=>G.info(h,r,t),warn:(h,r,t)=>G.warn(h,r,t),error:(h,r,t)=>G.error(h,r,t)};var U="dida-task-view",nt=class extends xt.ItemView{constructor(t,e){super(t);this.allProjects=[];this.allTasks=[];this.currentProjectId="all";this.plugin=e}getViewType(){return U}getDisplayText(){return"\u6EF4\u7B54\u4EFB\u52A1"}getIcon(){return"list-checks"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("task-view-container");let e=t.createEl("div",{cls:"task-view-header"}),s=e.createEl("h3",{text:"\u6EF4\u7B54\u4EFB\u52A1\u7BA1\u7406",cls:"task-view-title"}),a=e.createEl("div",{cls:"header-buttons"}),n=a.createEl("button",{cls:"task-add-btn",attr:{"aria-label":"\u6DFB\u52A0\u65B0\u4EFB\u52A1",title:"\u6DFB\u52A0\u65B0\u4EFB\u52A1"}});n.innerHTML="\u2795";let i=a.createEl("button",{cls:"task-refresh-btn",attr:{"aria-label":"\u5237\u65B0\u4EFB\u52A1\u5217\u8868",title:"\u5237\u65B0\u4EFB\u52A1\u5217\u8868"}});i.innerHTML="\u{1F504}";let o=t.createEl("div",{cls:"project-tabs-wrapper"});this.projectTabsContainer=o.createEl("div",{cls:"project-tabs-container"});let c=t.createEl("div",{cls:"task-filters"}),l=c.createEl("input",{type:"text",cls:"search-input",attr:{placeholder:"\u641C\u7D22\u4EFB\u52A1..."}}),d=c.createEl("select",{cls:"status-filter"});d.createEl("option",{value:"all",text:"\u5168\u90E8\u4EFB\u52A1"}),d.createEl("option",{value:"active",text:"\u672A\u5B8C\u6210"}),d.createEl("option",{value:"completed",text:"\u5DF2\u5B8C\u6210"});let p=c.createEl("select",{cls:"project-filter"});p.createEl("option",{value:"all",text:"\u5168\u90E8\u9879\u76EE"}),n.addEventListener("click",()=>{this.showAddTaskForm()}),i.addEventListener("click",async()=>{await this.refreshTasks()}),l.addEventListener("input",()=>{this.filterTasks()}),d.addEventListener("change",()=>{this.filterTasks()}),p.addEventListener("change",()=>{this.switchProject(p.value)}),this.searchInput=l,this.statusFilter=d,this.projectFilter=p;try{await this.loadAndDisplayTasks()}catch(u){S.error("TaskView","\u52A0\u8F7D\u4EFB\u52A1\u5931\u8D25",u),t.createEl("p",{text:`\u52A0\u8F7D\u5931\u8D25: ${u.message}`,cls:"error-message"})}}async refreshTasks(){let t=this.containerEl.children[1],e=t.querySelector(".task-view-header"),s=t.querySelector(".project-tabs-wrapper");Array.from(t.children).forEach(o=>{!o.classList.contains("task-view-header")&&!o.classList.contains("project-tabs-wrapper")&&o.remove()});let n=t.createEl("div",{cls:"loading-message"}),i=n.createEl("div",{cls:"loading-spinner"});n.createEl("span",{text:"\u5237\u65B0\u4E2D..."});try{await this.loadAndDisplayTasks(),n.remove()}catch(o){S.error("TaskView","\u5237\u65B0\u4EFB\u52A1\u5931\u8D25",o),n.textContent=`\u5237\u65B0\u5931\u8D25: ${o.message}`,n.className="error-message"}}async onClose(){}async loadAndDisplayTasks(){let t=this.containerEl.children[1];this.showSkeletonLoader(t);try{let e=await this.plugin.apiClient.getProjects();this.allProjects=e,this.allTasks=[];for(let s of e)if(!s.closed)try{let n=(await this.plugin.apiClient.getProjectData(s.id)).tasks||[];n.forEach(i=>{i.projectId=s.id,i.projectName=s.name}),this.allTasks.push(...n)}catch(a){S.warn("TaskView",`\u8DF3\u8FC7\u9879\u76EE ${s.name}`,a)}this.removeSkeletonLoader(t),this.renderProjectTabs(),this.populateProjectFilter(),this.displayFilteredTasks()}catch(e){throw this.removeSkeletonLoader(t),e}}showSkeletonLoader(t){this.removeSkeletonLoader(t);let e=t.createEl("div",{cls:"skeleton-loader"});for(let s=0;s<3;s++){let a=e.createEl("div",{cls:"project-section"});a.createEl("div",{cls:"project-header"}).createEl("div",{cls:"skeleton-content medium"});let i=a.createEl("div",{cls:"task-list"});for(let o=0;o<3;o++){let c=i.createEl("div",{cls:"skeleton-item"});c.createEl("div",{cls:"skeleton-checkbox"});let l=c.createEl("div",{cls:"skeleton-wrapper"});if(l.style.cssText="flex: 1; display: flex; flex-direction: column; gap: 8px;",l.createEl("div",{cls:`skeleton-content ${o%3===0?"short":o%3===1?"medium":""}`}),o<2){let d=l.createEl("div",{cls:"skeleton-content short"});d.style.height="12px"}}}}removeSkeletonLoader(t){let e=t.querySelector(".skeleton-loader");e&&e.remove()}renderProjectTabs(){if(!this.projectTabsContainer){let a=this.containerEl.children[1].querySelector(".project-tabs-wrapper");a&&(this.projectTabsContainer=a.querySelector(".project-tabs-container"))}if(!this.projectTabsContainer)return;this.projectTabsContainer.empty();let t=this.projectTabsContainer.createEl("div",{cls:"project-tab",attr:{"data-project-id":"all"}});t.createEl("span",{text:"\u5168\u90E8\u9879\u76EE",cls:"project-tab-name"});let e=this.allTasks.filter(s=>!s.status).length;t.createEl("span",{text:String(e),cls:"project-tab-count"}),this.currentProjectId==="all"&&t.addClass("active"),t.addEventListener("click",()=>{this.switchProject("all")}),this.allProjects.forEach(s=>{if(!s.closed){let a=this.projectTabsContainer.createEl("div",{cls:"project-tab",attr:{"data-project-id":s.id}});a.createEl("span",{text:s.name,cls:"project-tab-name"});let n=this.allTasks.filter(i=>i.projectId===s.id&&!i.status).length;a.createEl("span",{text:String(n),cls:"project-tab-count"}),this.currentProjectId===s.id&&a.addClass("active"),a.addEventListener("click",()=>{this.switchProject(s.id)})}})}switchProject(t){this.currentProjectId=t,this.projectTabsContainer.querySelectorAll(".project-tab").forEach(s=>{s.getAttribute("data-project-id")===t?s.addClass("active"):s.removeClass("active")}),this.projectFilter.value=t,this.displayFilteredTasks()}populateProjectFilter(){let t=this.projectFilter.querySelectorAll("option");for(let e=1;e<t.length;e++)t[e].remove();this.allProjects.forEach(e=>{e.closed||this.projectFilter.createEl("option",{value:e.id,text:e.name})})}filterTasks(){this.displayFilteredTasks()}displayFilteredTasks(){var u,m,v,D;let t=this.containerEl.children[1],e=t.querySelector(".projects-container");e&&e.remove();let s=((m=(u=this.searchInput)==null?void 0:u.value)==null?void 0:m.toLowerCase())||"",a=((v=this.statusFilter)==null?void 0:v.value)||"all",n=this.currentProjectId||((D=this.projectFilter)==null?void 0:D.value)||"all",i=this.allTasks.filter(E=>!(s&&!E.title.toLowerCase().includes(s)||a==="active"&&E.status===2||a==="completed"&&E.status!==2||n!=="all"&&E.projectId!==n)),o=t.createEl("div",{cls:"projects-container horizontal-layout"}),c=o.createEl("div",{cls:"stats-info"}),l=i.length,d=i.filter(E=>E.status===2).length;if(c.createEl("span",{text:`${l} \u4E2A\u4EFB\u52A1\uFF0C${d} \u4E2A\u5DF2\u5B8C\u6210`}),l===0){o.createEl("p",{text:s?"\u6CA1\u6709\u627E\u5230\u5339\u914D\u7684\u4EFB\u52A1":"\u6682\u65E0\u4EFB\u52A1",cls:"no-tasks"});return}let p=this.groupTasksByProject(i);for(let[E,F]of Object.entries(p)){let C=this.allProjects.find(H=>H.id===E);C&&Array.isArray(F)&&this.displayProjectSection(o,C,F)}}groupTasksByProject(t){let e={};return t.forEach(s=>{e[s.projectId]||(e[s.projectId]=[]),e[s.projectId].push(s)}),e}displayProjectSection(t,e,s){let a=t.createEl("div",{cls:"project-section"}),n=a.createEl("div",{cls:"project-header"});n.createEl("h4",{text:e.name,cls:"project-name"}),n.createEl("span",{text:`(${s.length})`,cls:"task-count"});let i=a.createEl("div",{cls:"task-list"});s.forEach(o=>{this.createTaskItem(i,o)})}async displayProjectTasks(t,e){try{let s=t.createEl("div",{cls:"project-section"}),a=s.createEl("div",{cls:"project-header"});a.createEl("h4",{text:e.name,cls:"project-name"});let i=(await this.plugin.apiClient.getProjectData(e.id)).tasks||[];if(i.length===0){s.createEl("p",{text:"\u6682\u65E0\u4EFB\u52A1",cls:"no-tasks"});return}a.createEl("span",{text:`(${i.length})`,cls:"task-count"});let o=s.createEl("div",{cls:"task-list"});for(let c of i.slice(0,5))this.createTaskItem(o,c);i.length>5&&o.createEl("div",{text:`... \u8FD8\u6709 ${i.length-5} \u4E2A\u4EFB\u52A1`,cls:"more-tasks"})}catch(s){S.error("TaskView",`\u52A0\u8F7D\u9879\u76EE ${e.name} \u5931\u8D25`,s);let a=t.createEl("div",{cls:"project-error"});a.createEl("h4",{text:e.name}),a.createEl("p",{text:"\u52A0\u8F7D\u5931\u8D25",cls:"error-message"})}}createTaskItem(t,e){let s=t.createEl("div",{cls:"task-item",attr:{"data-task-id":e.id}}),a=s.createEl("div",{cls:"task-content"}),n=a.createEl("input",{type:"checkbox",cls:"task-checkbox"});n.checked=e.status===2;let i=a.createEl("div",{cls:"task-details"}),o=i.createEl("div",{text:e.title,cls:e.status===2?"task-title completed":"task-title"});if(o.addEventListener("dblclick",()=>{this.editTaskTitle(e,o)}),o.setAttribute("title","\u53CC\u51FB\u7F16\u8F91\u4EFB\u52A1\u6807\u9898"),e.priority>0||e.dueDate){let d=i.createEl("div",{cls:"task-meta"});if(e.priority>0){let p=this.getPriorityIcon(e.priority);d.createEl("span",{text:p,cls:"priority-icon"})}if(e.dueDate){let p=new Date(e.dueDate),u=this.formatDueDate(p),m=this.getDueDateClass(p);d.createEl("span",{text:u,cls:`due-date ${m}`})}}let l=a.createEl("div",{cls:"task-actions"}).createEl("button",{cls:"task-delete-btn",attr:{"aria-label":"\u5220\u9664\u4EFB\u52A1",title:"\u5220\u9664\u4EFB\u52A1"}});l.innerHTML="\u{1F5D1}\uFE0F",n.addEventListener("change",async()=>{await this.toggleTaskStatus(e,n.checked)}),l.addEventListener("click",d=>{d.stopPropagation(),this.confirmDeleteTask(e,s)}),s.addEventListener("mouseenter",()=>{l.style.opacity="1"}),s.addEventListener("mouseleave",()=>{l.style.opacity="0"}),s.addEventListener("click",d=>{d.target.closest(".task-checkbox, .task-delete-btn, .edit-buttons, .task-title-input")||this.openTaskDetailModal(e)})}openTaskDetailModal(t){new at(this.plugin,t,s=>{if(s.deleted){let a=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);a&&(a.style.transition="all 0.3s ease-out",a.style.opacity="0",a.style.transform="translateX(-100%)",setTimeout(()=>{a.remove(),this.updateTaskCounts()},300))}else{Object.assign(t,s);let a=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);if(a){let n=a.querySelector(".task-title"),i=a.querySelector(".task-checkbox");n&&(n.textContent=s.title,s.status===2?n.addClass("completed"):n.removeClass("completed")),i&&(i.checked=s.status===2)}}}).open()}confirmDeleteTask(t,e){let s=this.containerEl.createEl("div",{cls:"delete-confirm-overlay"}),a=s.createEl("div",{cls:"delete-confirm-dialog"});a.createEl("h4",{text:"\u786E\u8BA4\u5220\u9664\u4EFB\u52A1",cls:"confirm-title"}),a.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u4EFB\u52A1 "${t.title}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,cls:"confirm-message"});let n=a.createEl("div",{cls:"confirm-buttons"}),i=n.createEl("button",{text:"\u53D6\u6D88",cls:"confirm-cancel-btn"}),o=n.createEl("button",{text:"\u5220\u9664",cls:"confirm-delete-btn"});i.addEventListener("click",()=>{s.remove()}),o.addEventListener("click",async()=>{await this.handleDeleteTask(t,e,s)}),s.addEventListener("click",l=>{l.target===s&&s.remove()});let c=l=>{l.key==="Escape"&&(s.remove(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),setTimeout(()=>i.focus(),100)}async handleDeleteTask(t,e,s){try{let a=s.querySelector(".confirm-delete-btn"),n=a.textContent;a.textContent="\u5220\u9664\u4E2D...",a.setAttribute("disabled","true"),await this.plugin.apiClient.deleteTask(t.id),S.info("TaskView","\u4EFB\u52A1\u5220\u9664\u6210\u529F",{title:t.title}),s.remove(),e.style.transition="all 0.3s ease-out",e.style.opacity="0",e.style.transform="translateX(-100%)",setTimeout(()=>{e.remove(),this.updateTaskCounts()},300)}catch(a){S.error("TaskView","\u5220\u9664\u4EFB\u52A1\u5931\u8D25",a);let n=s.querySelector(".confirm-delete-btn");n.textContent="\u5220\u9664",n.removeAttribute("disabled");let i=s.querySelector(".delete-error-msg");i||(i=s.querySelector(".delete-confirm-dialog").createEl("div",{cls:"delete-error-msg"})),i.textContent=`\u5220\u9664\u5931\u8D25: ${a.message}`,setTimeout(()=>{i&&i.parentNode&&i.remove()},3e3)}}updateTaskCounts(){this.containerEl.querySelectorAll(".project-header").forEach(e=>{let s=e.parentElement;if(s){let a=s.querySelectorAll(".task-item"),n=e.querySelector(".task-count");if(n){let i=a.length;if(n.textContent=`(${i})`,i===0){let o=s.querySelector(".task-list");o&&(o.innerHTML="",o.createEl("p",{text:"\u6682\u65E0\u4EFB\u52A1",cls:"no-tasks"}))}}}})}editTaskTitle(t,e){if(e.querySelector(".task-title-input"))return;let s=t.title,a=e.className;e.innerHTML="",e.className="task-title-editing";let n=e.createEl("input",{type:"text",cls:"task-title-input",value:s}),i=e.createEl("div",{cls:"edit-buttons"}),o=i.createEl("button",{text:"\u4FDD\u5B58",cls:"edit-save-btn"}),c=i.createEl("button",{text:"\u53D6\u6D88",cls:"edit-cancel-btn"});n.select(),n.focus();let l=async()=>{let p=n.value.trim();if(!p){n.style.borderColor="var(--color-red)",n.focus();return}if(p===s){d();return}try{o.textContent="\u4FDD\u5B58\u4E2D...",o.setAttribute("disabled","true"),n.setAttribute("disabled","true"),await this.plugin.apiClient.updateTask(t.id,{title:p}),t.title=p,e.innerHTML=p,e.className=a,e.setAttribute("title","\u53CC\u51FB\u7F16\u8F91\u4EFB\u52A1\u6807\u9898"),S.info("TaskView","\u4EFB\u52A1\u6807\u9898\u66F4\u65B0\u6210\u529F",{oldTitle:t.title,newTitle:p})}catch(u){S.error("TaskView","\u66F4\u65B0\u4EFB\u52A1\u6807\u9898\u5931\u8D25",u),o.textContent="\u4FDD\u5B58",o.removeAttribute("disabled"),n.removeAttribute("disabled"),n.focus();let m=e.querySelector(".edit-error-msg");m||(m=i.createEl("div",{cls:"edit-error-msg"})),m.textContent=`\u4FDD\u5B58\u5931\u8D25: ${u.message}`,setTimeout(()=>{m&&m.parentNode&&m.remove()},3e3)}},d=()=>{e.innerHTML=s,e.className=a,e.setAttribute("title","\u53CC\u51FB\u7F16\u8F91\u4EFB\u52A1\u6807\u9898")};o.addEventListener("click",l),c.addEventListener("click",d),n.addEventListener("keydown",p=>{p.key==="Enter"?(p.preventDefault(),l()):p.key==="Escape"&&(p.preventDefault(),d())}),n.addEventListener("blur",p=>{setTimeout(()=>{e.querySelector(".task-title-input")&&l()},100)})}formatDueDate(t){let e=new Date,s=new Date(e);s.setDate(e.getDate()+1),e.setHours(0,0,0,0),s.setHours(0,0,0,0);let a=new Date(t);return a.setHours(0,0,0,0),a.getTime()===e.getTime()?"\u4ECA\u5929":a.getTime()===s.getTime()?"\u660E\u5929":t.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}getDueDateClass(t){let e=new Date;e.setHours(0,0,0,0);let s=new Date(t);return s.setHours(0,0,0,0),s.getTime()<e.getTime()?"overdue":s.getTime()===e.getTime()?"today":""}getPriorityIcon(t){switch(t){case 5:return"\u{1F534}";case 3:return"\u{1F7E1}";case 1:return"\u{1F535}";default:return""}}showAddTaskForm(){let t=this.containerEl.querySelector(".add-task-form");if(t){let d=t.querySelector("input");d&&d.focus();return}let e=this.containerEl.children[1],s=e.querySelector(".projects-container"),a=e.createEl("div",{cls:"add-task-form"}),n=a.createEl("select",{cls:"project-select"}),i=a.createEl("input",{cls:"task-input",type:"text",attr:{placeholder:"\u8F93\u5165\u65B0\u4EFB\u52A1..."}}),o=a.createEl("div",{cls:"form-buttons"}),c=o.createEl("button",{cls:"confirm-btn",text:"\u6DFB\u52A0"}),l=o.createEl("button",{cls:"cancel-btn",text:"\u53D6\u6D88"});s?e.insertBefore(a,s):e.appendChild(a),this.loadProjectsToSelect(n),setTimeout(()=>i.focus(),100),c.addEventListener("click",()=>{this.handleAddTask(i.value,n.value,a)}),l.addEventListener("click",()=>{a.remove()}),i.addEventListener("keydown",d=>{d.key==="Enter"?(d.preventDefault(),this.handleAddTask(i.value,n.value,a)):d.key==="Escape"&&a.remove()})}async loadProjectsToSelect(t){try{t.createEl("option",{text:"\u9009\u62E9\u9879\u76EE...",value:"",attr:{disabled:"true",selected:"true"}}),(await this.plugin.apiClient.getProjects()).forEach(s=>{s.closed||t.createEl("option",{text:s.name,value:s.id})})}catch(e){S.error("TaskView","\u52A0\u8F7D\u9879\u76EE\u5217\u8868\u5931\u8D25",e),t.createEl("option",{text:"\u52A0\u8F7D\u9879\u76EE\u5931\u8D25",value:"",attr:{disabled:"true"}})}}async handleAddTask(t,e,s){if(!t.trim()){let a=s.querySelector(".task-input");a.style.borderColor="var(--color-red)",a.placeholder="\u8BF7\u8F93\u5165\u4EFB\u52A1\u6807\u9898",a.focus(),setTimeout(()=>{a.style.borderColor="",a.placeholder="\u8F93\u5165\u65B0\u4EFB\u52A1..."},2e3);return}if(!e){let a=s.querySelector(".project-select");a.style.borderColor="var(--color-red)",setTimeout(()=>{a.style.borderColor=""},2e3);return}try{let a=s.querySelector(".confirm-btn"),n=a.textContent;a.textContent="\u6DFB\u52A0\u4E2D...",a.setAttribute("disabled","true");let i=await this.plugin.apiClient.createTask({title:t.trim(),projectId:e,status:0});S.info("TaskView","\u4EFB\u52A1\u521B\u5EFA\u6210\u529F",{title:i.title,id:i.id}),s.remove(),await this.refreshTasks()}catch(a){S.error("TaskView","\u521B\u5EFA\u4EFB\u52A1\u5931\u8D25",a);let n=s.querySelector(".confirm-btn");n.textContent="\u6DFB\u52A0",n.removeAttribute("disabled");let i=s.querySelector(".error-msg");i||(i=s.createEl("div",{cls:"error-msg"})),i.textContent=`\u521B\u5EFA\u5931\u8D25: ${a.message}`,setTimeout(()=>{i&&i.parentNode&&i.remove()},3e3)}}async toggleTaskStatus(t,e){try{S.debug("TaskView","\u5207\u6362\u4EFB\u52A1\u72B6\u6001",{title:t.title,fromStatus:t.status===1?"\u5B8C\u6210":"\u672A\u5B8C\u6210",toStatus:e?"\u5B8C\u6210":"\u672A\u5B8C\u6210"}),await this.plugin.apiClient.updateTask(t.id,{status:e?2:0});let s=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);if(s){let a=s.querySelector(".task-title");a&&(e?(a.addClass("completed"),t.status=2):(a.removeClass("completed"),t.status=0))}S.info("TaskView","\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0\u6210\u529F")}catch(s){S.error("TaskView","\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u5931\u8D25",s);let a=this.containerEl.querySelector(`[data-task-id="${t.id}"] .task-checkbox`);a&&(a.checked=!e),S.error("TaskView","\u65E0\u6CD5\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001",s)}}};var g=require("obsidian");var $=class{static parseTask(r){let t=r.trim(),e={title:"",tags:[],priority:0},s=this.extractPriority(t);e.priority=s.priority,t=s.cleanText;let a=this.extractDateTime(t);a.date&&(e.dueDate=this.formatDate(a.date)),t=a.cleanText;let n=this.extractProject(t);n.project&&(e.projectName=n.project),t=n.cleanText;let i=this.extractTags(t);return i.tags.length>0&&(e.tags=i.tags),t=i.cleanText,e.title=this.cleanTitle(t),e}static extractPriority(r){let t=0,e=r;for(let s of this.PRIORITY_KEYWORDS.high){let a=new RegExp(`\\b${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"gi");a.test(r)&&(t=Math.max(t,5),e=e.replace(a,"").trim())}if(t===0)for(let s of this.PRIORITY_KEYWORDS.medium){let a=new RegExp(`\\b${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"gi");a.test(r)&&(t=Math.max(t,3),e=e.replace(a,"").trim())}if(t===0)for(let s of this.PRIORITY_KEYWORDS.low){let a=new RegExp(`\\b${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"gi");a.test(r)&&(t=Math.max(t,1),e=e.replace(a,"").trim())}return{priority:t,cleanText:e}}static extractDateTime(r){let t=r,e=null;for(let s of this.TIME_PATTERNS){let a,n=new RegExp(s.pattern.source,s.pattern.flags);for(;(a=n.exec(r))!==null;)try{let i=s.parser(a,e||void 0);i&&!isNaN(i.getTime())&&(e&&i.getHours()!==0?e.setHours(i.getHours(),i.getMinutes()):e=i,t=t.replace(a[0],"").trim())}catch(i){console.warn("\u65E5\u671F\u89E3\u6790\u9519\u8BEF:",i)}}return{date:e,cleanText:t}}static extractProject(r){let t=r,e=null;for(let s of this.PROJECT_PATTERNS){let n=new RegExp(s.source,s.flags).exec(r);if(n&&n[1]){e=n[1].trim(),t=t.replace(n[0],"").trim();break}}return{project:e,cleanText:t}}static extractTags(r){let t=r,e=new Set;for(let s of this.TAG_PATTERNS){let a,n=new RegExp(s.source,s.flags);for(;(a=n.exec(r))!==null;)a[1]&&(e.add(a[1].trim()),t=t.replace(a[0],"").trim())}return{tags:Array.from(e),cleanText:t}}static cleanTitle(r){return r.replace(/\s+/g," ").replace(/^[\s]+|[\s]+$/g,"").trim()}static formatDate(r){return r.toISOString().split("T")[0]}static getSuggestions(r){let t=[],e=r.toLowerCase();return e.includes("\u4ECA")&&!e.includes("\u4ECA\u5929")&&t.push("\u4ECA\u5929"),e.includes("\u660E")&&!e.includes("\u660E\u5929")&&t.push("\u660E\u5929"),(e.includes("\u91CD\u8981")||e.includes("\u7D27\u6025"))&&t.push("!! (\u9AD8\u4F18\u5148\u7EA7)"),e.includes("\u5DE5\u4F5C")&&t.push("#\u5DE5\u4F5C"),e.includes("\u5B66\u4E60")&&t.push("#\u5B66\u4E60"),t}static validateParsedTask(r){let t=[];if((!r.title||r.title.trim().length===0)&&t.push("\u4EFB\u52A1\u6807\u9898\u4E0D\u80FD\u4E3A\u7A7A"),r.title&&r.title.length>200&&t.push("\u4EFB\u52A1\u6807\u9898\u8FC7\u957F\uFF08\u8D85\u8FC7200\u5B57\u7B26\uFF09"),r.dueDate){let e=new Date(r.dueDate);isNaN(e.getTime())&&t.push("\u65E5\u671F\u683C\u5F0F\u65E0\u6548")}return r.priority&&(r.priority<0||r.priority>5)&&t.push("\u4F18\u5148\u7EA7\u6570\u503C\u65E0\u6548\uFF08\u5E94\u4E3A0-5\uFF09"),r.tags&&r.tags.length>10&&t.push("\u6807\u7B7E\u8FC7\u591A\uFF08\u8D85\u8FC710\u4E2A\uFF09"),{isValid:t.length===0,errors:t}}static getExamples(){return[{input:"\u660E\u5929\u4E0B\u53483\u70B9\u5F00\u4F1A #\u5DE5\u4F5C \u91CD\u8981",description:"\u89E3\u6790\u65E5\u671F\u3001\u65F6\u95F4\u3001\u6807\u7B7E\u548C\u4F18\u5148\u7EA7"},{input:"\u4E70\u83DC \u4ECA\u665A7\u70B9\u524D [\u751F\u6D3B]",description:"\u65E5\u671F\u8868\u8FBE\u5F0F\u548C\u9879\u76EE\u5206\u7C7B"},{input:"\u5B8C\u6210\u62A5\u544A 2024-03-15 !! \u9879\u76EE:\u5E74\u5EA6\u603B\u7ED3",description:"\u5177\u4F53\u65E5\u671F\u548C\u9AD8\u4F18\u5148\u7EA7\u6807\u8BB0"},{input:"\u953B\u70BC\u8EAB\u4F53 \u6BCF\u5929 #\u5065\u5EB7 \u4F4E\u4F18\u5148\u7EA7",description:"\u65E5\u5E38\u91CD\u590D\u4EFB\u52A1"},{input:"\u5B66\u4E60\u82F1\u8BED \u4E0B\u5468\u4E00\u4E0A\u5348 @\u5B66\u4E60\u8BA1\u5212",description:"\u76F8\u5BF9\u65E5\u671F\u548C@\u6807\u7B7E"}]}};$.PRIORITY_KEYWORDS={high:["\u91CD\u8981","\u7D27\u6025","\u9AD8\u4F18\u5148\u7EA7","!!","\u26A0\uFE0F","\u{1F534}","\u{1F525}","\u5FC5\u987B","\u7ACB\u5373","\u9A6C\u4E0A"],medium:["\u4E2D\u7B49","\u4E00\u822C","\u4E2D\u4F18\u5148\u7EA7","!","\u{1F7E1}","\u8F83\u91CD\u8981"],low:["\u4F4E","\u6B21\u8981","\u4F4E\u4F18\u5148\u7EA7","\u{1F535}","\u53EF\u9009","\u6709\u7A7A\u7684\u65F6\u5019"]},$.TIME_PATTERNS=[{pattern:/(\d{4})[\-\/](\d{1,2})[\-\/](\d{1,2})[]?/g,parser:r=>{let[,t,e,s]=r;return new Date(parseInt(t),parseInt(e)-1,parseInt(s))}},{pattern:/[]/g,parser:()=>new Date},{pattern:/[]/g,parser:()=>{let r=new Date;return r.setDate(r.getDate()+1),r}},{pattern:/[]/g,parser:()=>{let r=new Date;return r.setDate(r.getDate()+2),r}},{pattern:/([1-7]?)/g,parser:r=>{var o;let t={\u4E00:1,1:1,\u4E8C:2,2:2,\u4E09:3,3:3,\u56DB:4,4:4,\u4E94:5,5:5,\u516D:6,6:6,\u4E03:0,7:0,\u5929:0,\u65E5:0},e=new Date,s=e.getDay(),a=r[1]&&(o=t[r[1]])!=null?o:1,n=7-s+a,i=new Date;return i.setDate(e.getDate()+n),i}},{pattern:/(\d{1,2})[]/g,parser:r=>{let t=parseInt(r[1]),e=new Date;return e.setDate(e.getDate()+t),e}},{pattern:/(\d{1,2})[](?:(\d{1,2})[]?)?/g,parser:(r,t)=>{let e=parseInt(r[1]),s=r[2]?parseInt(r[2]):0,a=t||new Date;return a.setHours(e,s,0,0),a}},{pattern:/\b\d{4}-\d{2}-\d{2}\b/g,parser:r=>new Date(r[0])}],$.PROJECT_PATTERNS=[/(?:|)[:]?\s*([^\s]+)/g,/\#([^#\s]+)/g,/\[([^\]]+)\]/g],$.TAG_PATTERNS=[/\#([^#\s]+)/g,/[:]?\s*([^\s]+)/g,/\@([^@\s]+)/g];var _="dida-style-task-view",it=class extends g.ItemView{constructor(t,e){super(t);this.allTasks=[];this.allProjects=[];this.currentFilter="all";this.searchQuery="";this.quickAddInput=null;this.currentGroupBy="time";this.collapsedGroups=new Set;this.currentActiveGroupId=null;this.plugin=e,this.currentGroupBy=this.plugin.settings.viewSettings.lastGroupBy||"time",console.log(`\u{1F4CC} \u6062\u590D\u4E0A\u6B21\u7684\u5206\u7EC4\u65B9\u5F0F: ${this.currentGroupBy}`)}getViewType(){return _}getDisplayText(){return"\u6EF4\u7B54\u4EFB\u52A1"}getIcon(){return"list-checks"}async onOpen(){console.log("\u{1F680} \u6253\u5F00\u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u4EFB\u52A1\u89C6\u56FE");try{let t=this.containerEl.children[1];t.empty(),t.addClass("task-view-container"),this.createHeader(t),this.createContentArea(t),this.createQuickAddForm(t),this.showWelcomeMessage(),await this.loadAndDisplayTasks(),console.log("\u2705 \u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u754C\u9762\u52A0\u8F7D\u5B8C\u6210")}catch(t){console.error("\u274C \u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u754C\u9762\u52A0\u8F7D\u5931\u8D25:",t),this.showErrorMessage("\u754C\u9762\u52A0\u8F7D\u5931\u8D25: "+t.message)}}showWelcomeMessage(){let t=this.containerEl.querySelector(".smart-groups");if(t){t.innerHTML="";let e=t.createEl("div",{cls:"welcome-message"});e.createEl("div",{cls:"welcome-icon",text:"\u{1F389}"}),e.createEl("h3",{cls:"welcome-title",text:"\u6B22\u8FCE\u4F7F\u7528\u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u754C\u9762\uFF01"}),e.createEl("p",{cls:"welcome-description",text:"\u8FD9\u662F\u5168\u65B0\u7684\u4EFB\u52A1\u7BA1\u7406\u754C\u9762\uFF0C\u6B63\u5728\u52A0\u8F7D\u60A8\u7684\u4EFB\u52A1\u6570\u636E..."})}}showErrorMessage(t){let e=this.containerEl.querySelector(".smart-groups");if(e){e.innerHTML="";let s=e.createEl("div",{cls:"error-message-container"});s.createEl("div",{cls:"error-icon",text:"\u274C"}),s.createEl("h3",{cls:"error-title",text:"\u52A0\u8F7D\u5931\u8D25"}),s.createEl("p",{cls:"error-description",text:t}),s.createEl("button",{cls:"retry-btn",text:"\u91CD\u8BD5\u52A0\u8F7D"}).addEventListener("click",()=>this.loadAndDisplayTasks())}}createHeader(t){let e=t.createEl("div",{cls:"task-view-header"}),s=e.createEl("div",{cls:"header-top"}),a=s.createEl("div",{cls:"task-view-title"});a.createEl("div",{cls:"dida-logo",text:"\u6EF4"}),a.createEl("span",{text:"\u6EF4\u7B54\u4EFB\u52A1"});let n=s.createEl("div",{cls:"header-actions"}),i=n.createEl("button",{cls:"toggle-search-btn",attr:{"aria-label":"\u641C\u7D22\u548C\u7B5B\u9009",title:"\u641C\u7D22\u548C\u7B5B\u9009"},text:"\u{1F50D}"}),o=n.createEl("button",{cls:"quick-add-btn",attr:{"aria-label":"\u5FEB\u901F\u6DFB\u52A0\u4EFB\u52A1"}});o.createEl("span",{text:"\u6DFB\u52A0\u4EFB\u52A1"});let c=n.createEl("button",{cls:"refresh-btn",attr:{"aria-label":"\u5237\u65B0\u4EFB\u52A1"},text:"\u{1F504}"}),l=e.createEl("div",{cls:"collapsible-search-area collapsed"}),d=l.createEl("div",{cls:"search-container"});d.createEl("div",{cls:"search-icon",text:"\u{1F50D}"});let p=d.createEl("input",{cls:"search-input",type:"text",attr:{placeholder:"\u641C\u7D22\u4EFB\u52A1\u3001\u9879\u76EE\u3001\u6807\u7B7E..."}}),u=l.createEl("div",{cls:"filters-container"});this.createFilterChips(u);let m=e.createEl("div",{cls:"groupby-container compact"}),v=m.createEl("span",{cls:"groupby-label",text:"\u5206\u7EC4\uFF1A"}),D=m.createEl("select",{cls:"groupby-select"});[{value:"time",text:"\u{1F4C5} \u65F6\u95F4",icon:"\u{1F4C5}"},{value:"project",text:"\u{1F4C1} \u9879\u76EE",icon:"\u{1F4C1}"},{value:"status",text:"\u{1F4CA} \u72B6\u6001",icon:"\u{1F4CA}"},{value:"priority",text:"\u{1F525} \u4F18\u5148\u7EA7",icon:"\u{1F525}"}].forEach(C=>{let H=D.createEl("option",{value:C.value,text:C.text});C.value===this.currentGroupBy&&(H.selected=!0)});let F=m.createEl("div",{cls:"task-stats compact"});F.innerHTML=`
            <span class="stat-compact">\u{1F4CB} <span class="stat-number" data-stat="total">0</span></span>
            <span class="stat-compact">\u{1F4C5} <span class="stat-number" data-stat="today">0</span></span>
            <span class="stat-compact">\u2705 <span class="stat-number" data-stat="completed">0</span></span>
        `,i.addEventListener("click",()=>{l.hasClass("collapsed")?(l.removeClass("collapsed"),i.addClass("active")):(l.addClass("collapsed"),i.removeClass("active"))}),o.addEventListener("click",()=>{this.focusQuickAdd();let C=this.containerEl.querySelector(".quick-add-form");C&&!C.hasClass("collapsed")?o.addClass("active"):o.removeClass("active")}),c.addEventListener("click",()=>this.refreshTasks()),p.addEventListener("input",C=>this.handleSearch(C.target.value)),D.addEventListener("change",C=>this.handleGroupByChange(C.target.value))}createFilterChips(t){[{id:"all",text:"\u5168\u90E8",icon:"\u{1F4CB}"},{id:"today",text:"\u4ECA\u5929",icon:"\u{1F4C5}"},{id:"upcoming",text:"\u5373\u5C06\u5230\u671F",icon:"\u23F0"},{id:"overdue",text:"\u5DF2\u903E\u671F",icon:"\u{1F534}"},{id:"completed",text:"\u5DF2\u5B8C\u6210",icon:"\u2705"},{id:"high-priority",text:"\u9AD8\u4F18\u5148\u7EA7",icon:"\u{1F525}"}].forEach(s=>{let a=t.createEl("div",{cls:`filter-chip ${s.id===this.currentFilter?"active":""}`,attr:{"data-filter":s.id}});a.createEl("span",{text:`${s.icon} ${s.text}`}),a.addEventListener("click",()=>this.handleFilterChange(s.id))})}createContentArea(t){let e=t.createEl("div",{cls:"task-content-area"});e.createEl("div",{cls:"group-tabs-container"}),e.createEl("div",{cls:"smart-groups"})}createQuickAddForm(t){let e=t.createEl("div",{cls:"quick-add-form collapsed"}),s=e.createEl("div",{cls:"add-input-container"});this.quickAddInput=s.createEl("textarea",{cls:"add-task-input",attr:{placeholder:"\u8F93\u5165\u4EFB\u52A1\u5185\u5BB9\uFF0C\u6309 Enter \u6DFB\u52A0...",rows:"1"}});let a=e.createEl("div",{cls:"add-options"});a.createEl("div",{cls:"add-option-btn",attr:{"data-option":"project"}}).createEl("span",{text:"\u{1F4C1} \u9879\u76EE"}),a.createEl("div",{cls:"add-option-btn",attr:{"data-option":"priority"}}).createEl("span",{text:"\u{1F525} \u4F18\u5148\u7EA7"}),a.createEl("div",{cls:"add-option-btn",attr:{"data-option":"due-date"}}).createEl("span",{text:"\u{1F4C5} \u622A\u6B62\u65E5\u671F"}),a.createEl("div",{cls:"add-option-btn",attr:{"data-option":"tags"}}).createEl("span",{text:"\u{1F3F7}\uFE0F \u6807\u7B7E"});let l=e.createEl("div",{cls:"smart-suggestions-container"});l.style.display="none",this.quickAddInput.addEventListener("keydown",d=>this.handleQuickAddKeydown(d)),this.quickAddInput.addEventListener("input",()=>{this.autoResizeTextarea(),this.showSmartSuggestions()}),a.addEventListener("click",d=>this.handleAddOptionClick(d))}async loadAndDisplayTasks(){try{console.log("\u{1F4E5} \u5F00\u59CB\u52A0\u8F7D\u4EFB\u52A1\u6570\u636E..."),this.showLoadingState();let t=await this.plugin.apiClient.getAllTasksIncludingInbox(),e=await this.plugin.apiClient.getProjects(),s=this.plugin.apiClient.getInboxProjectInfo();if(s){let i={id:s.id,name:s.name,color:s.color,isOwner:!0,permission:"write",closed:!1,sortOrder:s.sortOrder,kind:"INBOX"},o=e.find(c=>c.id===s.id);o?console.log(`\u{1F4E5} \u6536\u96C6\u7BB1\u9879\u76EE\u5DF2\u5B58\u5728: ${o.name}`):(e.unshift(i),console.log(`\u{1F4E5} \u6536\u96C6\u7BB1\u5DF2\u6DFB\u52A0\u5230\u9879\u76EE\u5217\u8868: ID=${s.id}`))}let a=new Map(e.map(i=>[i.id,i])),n=new Map;t.forEach(i=>{i.projectId&&(a.has(i.projectId)||(n.has(i.projectId)||n.set(i.projectId,{name:i.projectName||"\u672A\u77E5\u9879\u76EE",color:i.projectColor||"#9E9E9E",tasks:[]}),n.get(i.projectId).tasks.push(i)))}),n.size>0&&(console.log(`\u{1F50D} \u53D1\u73B0 ${n.size} \u4E2A\u672A\u5728API\u9879\u76EE\u5217\u8868\u4E2D\u7684\u9879\u76EE:`),n.forEach((i,o)=>{console.log(`  - ${i.name} (ID: ${o}), \u4EFB\u52A1\u6570: ${i.tasks.length}`);let c={id:o,name:i.name,color:i.color,isOwner:!0,permission:"write",closed:!1,sortOrder:0};e.push(c)})),this.allProjects=e,this.allTasks=t,console.log(`\u{1F4CA} \u603B\u5171\u52A0\u8F7D\u4E86 ${this.allTasks.length} \u4E2A\u4EFB\u52A1`),console.log("\u5F53\u524D\u7B5B\u9009\u5668:",this.currentFilter),this.updateStats(),this.displaySmartGroups()}catch(t){console.error("\u274C \u52A0\u8F7D\u4EFB\u52A1\u5931\u8D25:",t),this.showErrorState("\u52A0\u8F7D\u4EFB\u52A1\u5931\u8D25: "+t.message)}}showLoadingState(){let t=this.containerEl.querySelector(".smart-groups");if(t){t.innerHTML="";let e=t.createEl("div",{cls:"loading-container"});e.createEl("div",{cls:"loading-spinner"}),e.createEl("div",{cls:"loading-text",text:"\u6B63\u5728\u52A0\u8F7D\u4EFB\u52A1..."})}}showErrorState(t){let e=this.containerEl.querySelector(".smart-groups");if(e){e.innerHTML="";let s=e.createEl("div",{cls:"empty-state"});s.createEl("div",{cls:"empty-icon",text:"\u274C"}),s.createEl("h3",{cls:"empty-title",text:"\u52A0\u8F7D\u5931\u8D25"}),s.createEl("p",{cls:"empty-description",text:t})}}updateStats(){let t=this.allTasks.length,e=this.getTodayTasks().length,s=this.allTasks.filter(n=>n.status===2).length;this.containerEl.querySelectorAll(".stat-number").forEach(n=>{let i=n.getAttribute("data-stat");i==="total"?n.textContent=t.toString():i==="today"?n.textContent=e.toString():i==="completed"&&(n.textContent=s.toString())})}displaySmartGroups(){console.log("\u{1F504} \u5F00\u59CB\u663E\u793A\u667A\u80FD\u5206\u7EC4...");let t=this.containerEl.querySelector(".group-tabs-container"),e=this.containerEl.querySelector(".smart-groups");if(!t||!e){console.error("\u274C \u627E\u4E0D\u5230\u5FC5\u8981\u7684\u5BB9\u5668");return}t.innerHTML="",e.innerHTML="",e.removeClass("horizontal-layout");let s=this.getSmartGroups();if(console.log(`\u{1F4CA} \u83B7\u53D6\u5230 ${s.length} \u4E2A\u5206\u7EC4:`,s.map(n=>`${n.title}(${n.tasks.length})`)),s.every(n=>n.tasks.length===0)){console.log("\u{1F4DD} \u6240\u6709\u5206\u7EC4\u90FD\u4E3A\u7A7A\uFF0C\u663E\u793A\u7A7A\u72B6\u6001"),this.showEmptyState(e);return}if(!this.currentActiveGroupId){let n=s.find(i=>i.tasks.length>0);n&&(this.currentActiveGroupId=n.id)}this.createGroupTabs(t,s);let a=s.find(n=>n.id===this.currentActiveGroupId);a&&a.tasks.length>0?(console.log(`\u{1F4C1} \u663E\u793A\u6FC0\u6D3B\u5206\u7EC4: ${a.title} (${a.tasks.length} \u4E2A\u4EFB\u52A1)`),this.displayActiveGroupTasks(e,a)):this.showEmptyState(e),console.log("\u2705 \u667A\u80FD\u5206\u7EC4\u663E\u793A\u5B8C\u6210")}createGroupTabs(t,e){let s=t.createEl("div",{cls:"group-tabs-wrapper"});this.applySortOrder(e).forEach((n,i)=>{if(n.tasks.length===0)return;let o=s.createEl("div",{cls:`group-tab ${n.id===this.currentActiveGroupId?"active":""}`,attr:{"data-group-id":n.id,draggable:"true"}}),c=o.createEl("div",{cls:"group-tab-content"}),l=c.createEl("span",{cls:"group-tab-drag-handle",text:"\u22EE"});c.createEl("span",{cls:"group-tab-icon",text:n.icon}),c.createEl("span",{cls:"group-tab-title",text:n.title}),c.createEl("span",{cls:"group-tab-count",text:n.tasks.length.toString()}),o.addEventListener("click",d=>{d.target.closest(".group-tab-drag-handle")||this.switchActiveGroup(n.id)}),this.setupTabDragEvents(o,n.id)})}applySortOrder(t){let e=this.plugin.settings.viewSettings.groupTabOrder[this.currentGroupBy]||[];if(e.length===0)return t;let s=new Map;return e.forEach((a,n)=>{s.set(a,n)}),[...t].sort((a,n)=>{var c,l;let i=(c=s.get(a.id))!=null?c:999,o=(l=s.get(n.id))!=null?l:999;return i-o})}setupTabDragEvents(t,e){let s=null,a=null;t.addEventListener("dragstart",n=>{s=t,t.addClass("dragging"),t.style.opacity="0.5",n.dataTransfer&&(n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("text/plain",e)),console.log(`\u{1F3AF} \u5F00\u59CB\u62D6\u62FDTab: ${e}`)}),t.addEventListener("dragend",n=>{t.removeClass("dragging"),t.style.opacity="",this.containerEl.querySelectorAll(".group-tab").forEach(i=>{i.removeClass("drag-over-left","drag-over-right")}),s=null,a=null,console.log("\u{1F3C1} \u62D6\u62FD\u7ED3\u675F")}),t.addEventListener("dragover",n=>{if(n.preventDefault(),s===t)return;n.dataTransfer&&(n.dataTransfer.dropEffect="move"),this.containerEl.querySelectorAll(".group-tab").forEach(l=>{l.removeClass("drag-over-left","drag-over-right")});let i=t.getBoundingClientRect(),o=i.left+i.width/2;n.clientX<o?t.addClass("drag-over-left"):t.addClass("drag-over-right"),a=t}),t.addEventListener("dragleave",n=>{let i=t.getBoundingClientRect();(n.clientX<i.left||n.clientX>i.right||n.clientY<i.top||n.clientY>i.bottom)&&t.removeClass("drag-over-left","drag-over-right")}),t.addEventListener("drop",n=>{var d;n.preventDefault();let i=(d=n.dataTransfer)==null?void 0:d.getData("text/plain");if(!i||i===e)return;let o=t.getBoundingClientRect(),c=o.left+o.width/2,l=n.clientX<c;console.log(`\u{1F4DD} \u62D6\u62FDTab: ${i} -> ${e}, \u63D2\u5165${l?"\u524D":"\u540E"}`),this.reorderTabs(i,e,l),t.removeClass("drag-over-left","drag-over-right")})}async reorderTabs(t,e,s){console.log(`\u{1F504} \u91CD\u65B0\u6392\u5E8FTab: draggedId="${t}", targetId="${e}", insertBefore=${s}`);let a=this.getSmartGroups(),n=this.applySortOrder(a),i=[...this.plugin.settings.viewSettings.groupTabOrder[this.currentGroupBy]||[]];i.length===0&&(i=n.map(u=>u.id),console.log("\u{1F4CB} \u521D\u59CB\u5316\u81EA\u5B9A\u4E49\u987A\u5E8F:",i)),i.includes(t)||(console.log(`\u26A0\uFE0F draggedId "${t}" \u4E0D\u5728\u81EA\u5B9A\u4E49\u987A\u5E8F\u4E2D\uFF0C\u6DFB\u52A0\u5B83`),i.push(t)),i.includes(e)||(console.log(`\u26A0\uFE0F targetId "${e}" \u4E0D\u5728\u81EA\u5B9A\u4E49\u987A\u5E8F\u4E2D\uFF0C\u6DFB\u52A0\u5B83`),i.push(e));let o=i.indexOf(t),c=i.indexOf(e);if(o===-1||c===-1){console.error(`\u274C \u65E0\u6CD5\u627E\u5230\u62D6\u62FD\u7684Tab\u6216\u76EE\u6807Tab: draggedIndex=${o}, targetIndex=${c}`),console.error("\u5F53\u524DcustomOrder:",i),console.error("\u6240\u6709\u5206\u7EC4:",a.map(u=>({id:u.id,title:u.title})));return}i.splice(o,1);let l=i.indexOf(e),d=s?l:l+1;i.splice(d,0,t),console.log("\u{1F4CA} \u65B0\u7684Tab\u987A\u5E8F:",i),this.plugin.settings.viewSettings.groupTabOrder[this.currentGroupBy]=i,await this.plugin.saveSettings(),console.log("\u{1F4BE} Tab\u987A\u5E8F\u5DF2\u4FDD\u5B58\u5230\u8BBE\u7F6E");let p=this.containerEl.querySelector(".group-tabs-container");p&&(p.innerHTML="",this.createGroupTabs(p,a))}switchActiveGroup(t){console.log(`\u{1F504} \u5207\u6362\u5230\u5206\u7EC4: ${t}`),this.currentActiveGroupId=t,this.containerEl.querySelectorAll(".group-tab").forEach(a=>{a.getAttribute("data-group-id")===t?a.addClass("active"):a.removeClass("active")});let s=this.containerEl.querySelector(".smart-groups");if(s){s.innerHTML="";let n=this.getSmartGroups().find(i=>i.id===t);n&&n.tasks.length>0&&this.displayActiveGroupTasks(s,n)}}displayActiveGroupTasks(t,e){let s=t.createEl("div",{cls:"active-group-tasks"}),a=s.createEl("div",{cls:"active-group-header"});a.createEl("h3",{text:`${e.icon} ${e.title}`}),a.createEl("span",{cls:"task-count-badge",text:`${e.tasks.length} \u4E2A\u4EFB\u52A1`}),e.tasks.forEach(n=>{this.createTaskCard(s,n)})}getSmartGroups(){let t=this.getFilteredTasks();switch(this.currentGroupBy){case"project":return this.getProjectGroups(t);case"status":return this.getStatusGroups(t);case"priority":return this.getPriorityGroups(t);case"time":default:return this.getTimeGroups(t)}}getTimeGroups(t){let e=new Date,s=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=new Date(s);a.setDate(s.getDate()+1);let n=new Date(s);return n.setDate(s.getDate()+7),[{id:"overdue",title:"\u5DF2\u903E\u671F",icon:"\u{1F534}",color:"#FF4757",tasks:t.filter(i=>{if(!i.dueDate||i.status===2)return!1;let o=new Date(i.dueDate);return new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()<s.getTime()})},{id:"today",title:"\u4ECA\u5929",icon:"\u{1F4C5}",color:"#FFA726",tasks:t.filter(i=>{if(!i.dueDate)return!1;let o=new Date(i.dueDate);return new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()===s.getTime()})},{id:"tomorrow",title:"\u660E\u5929",icon:"\u{1F4CB}",color:"#4A90FB",tasks:t.filter(i=>{if(!i.dueDate)return!1;let o=new Date(i.dueDate);return new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()===a.getTime()})},{id:"upcoming",title:"\u5373\u5C06\u5230\u671F",icon:"\u23F0",color:"#26C6DA",tasks:t.filter(i=>{if(!i.dueDate||i.status===2)return!1;let o=new Date(i.dueDate),c=new Date(o.getFullYear(),o.getMonth(),o.getDate());return c>a&&c<=n})},{id:"completed-today",title:"\u4ECA\u65E5\u5B8C\u6210",icon:"\u2705",color:"#00C851",tasks:t.filter(i=>{if(i.status!==2||!i.completedDate)return!1;let o=new Date(i.completedDate);return new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()===s.getTime()})},{id:"no-due-date",title:"\u65E0\u622A\u6B62\u65E5\u671F",icon:"\u{1F4C2}",color:"#9E9E9E",tasks:t.filter(i=>!i.dueDate&&i.status!==2)}].filter(i=>i.tasks.length>0)}getStatusGroups(t){return[{id:"todo",title:"\u5F85\u529E\u4E8B\u9879",icon:"\u{1F4DD}",color:"#4A90FB",tasks:t.filter(e=>e.status===0)},{id:"in-progress",title:"\u8FDB\u884C\u4E2D",icon:"\u{1F504}",color:"#FFA726",tasks:t.filter(e=>e.status===1)},{id:"completed",title:"\u5DF2\u5B8C\u6210",icon:"\u2705",color:"#00C851",tasks:t.filter(e=>e.status===2)}].filter(e=>e.tasks.length>0)}getPriorityGroups(t){return[{id:"priority-high",title:"\u9AD8\u4F18\u5148\u7EA7",icon:"\u{1F525}",color:"#FF4757",tasks:t.filter(e=>e.priority>=5)},{id:"priority-medium",title:"\u4E2D\u4F18\u5148\u7EA7",icon:"\u{1F7E1}",color:"#FFA726",tasks:t.filter(e=>e.priority>=3&&e.priority<5)},{id:"priority-low",title:"\u4F4E\u4F18\u5148\u7EA7",icon:"\u{1F535}",color:"#42A5F5",tasks:t.filter(e=>e.priority>=1&&e.priority<3)},{id:"priority-none",title:"\u65E0\u4F18\u5148\u7EA7",icon:"\u26AA",color:"#9E9E9E",tasks:t.filter(e=>!e.priority||e.priority===0)}].filter(e=>e.tasks.length>0)}getProjectGroups(t){let e={},s=this.allProjects.filter(n=>n.name==="\u6536\u96C6\u7BB1"||n.name.toLowerCase().includes("inbox")||n.id==="inbox"||n.id&&n.id.includes("inbox")||n.kind==="INBOX");return console.log("\u{1F50D} \u67E5\u627E\u6536\u96C6\u7BB1\u9879\u76EE:",s.length>0?s.map(n=>`${n.name} (ID: ${n.id})`).join(", "):"\u672A\u627E\u5230"),t.forEach(n=>{let i=n.projectId;i?s.length>0&&s.find(c=>i===c.id||i==="inbox"||i&&i.includes("inbox")||n.projectName==="\u6536\u96C6\u7BB1"||n.projectName&&n.projectName.toLowerCase().includes("inbox"))&&(i="inbox",console.log("\u{1F50D} \u4EFB\u52A1\u5F52\u7C7B\u4E3A\u6536\u96C6\u7BB1:",n.title,"originalId:",n.projectId,"mappedId:",i)):i="uncategorized",e[i]||(e[i]=[]),e[i].push(n)}),Object.entries(e).map(([n,i])=>{var l,d;if(n==="inbox"&&s.length>0){let p=s[0];return{id:p.id,title:p.name,icon:"\u{1F4E5}",color:p.color||"#42A5F5",tasks:i,sortOrder:(l=p.sortOrder)!=null?l:-999999}}if(n==="uncategorized")return{id:"uncategorized",title:"\u672A\u5206\u7C7B",icon:"\u{1F4C2}",color:"#9E9E9E",tasks:i,sortOrder:999999};let o=this.allProjects.find(p=>p.id===n);if(!o)return console.warn(`\u26A0\uFE0F \u627E\u4E0D\u5230\u9879\u76EE ${n}\uFF0C\u4EFB\u52A1\u5F52\u5165"\u672A\u5206\u7C7B"`),e.uncategorized||(e.uncategorized=[]),e.uncategorized.push(...i),null;let c="\u{1F4C1}";return(o.name.includes("\u751F\u65E5\u63D0\u9192")||o.name.toLowerCase().includes("birthday"))&&(c="\u{1F382}"),{id:n,title:o.name,icon:c,color:o.color||"#9E9E9E",tasks:i,sortOrder:(d=o.sortOrder)!=null?d:999}}).filter(n=>n!==null).sort((n,i)=>{var l,d;let o=(l=n.sortOrder)!=null?l:999;return((d=i.sortOrder)!=null?d:999)-o})}getFilteredTasks(){let t=[...this.allTasks];if(this.searchQuery){let e=this.searchQuery.toLowerCase();t=t.filter(s=>{var a,n;return s.title.toLowerCase().includes(e)||((a=s.projectName)==null?void 0:a.toLowerCase().includes(e))||((n=s.content)==null?void 0:n.toLowerCase().includes(e))||s.tags&&s.tags.some(i=>i.toLowerCase().includes(e))})}switch(this.currentFilter){case"today":return this.getTodayTasks(t);case"upcoming":return this.getUpcomingTasks(t);case"overdue":return this.getOverdueTasks(t);case"completed":return t.filter(e=>e.status===2);case"high-priority":return t.filter(e=>(e.priority||0)>=5&&e.status!==2);case"all":default:return t}}getTodayTasks(t=this.allTasks){let e=new Date,s=new Date(e.getFullYear(),e.getMonth(),e.getDate());return t.filter(a=>{if(!a.dueDate)return!1;let n=new Date(a.dueDate);return new Date(n.getFullYear(),n.getMonth(),n.getDate()).getTime()===s.getTime()})}getUpcomingTasks(t=this.allTasks){let e=new Date,s=new Date(e);s.setDate(e.getDate()+1);let a=new Date(e);return a.setDate(e.getDate()+7),t.filter(n=>{if(!n.dueDate||n.status===2)return!1;let i=new Date(n.dueDate),o=new Date(i.getFullYear(),i.getMonth(),i.getDate());return o>=s&&o<=a})}getOverdueTasks(t=this.allTasks){let e=new Date,s=new Date(e.getFullYear(),e.getMonth(),e.getDate());return t.filter(a=>{if(!a.dueDate||a.status===2)return!1;let n=new Date(a.dueDate);return new Date(n.getFullYear(),n.getMonth(),n.getDate())<s})}createGroupSection(t,e){console.log(`\u{1F3D7}\uFE0F \u521B\u5EFA\u5206\u7EC4section: ${e.title}, \u4EFB\u52A1\u6570: ${e.tasks.length}`);let s=t.createEl("div",{cls:"group-section"});s.setAttribute("data-group-id",e.id);let a=s.createEl("div",{cls:"group-header"}),n=a.createEl("div",{cls:"group-title-wrapper"}),i=this.collapsedGroups.has(e.id),o=n.createEl("span",{cls:"group-collapse-icon",text:i?"\u25B6":"\u25BC"}),c=n.createEl("h3",{cls:"group-title"});c.createEl("span",{text:`${e.icon} ${e.title}`});let l=c.createEl("span",{cls:"group-count",text:e.tasks.length.toString()}),d=s.createEl("div",{cls:`group-tasks ${i?"collapsed":""}`});i||(console.log(`\u{1F4DD} \u5F00\u59CB\u521B\u5EFA ${e.tasks.length} \u4E2A\u4EFB\u52A1\u5361\u7247...`),e.tasks.forEach((p,u)=>{console.log(`  \u521B\u5EFA\u4EFB\u52A1\u5361\u7247 ${u+1}: ${p.title}`),this.createTaskCard(d,p)})),a.addEventListener("click",()=>{this.toggleGroupCollapse(e.id,o,d)}),this.setupGroupDropEvents(s,e.id),console.log(`\u2705 \u5206\u7EC4 "${e.title}" \u521B\u5EFA\u5B8C\u6210 ${i?"(\u5DF2\u6298\u53E0)":""}`)}toggleGroupCollapse(t,e,s){if(this.collapsedGroups.has(t)){this.collapsedGroups.delete(t),e.textContent="\u25BC",s.removeClass("collapsed"),s.innerHTML="";let i=this.getSmartGroups().find(o=>o.id===t);i&&i.tasks.length>0&&i.tasks.forEach(o=>{this.createTaskCard(s,o)}),console.log(`\u{1F4C2} \u5206\u7EC4 "${t}" \u5DF2\u5C55\u5F00`)}else this.collapsedGroups.add(t),e.textContent="\u25B6",s.addClass("collapsed"),s.innerHTML="",console.log(`\u{1F4C1} \u5206\u7EC4 "${t}" \u5DF2\u6298\u53E0`);s.style.transition="max-height 0.3s ease, opacity 0.3s ease"}createTaskCard(t,e){let s=t.createEl("div",{cls:"task-card"});s.setAttribute("data-task-id",e.id),s.setAttribute("draggable","true"),e.status===2&&s.addClass("completed"),e.priority>=5?s.addClass("priority-high"):e.priority>=3?s.addClass("priority-medium"):e.priority>=1&&s.addClass("priority-low");let a=s.createEl("div",{cls:"task-drag-handle"});a.innerHTML="\u22EE\u22EE";let i=s.createEl("div",{cls:"task-checkbox-wrapper"}).createEl("input",{cls:"task-checkbox",type:"checkbox"});i.checked=e.status===2;let o=s.createEl("div",{cls:"task-main-content"}),c=o.createEl("div",{cls:"task-title",text:e.title}),l=o.createEl("div",{cls:"task-meta"});if(e.projectName&&l.createEl("span",{cls:"task-project",text:e.projectName}),e.dueDate){let v=l.createEl("span",{cls:`task-due-date ${this.getDueDateClass(new Date(e.dueDate))}`,text:this.formatDueDate(new Date(e.dueDate))})}if(e.tags&&e.tags.length>0){let v=l.createEl("div",{cls:"task-tags"});e.tags.forEach(D=>{v.createEl("span",{cls:"task-tag",text:D})})}e.items&&e.items.length>0&&this.createSubtasksSection(o,e);let d=s.createEl("div",{cls:"task-actions"}),p=d.createEl("button",{cls:"task-action-btn star",attr:{"aria-label":"\u6807\u8BB0\u91CD\u8981",title:"\u6807\u8BB0\u91CD\u8981"},text:e.priority>=5?"\u2B50":"\u2606"}),u=d.createEl("button",{cls:"task-action-btn",attr:{"aria-label":"\u7F16\u8F91\u4EFB\u52A1",title:"\u7F16\u8F91\u4EFB\u52A1"},text:"\u270F\uFE0F"}),m=d.createEl("button",{cls:"task-action-btn delete",attr:{"aria-label":"\u5220\u9664\u4EFB\u52A1",title:"\u5220\u9664\u4EFB\u52A1"},text:"\u{1F5D1}\uFE0F"});this.setupTaskDragEvents(s,e),i.addEventListener("change",()=>this.handleTaskToggle(e,i.checked)),p.addEventListener("click",v=>{v.stopPropagation(),this.toggleTaskPriority(e)}),u.addEventListener("click",v=>{v.stopPropagation(),this.openTaskDetail(e)}),m.addEventListener("click",v=>{v.stopPropagation(),this.confirmDeleteTask(e)}),s.addEventListener("click",v=>{v.target.closest(".task-checkbox-wrapper, .task-actions, .task-drag-handle")||this.openTaskDetail(e)})}setupTaskDragEvents(t,e){let s=0,a=null,n=null;t.addEventListener("dragstart",i=>{if(i.target!==t&&!i.target.closest(".task-drag-handle")){i.preventDefault();return}a=e,s=i.clientY,t.addClass("dragging"),t.style.opacity="0.6",t.style.transform="rotate(2deg) scale(1.02)",t.style.zIndex="1000",t.style.boxShadow="0 8px 25px rgba(0, 0, 0, 0.3)",i.dataTransfer&&(i.dataTransfer.setData("text/plain",e.id),i.dataTransfer.effectAllowed="move"),console.log(`\u{1F680} \u5F00\u59CB\u62D6\u62FD\u4EFB\u52A1: ${e.title}`),this.addDragTargetStyles()}),t.addEventListener("dragend",i=>{t.removeClass("dragging"),t.style.opacity="",t.style.transform="",t.style.zIndex="",t.style.boxShadow="",this.clearDragStyles(),a=null,n=null,console.log("\u{1F3C1} \u62D6\u62FD\u7ED3\u675F")}),t.addEventListener("dragover",i=>{if(i.preventDefault(),t.hasClass("dragging"))return;let o=t.getBoundingClientRect(),c=o.top+o.height/2,l=i.clientY>c;this.showDragInsertIndicator(t,l),n=t}),t.addEventListener("dragleave",i=>{let o=t.getBoundingClientRect();(i.clientX<o.left||i.clientX>o.right||i.clientY<o.top||i.clientY>o.bottom)&&(this.hideDragInsertIndicator(),n=null)}),t.addEventListener("drop",i=>{var l;i.preventDefault();let o=(l=i.dataTransfer)==null?void 0:l.getData("text/plain");if(!o||o===e.id)return;let c=this.allTasks.find(d=>d.id===o);c&&(this.handleTaskReorder(c,e,t,i.clientY),this.hideDragInsertIndicator())})}addDragTargetStyles(){this.containerEl.querySelectorAll(".task-card:not(.dragging)").forEach(e=>{e.addClass("drag-target")})}clearDragStyles(){this.containerEl.querySelectorAll(".task-card").forEach(e=>{e.removeClass("drag-target","drag-over","drag-before","drag-after")}),this.hideDragInsertIndicator(),document.querySelectorAll(".group-tasks.drop-target").forEach(e=>{e.removeClass("drop-target")})}showDragInsertIndicator(t,e){this.hideDragInsertIndicator(),this.containerEl.querySelectorAll(".task-card").forEach(o=>o.removeClass("drag-over","drag-before","drag-after")),t.addClass("drag-over"),e?t.addClass("drag-after"):t.addClass("drag-before");let a=document.querySelector(".drag-insert-line");a||(a=document.createElement("div"),a.className="drag-insert-line",a.innerHTML=`
                <div class="drag-line"></div>
                <div class="drag-circle-left"></div>
                <div class="drag-circle-right"></div>
            `);let n=t.getBoundingClientRect(),i=this.containerEl.getBoundingClientRect();a.style.position="fixed",a.style.left=`${n.left}px`,a.style.width=`${n.width}px`,a.style.zIndex="1001",e?a.style.top=`${n.bottom-2}px`:a.style.top=`${n.top-2}px`,document.body.appendChild(a),setTimeout(()=>a.addClass("visible"),10)}hideDragInsertIndicator(){let t=document.querySelector(".drag-insert-line");t&&t.remove()}async handleTaskReorder(t,e,s,a){try{console.log(`\u{1F4DD} \u91CD\u65B0\u6392\u5E8F: "${t.title}" -> "${e.title}"`);let n=s.getBoundingClientRect(),i=n.top+n.height/2,o=a>i;new g.Notice("\u{1F504} \u6B63\u5728\u91CD\u65B0\u6392\u5E8F...",1e3),this.currentGroupBy==="time"||this.currentGroupBy==="status"?this.reorderTasksInView(t,e,o):this.currentGroupBy==="project"?(t.projectId!==e.projectId&&await this.moveTaskToProject(t,e.projectId),this.reorderTasksInView(t,e,o)):this.reorderTasksInView(t,e,o),setTimeout(()=>{this.displaySmartGroups(),new g.Notice("\u2705 \u4EFB\u52A1\u6392\u5E8F\u5DF2\u66F4\u65B0")},300)}catch(n){console.error("\u274C \u91CD\u65B0\u6392\u5E8F\u5931\u8D25:",n),new g.Notice("\u274C \u91CD\u65B0\u6392\u5E8F\u5931\u8D25")}}reorderTasksInView(t,e,s){let a=this.allTasks.findIndex(l=>l.id===t.id),n=this.allTasks.findIndex(l=>l.id===e.id);if(a===-1||n===-1)return;let[i]=this.allTasks.splice(a,1),o=this.allTasks.findIndex(l=>l.id===e.id),c=s?o+1:o;this.allTasks.splice(c,0,i),console.log(`\u{1F4CA} \u4EFB\u52A1\u91CD\u65B0\u6392\u5E8F: \u4ECE\u4F4D\u7F6E ${a} \u79FB\u52A8\u5230 ${c}`)}async moveTaskToProject(t,e){try{await this.plugin.apiClient.updateTask(t.id,{projectId:e});let s=this.allProjects.find(a=>a.id===e);s&&(t.projectId=e,t.projectName=s.name,t.projectColor=s.color),console.log(`\u{1F4C1} \u4EFB\u52A1\u5DF2\u79FB\u52A8\u5230\u9879\u76EE: ${s==null?void 0:s.name}`)}catch(s){throw console.error("\u79FB\u52A8\u4EFB\u52A1\u5230\u9879\u76EE\u5931\u8D25:",s),s}}setupGroupDropEvents(t,e){let s=t.querySelector(".group-tasks");s&&(s.addEventListener("dragover",a=>{a.preventDefault(),a.dataTransfer&&(a.dataTransfer.dropEffect="move"),s.addClass("drop-target");let n=this.getDragAfterElement(s,a.clientY),i=document.querySelector(".drag-drop-indicator");i&&i.remove();let o=document.createElement("div");o.className="drag-drop-indicator",o.textContent="\u63D2\u5165\u5230\u8FD9\u91CC",n==null?s.appendChild(o):s.insertBefore(o,n)}),s.addEventListener("dragleave",a=>{if(!s.contains(a.relatedTarget)){s.removeClass("drop-target");let n=s.querySelector(".drag-drop-indicator");n&&n.remove()}}),s.addEventListener("drop",async a=>{var c;a.preventDefault();let n=(c=a.dataTransfer)==null?void 0:c.getData("text/plain");if(!n)return;s.removeClass("drop-target");let i=document.querySelector(".drag-drop-indicator");i&&i.remove();let o=this.allTasks.find(l=>l.id===n);if(o){console.log(`\u{1F4CB} \u4EFB\u52A1 "${o.title}" \u88AB\u62D6\u62FD\u5230\u5206\u7EC4 "${e}"`);try{await this.moveTaskToGroup(o,e),this.displaySmartGroups(),new g.Notice("\u2705 \u4EFB\u52A1\u5DF2\u79FB\u52A8\u5230\u65B0\u5206\u7EC4")}catch(l){console.error("\u79FB\u52A8\u4EFB\u52A1\u5931\u8D25:",l),new g.Notice("\u274C \u79FB\u52A8\u4EFB\u52A1\u5931\u8D25")}}}))}getDragAfterElement(t,e){return Array.from(t.querySelectorAll(".task-card:not(.dragging)")).reduce((n,i)=>{let o=i.getBoundingClientRect(),c=e-o.top-o.height/2;return c<0&&c>n.offset?{offset:c,element:i}:n},{offset:Number.NEGATIVE_INFINITY,element:null}).element}async moveTaskToGroup(t,e){switch(this.currentGroupBy){case"project":if(e!==t.projectId){await this.plugin.apiClient.updateTask(t.id,{projectId:e});let o=this.allProjects.find(c=>c.id===e);o&&(t.projectId=e,t.projectName=o.name)}break;case"status":let a={todo:0,"in-progress":1,completed:2}[e];a!==void 0&&a!==t.status&&(await this.plugin.apiClient.updateTask(t.id,{status:a}),t.status=a);break;case"priority":let i={"priority-none":0,"priority-low":1,"priority-medium":3,"priority-high":5}[e];i!==void 0&&i!==t.priority&&(await this.plugin.apiClient.updateTask(t.id,{priority:i}),t.priority=i);break;case"time":if(e==="today"){let o=new Date().toISOString().split("T")[0];await this.plugin.apiClient.updateTask(t.id,{dueDate:o}),t.dueDate=o}break}console.log(`\u{1F4DD} \u4EFB\u52A1 "${t.title}" \u5DF2\u79FB\u52A8\u5230\u5206\u7EC4 "${e}"`)}showEmptyState(t){let e=t.createEl("div",{cls:"empty-state"});e.createEl("div",{cls:"empty-icon",text:"\u{1F4DD}"}),e.createEl("h3",{cls:"empty-title",text:"\u8FD8\u6CA1\u6709\u4EFB\u52A1"}),e.createEl("p",{cls:"empty-description",text:'\u5728\u4E0B\u65B9\u8F93\u5165\u6846\u4E2D\u6DFB\u52A0\u60A8\u7684\u7B2C\u4E00\u4E2A\u4EFB\u52A1\uFF0C\u6216\u8005\u70B9\u51FB\u4E0A\u65B9\u7684"\u6DFB\u52A0\u4EFB\u52A1"\u6309\u94AE'})}async toggleTaskPriority(t){try{let e=0;switch(t.priority||0){case 0:e=1;break;case 1:e=3;break;case 3:e=5;break;case 5:e=0;break;default:e=1;break}let s=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);s&&this.updatePriorityVisual(s,e);let a=e===0?"\u53D6\u6D88\u4F18\u5148\u7EA7":e===1?"\u8BBE\u4E3A\u4F4E\u4F18\u5148\u7EA7":e===3?"\u8BBE\u4E3A\u4E2D\u4F18\u5148\u7EA7":"\u8BBE\u4E3A\u9AD8\u4F18\u5148\u7EA7";new g.Notice(`\u6B63\u5728${a}...`,1e3),await this.plugin.apiClient.updateTask(t.id,{priority:e}),t.priority=e,setTimeout(()=>{this.displaySmartGroups()},300),new g.Notice(`\u2728 \u5DF2${a}`)}catch(e){console.error("\u66F4\u65B0\u4EFB\u52A1\u4F18\u5148\u7EA7\u5931\u8D25:",e);let s=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);s&&this.updatePriorityVisual(s,t.priority),new g.Notice("\u274C \u66F4\u65B0\u4EFB\u52A1\u4F18\u5148\u7EA7\u5931\u8D25")}}updatePriorityVisual(t,e){t.removeClass("priority-high","priority-medium","priority-low"),e>=5?t.addClass("priority-high"):e>=3?t.addClass("priority-medium"):e>=1&&t.addClass("priority-low");let s=t.querySelector(".task-action-btn.star");s&&(s.textContent=e>=5?"\u2B50":"\u2606",s.style.transform="scale(1.2)",setTimeout(()=>{s.style.transform=""},150))}async handleTaskToggle(t,e){try{let s=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);s&&this.updateTaskCardVisual(s,t,e),new g.Notice(e?"\u6B63\u5728\u6807\u8BB0\u5B8C\u6210...":"\u6B63\u5728\u6807\u8BB0\u672A\u5B8C\u6210...",1e3),await this.plugin.apiClient.updateTask(t.id,{status:e?2:0}),t.status=e?2:0,setTimeout(()=>{this.displaySmartGroups(),this.updateStats()},500),new g.Notice(e?"\u2705 \u4EFB\u52A1\u5DF2\u5B8C\u6210":"\u21A9\uFE0F \u4EFB\u52A1\u5DF2\u6807\u8BB0\u4E3A\u672A\u5B8C\u6210",2e3)}catch(s){console.error("\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u5931\u8D25:",s);let a=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);if(a){this.updateTaskCardVisual(a,t,!e);let n=a.querySelector(".task-checkbox");n&&(n.checked=!e)}new g.Notice("\u274C \u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u5931\u8D25")}}updateTaskCardVisual(t,e,s){let a=t.querySelector(".task-title");s?(t.addClass("completed"),a==null||a.addClass("completed"),t.style.transform="scale(1.02)",setTimeout(()=>{t.style.transform=""},200)):(t.removeClass("completed"),a==null||a.removeClass("completed"))}openTaskDetail(t){this.openFullTaskEditModal(t)}openFullTaskEditModal(t){let e=document.createElement("div");e.className="task-edit-modal-overlay";let s=document.createElement("div");s.className="task-edit-modal";let a=document.createElement("div");a.className="modal-header";let n=document.createElement("h3");n.textContent=t.id?"\u7F16\u8F91\u4EFB\u52A1":"\u65B0\u5EFA\u4EFB\u52A1",n.className="modal-title";let i=document.createElement("button");i.className="modal-close-btn",i.textContent="\xD7",a.appendChild(n),a.appendChild(i);let o=document.createElement("form");o.className="task-edit-form";let c=document.createElement("div");c.className="form-group";let l=document.createElement("label");l.textContent="\u4EFB\u52A1\u6807\u9898",l.className="form-label";let d=document.createElement("input");d.type="text",d.value=t.title||"",d.className="form-input",d.placeholder="\u8F93\u5165\u4EFB\u52A1\u6807\u9898...",d.required=!0,c.appendChild(l),c.appendChild(d);let p=document.createElement("div");p.className="form-group";let u=document.createElement("label");u.textContent="\u4EFB\u52A1\u63CF\u8FF0",u.className="form-label";let m=document.createElement("textarea");m.value=t.content||"",m.className="form-textarea",m.placeholder="\u8F93\u5165\u4EFB\u52A1\u63CF\u8FF0...",m.rows=4,p.appendChild(u),p.appendChild(m);let v=document.createElement("div");v.className="form-group";let D=document.createElement("label");D.textContent="\u622A\u6B62\u65E5\u671F",D.className="form-label";let E=document.createElement("input");if(E.type="date",E.className="form-input",t.dueDate){let y=new Date(t.dueDate);E.value=y.toISOString().split("T")[0]}v.appendChild(D),v.appendChild(E);let F=document.createElement("div");F.className="form-group";let C=document.createElement("label");C.textContent="\u4F18\u5148\u7EA7",C.className="form-label";let H=document.createElement("select");H.className="form-select",[{value:0,text:"\u65E0\u4F18\u5148\u7EA7",icon:"\u26AA"},{value:1,text:"\u4F4E\u4F18\u5148\u7EA7",icon:"\u{1F535}"},{value:3,text:"\u4E2D\u4F18\u5148\u7EA7",icon:"\u{1F7E1}"},{value:5,text:"\u9AD8\u4F18\u5148\u7EA7",icon:"\u{1F534}"}].forEach(y=>{let w=document.createElement("option");w.value=y.value.toString(),w.textContent=`${y.icon} ${y.text}`,(t.priority||0)===y.value&&(w.selected=!0),H.appendChild(w)}),F.appendChild(C),F.appendChild(H);let W=document.createElement("div");W.className="form-group";let lt=document.createElement("label");lt.textContent="\u6240\u5C5E\u9879\u76EE",lt.className="form-label";let q=document.createElement("select");q.className="form-select",this.allProjects.forEach(y=>{if(!y.closed){let w=document.createElement("option");w.value=y.id,w.textContent=`\u{1F4C1} ${y.name}`,t.projectId===y.id&&(w.selected=!0),q.appendChild(w)}}),W.appendChild(lt),W.appendChild(q);let X=document.createElement("div");X.className="form-group";let dt=document.createElement("label");dt.textContent="\u6807\u7B7E",dt.className="form-label";let N=document.createElement("input");N.type="text",N.className="form-input",N.placeholder="\u8F93\u5165\u6807\u7B7E\uFF0C\u7528\u9017\u53F7\u5206\u9694...",t.tags&&t.tags.length>0&&(N.value=t.tags.join(", ")),X.appendChild(dt),X.appendChild(N);let K=document.createElement("div");K.className="form-group";let pt=document.createElement("label");pt.textContent="\u72B6\u6001",pt.className="form-label";let J=document.createElement("select");J.className="form-select",[{value:0,text:"\u5F85\u529E\u4E8B\u9879",icon:"\u{1F4DD}"},{value:1,text:"\u8FDB\u884C\u4E2D",icon:"\u{1F504}"},{value:2,text:"\u5DF2\u5B8C\u6210",icon:"\u2705"}].forEach(y=>{let w=document.createElement("option");w.value=y.value.toString(),w.textContent=`${y.icon} ${y.text}`,(t.status||0)===y.value&&(w.selected=!0),J.appendChild(w)}),K.appendChild(pt),K.appendChild(J),o.appendChild(c),o.appendChild(p),o.appendChild(v),o.appendChild(F),o.appendChild(W),o.appendChild(X),o.appendChild(K);let R=document.createElement("div");R.className="modal-buttons";let V=document.createElement("button");V.type="button",V.className="btn btn-cancel",V.textContent="\u53D6\u6D88";let O=document.createElement("button");if(O.type="submit",O.className="btn btn-primary",O.textContent="\u4FDD\u5B58",R.appendChild(V),R.appendChild(O),t.id){let y=document.createElement("button");y.type="button",y.className="btn btn-danger",y.textContent="\u5220\u9664\u4EFB\u52A1",y.addEventListener("click",async w=>{if(w.preventDefault(),confirm(`\u786E\u5B9A\u8981\u5220\u9664\u4EFB\u52A1 "${t.title}" \u5417\uFF1F`))try{await this.plugin.apiClient.deleteTask(t.id);let j=this.allTasks.findIndex(I=>I.id===t.id);j!==-1&&this.allTasks.splice(j,1),e.remove(),this.displaySmartGroups(),this.updateStats(),new g.Notice("\u2705 \u4EFB\u52A1\u5DF2\u5220\u9664")}catch(j){console.error("\u5220\u9664\u4EFB\u52A1\u5931\u8D25:",j),new g.Notice("\u274C \u5220\u9664\u4EFB\u52A1\u5931\u8D25")}}),R.appendChild(y)}o.appendChild(R),s.appendChild(a),s.appendChild(o),e.appendChild(s),i.addEventListener("click",()=>{e.remove()}),V.addEventListener("click",()=>{e.remove()}),e.addEventListener("click",y=>{y.target===e&&e.remove()});let yt=y=>{y.key==="Escape"&&(e.remove(),document.removeEventListener("keydown",yt))};document.addEventListener("keydown",yt),o.addEventListener("submit",async y=>{y.preventDefault(),console.log("\u{1F514} \u8868\u5355\u63D0\u4EA4\u4E8B\u4EF6\u5DF2\u89E6\u53D1\uFF01");let w=d.value.trim();if(!w){console.warn("\u26A0\uFE0F \u4EFB\u52A1\u6807\u9898\u4E3A\u7A7A"),d.focus(),d.style.borderColor="#FF4757";return}let j=q.value;if(!j){console.warn("\u26A0\uFE0F \u672A\u9009\u62E9\u9879\u76EE"),q.focus(),q.style.borderColor="#FF4757";return}console.log("\u2705 \u8868\u5355\u9A8C\u8BC1\u901A\u8FC7\uFF0C\u51C6\u5907\u4FDD\u5B58...");try{O.disabled=!0,O.textContent="\u4FDD\u5B58\u4E2D...";let I={title:w,content:m.value.trim(),projectId:j,status:parseInt(J.value),priority:parseInt(H.value)};E.value?I.dueDate=E.value:I.dueDate=null,N.value.trim()?I.tags=N.value.split(",").map(k=>k.trim()).filter(k=>k):I.tags=[],console.log("\u{1F4DD} \u51C6\u5907\u4FDD\u5B58\u4EFB\u52A1\uFF0C\u6570\u636E:",I);let P;if(t.id){console.log("\u270F\uFE0F \u66F4\u65B0\u4EFB\u52A1:",t.id,"\u539F\u9879\u76EE:",t.projectId,"\u65B0\u9879\u76EE:",j),P=await this.plugin.apiClient.updateTask(t.id,I),Object.assign(t,P);let k=j,T=P.projectId;console.log("\u{1F50D} \u9879\u76EEID\u68C0\u67E5:"),console.log("  \u7528\u6237\u9009\u62E9\u7684projectId:",k),console.log("  API\u8FD4\u56DE\u7684projectId:",T),console.log("  \u4EFB\u52A1\u5F53\u524DprojectId:",t.projectId);let x=null;try{T&&(x=this.allProjects.find(L=>L.id===T),x&&console.log("\u2705 \u7528API\u8FD4\u56DEID\u627E\u5230\u9879\u76EE:",x.name)),!x&&(k.includes("inbox")||T.includes("inbox")||k==="inbox")&&(x=this.allProjects.find(L=>L.name==="\u6536\u96C6\u7BB1"||L.name.toLowerCase().includes("inbox")||L.id==="inbox"||L.id&&L.id.includes("inbox")||L.kind==="INBOX"),x&&console.log("\u{1F4E5} \u6536\u96C6\u7BB1\u7279\u6B8A\u5904\u7406\u6210\u529F\uFF0C\u627E\u5230\u9879\u76EE:",x.name,"ID:",x.id)),!x&&(k.includes("\u751F\u65E5\u63D0\u9192")||T.includes("\u751F\u65E5\u63D0\u9192"))&&(x=this.allProjects.find(L=>L.name==="\u{1F382}\u751F\u65E5\u63D0\u9192"||L.name.includes("\u751F\u65E5\u63D0\u9192")||L.name.toLowerCase().includes("birthday")),x&&console.log("\u{1F382} \u751F\u65E5\u63D0\u9192\u7279\u6B8A\u5904\u7406\u6210\u529F\uFF0C\u627E\u5230\u9879\u76EE:",x.name)),!x&&k&&(x=this.allProjects.find(L=>L.id===k),x&&console.log("\u{1F50D} \u7528\u7528\u6237\u9009\u62E9ID\u627E\u5230\u9879\u76EE:",x.name)),x?(t.projectId=T,t.projectName=x.name,t.projectColor=x.color,console.log("\u2705 \u4EFB\u52A1\u9879\u76EE\u4FE1\u606F\u5DF2\u66F4\u65B0:"),console.log("  \u9879\u76EE\u540D\u79F0:",x.name),console.log("  \u771F\u5B9EID:",T),console.log("  \u663E\u793AID:",x.id)):(console.warn("\u26A0\uFE0F \u627E\u4E0D\u5230\u5339\u914D\u7684\u9879\u76EE\u4FE1\u606F\uFF0C\u4F7F\u7528API\u8FD4\u56DE\u503C"),console.warn("  API\u8FD4\u56DE\u7684projectId:",T),console.warn("  \u7528\u6237\u9009\u62E9\u7684projectId:",k),t.projectId=T,T.includes("inbox")?t.projectName="\u6536\u96C6\u7BB1":T.includes("\u751F\u65E5\u63D0\u9192")||T.includes("birthday")?t.projectName="\u{1F382}\u751F\u65E5\u63D0\u9192":t.projectName=`\u672A\u77E5\u9879\u76EE (${T})`,console.log("\u{1F4C1} \u4F7F\u7528\u63A8\u65AD\u7684\u9879\u76EE\u540D:",t.projectName))}catch(L){console.error("\u274C \u9879\u76EE\u4FE1\u606F\u5904\u7406\u51FA\u9519:",L),t.projectId=T,t.projectName=t.projectName||"\u672A\u77E5\u9879\u76EE"}console.log("\u2705 \u4EFB\u52A1\u66F4\u65B0\u6210\u529F:",P)}else{console.log("\u2795 \u521B\u5EFA\u65B0\u4EFB\u52A1"),P=await this.plugin.apiClient.createTask(I);let k=this.allProjects.find(T=>T.id===j);k&&(P.projectId=j,P.projectName=k.name,P.projectColor=k.color),this.allTasks.unshift(P),console.log("\u2705 \u4EFB\u52A1\u521B\u5EFA\u6210\u529F:",P)}e.remove(),console.log("\u{1F504} \u5F00\u59CB\u5237\u65B0\u754C\u9762...");try{this.clearDragStyles(),await new Promise(k=>{setTimeout(async()=>{try{this.displaySmartGroups(),console.log("\u2705 \u667A\u80FD\u5206\u7EC4\u5237\u65B0\u5B8C\u6210"),this.updateStats(),console.log("\u2705 \u7EDF\u8BA1\u4FE1\u606F\u66F4\u65B0\u5B8C\u6210"),k(void 0)}catch(T){console.error("\u274C \u754C\u9762\u5237\u65B0\u51FA\u9519:",T),k(void 0)}},100)}),console.log("\u2705 \u754C\u9762\u5237\u65B0\u5B8C\u6210")}catch(k){console.error("\u274C \u754C\u9762\u5237\u65B0\u5931\u8D25:",k)}new g.Notice(t.id?"\u2705 \u4EFB\u52A1\u5DF2\u66F4\u65B0":"\u2705 \u4EFB\u52A1\u5DF2\u521B\u5EFA")}catch(I){console.error("\u274C \u4FDD\u5B58\u4EFB\u52A1\u5931\u8D25:",I),console.error("\u9519\u8BEF\u8BE6\u60C5:",{message:I.message,stack:I.stack}),O.disabled=!1,O.textContent="\u4FDD\u5B58",new g.Notice(`\u274C \u4FDD\u5B58\u4EFB\u52A1\u5931\u8D25: ${I.message}`,5e3)}}),document.body.appendChild(e),setTimeout(()=>{d.focus(),d.select()},100)}confirmDeleteTask(t){confirm(`\u786E\u5B9A\u8981\u5220\u9664\u4EFB\u52A1 "${t.title}" \u5417\uFF1F`)&&this.deleteTask(t)}async deleteTask(t){try{let e=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);e&&(e.style.transition="all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1)",e.style.transform="translateX(-100%)",e.style.opacity="0"),new g.Notice("\u{1F5D1}\uFE0F \u6B63\u5728\u5220\u9664\u4EFB\u52A1...",1e3),await this.plugin.apiClient.deleteTask(t.id);let s=this.allTasks.findIndex(a=>a.id===t.id);s!==-1&&this.allTasks.splice(s,1),setTimeout(()=>{this.displaySmartGroups(),this.updateStats()},400),new g.Notice("\u2705 \u4EFB\u52A1\u5DF2\u5220\u9664")}catch(e){console.error("\u5220\u9664\u4EFB\u52A1\u5931\u8D25:",e);let s=this.containerEl.querySelector(`[data-task-id="${t.id}"]`);s&&(s.style.transform="",s.style.opacity=""),new g.Notice("\u274C \u5220\u9664\u4EFB\u52A1\u5931\u8D25")}}async handleGroupByChange(t){console.log(`\u{1F504} \u5207\u6362\u5206\u7EC4\u65B9\u5F0F: ${this.currentGroupBy} -> ${t}`),this.currentGroupBy=t,this.collapsedGroups.clear(),this.currentActiveGroupId=null,this.plugin.settings.viewSettings.lastGroupBy=this.currentGroupBy,await this.plugin.saveSettings(),console.log(`\u{1F4BE} \u5DF2\u4FDD\u5B58\u5206\u7EC4\u65B9\u5F0F: ${this.currentGroupBy}`),this.displaySmartGroups(),new g.Notice(`\u5DF2\u5207\u6362\u5230${this.getGroupByName(t)}`)}getGroupByName(t){switch(t){case"time":return"\u65F6\u95F4\u5206\u7EC4";case"project":return"\u9879\u76EE\u5206\u7EC4";case"status":return"\u72B6\u6001\u5206\u7EC4";case"priority":return"\u4F18\u5148\u7EA7\u5206\u7EC4";default:return"\u9ED8\u8BA4\u5206\u7EC4"}}handleFilterChange(t){console.log(`\u{1F504} \u5207\u6362\u7B5B\u9009\u5668: ${this.currentFilter} -> ${t}`),this.currentFilter=t,this.containerEl.querySelectorAll(".filter-chip").forEach(s=>{s.getAttribute("data-filter")===t?s.addClass("active"):s.removeClass("active")}),this.displaySmartGroups(),new g.Notice(`\u5DF2\u5207\u6362\u5230\u7B5B\u9009\u5668\uFF1A${this.getFilterName(t)}`)}getFilterName(t){return{all:"\u5168\u90E8\u4EFB\u52A1",today:"\u4ECA\u5929",upcoming:"\u5373\u5C06\u5230\u671F",overdue:"\u5DF2\u903E\u671F",completed:"\u5DF2\u5B8C\u6210","high-priority":"\u9AD8\u4F18\u5148\u7EA7"}[t]||"\u672A\u77E5\u7B5B\u9009\u5668"}handleSearch(t){this.searchQuery=t,this.displaySmartGroups()}focusQuickAdd(){let t=this.containerEl.querySelector(".quick-add-form");t&&(t.hasClass("collapsed")?(t.removeClass("collapsed"),setTimeout(()=>{this.quickAddInput&&(this.quickAddInput.focus(),t.scrollIntoView({behavior:"smooth",block:"nearest"}))},100)):t.addClass("collapsed"))}handleQuickAddKeydown(t){this.handleSuggestionsKeyboard(t);let e=this.containerEl.querySelector(".smart-suggestions-container");e&&e.style.display!=="none"&&["ArrowDown","ArrowUp","Tab","Escape"].includes(t.key)||t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.addTaskFromQuickAdd())}async addTaskFromQuickAdd(){let t=this.quickAddInput;if(!(!t||!t.value.trim()))try{let e=t.value.trim(),s=$.parseTask(e),a=$.validateParsedTask(s);if(!a.isValid){new g.Notice(`\u274C ${a.errors[0]}`);return}console.log("\u{1F9E0} \u667A\u80FD\u89E3\u6790\u7ED3\u679C:",s);let n;if(s.projectName){let c=this.allProjects.find(l=>l.name.toLowerCase().includes(s.projectName.toLowerCase()));c?(n=c.id,console.log(`\u{1F4C1} \u627E\u5230\u5339\u914D\u9879\u76EE: ${c.name}`)):new g.Notice(`\u{1F4C1} \u672A\u627E\u5230\u9879\u76EE"${s.projectName}"\uFF0C\u4EFB\u52A1\u5C06\u8FDB\u5165\u6536\u96C6\u7BB1`)}if(!n){let c=this.allProjects.find(l=>l.name==="\u6536\u96C6\u7BB1"||l.name.toLowerCase()==="inbox");if(c)n=c.id,console.log(`\u{1F4E5} \u4F7F\u7528\u6536\u96C6\u7BB1\u9879\u76EE: ${c.name}`);else{let d=this.allProjects.filter(p=>!p.closed).sort((p,u)=>{var D,E;let m=(D=p.sortOrder)!=null?D:-999999;return((E=u.sortOrder)!=null?E:-999999)-m})[0];d&&(n=d.id,console.log(`\u{1F4C1} \u672A\u627E\u5230\u6536\u96C6\u7BB1\uFF0C\u4F7F\u7528\u7B2C\u4E00\u4E2A\u9879\u76EE: ${d.name}`))}}if(!n){new g.Notice("\u274C \u6CA1\u6709\u53EF\u7528\u7684\u9879\u76EE");return}let i={title:s.title,projectId:n,status:0};s.priority&&s.priority>0&&(i.priority=s.priority),s.dueDate&&(i.dueDate=s.dueDate),s.tags&&s.tags.length>0&&(i.tags=s.tags),s.content&&(i.content=s.content),t.disabled=!0,t.placeholder="\u6B63\u5728\u6DFB\u52A0\u4EFB\u52A1...",new g.Notice("\u{1F4DD} \u6B63\u5728\u6DFB\u52A0\u4EFB\u52A1...",1e3);let o=await this.plugin.apiClient.createTask(i);o.projectId=n,o.projectName=this.allProjects[0].name,this.allTasks.unshift(o),t.value="",t.disabled=!1,t.placeholder="\u8F93\u5165\u4EFB\u52A1\u5185\u5BB9\uFF0C\u6309 Enter \u6DFB\u52A0...",this.resetAddOptions(),this.autoResizeTextarea(),this.displaySmartGroups(),this.updateStats(),setTimeout(()=>{let c=this.containerEl.querySelector(`[data-task-id="${o.id}"]`);c&&(c.style.background="rgba(74, 144, 251, 0.1)",c.style.transform="scale(1.02)",setTimeout(()=>{c.style.background="",c.style.transform=""},1e3))},100),new g.Notice("\u2705 \u4EFB\u52A1\u5DF2\u6DFB\u52A0")}catch(e){console.error("\u6DFB\u52A0\u4EFB\u52A1\u5931\u8D25:",e),t&&(t.disabled=!1,t.placeholder="\u8F93\u5165\u4EFB\u52A1\u5185\u5BB9\uFF0C\u6309 Enter \u6DFB\u52A0..."),new g.Notice("\u274C \u6DFB\u52A0\u4EFB\u52A1\u5931\u8D25")}}resetAddOptions(){this.containerEl.querySelectorAll(".add-option-btn").forEach(e=>e.removeClass("active"))}autoResizeTextarea(){if(!this.quickAddInput)return;this.quickAddInput.style.height="auto";let t=this.quickAddInput.scrollHeight,e=100;this.quickAddInput.style.height=`${Math.min(t,e)}px`}handleAddOptionClick(t){let s=t.target.closest(".add-option-btn");if(!s)return;let a=s.getAttribute("data-option");s.hasClass("active")?(s.removeClass("active"),this.removeAddOption(a)):(s.addClass("active"),this.showAddOption(a))}showAddOption(t){if(!t||!this.quickAddInput)return;let e=this.quickAddInput.value,s=e;switch(t){case"priority":e.includes(" !!")||(s+=" !!");break;case"due-date":let a=new Date;a.setDate(a.getDate()+1);let n=a.toISOString().split("T")[0];e.includes("@")||(s+=` @${n}`);break;case"tags":e.includes("#")||(s+=" #\u6807\u7B7E");break}this.quickAddInput.value=s,this.quickAddInput.focus(),this.quickAddInput.selectionStart=this.quickAddInput.selectionEnd=s.length}removeAddOption(t){if(!t||!this.quickAddInput)return;let e=this.quickAddInput.value;switch(t){case"priority":e=e.replace(/ !!+/g,"");break;case"due-date":e=e.replace(/ @[\d-]+/g,"");break;case"tags":e=e.replace(/ #[^\s]+/g,"");break}this.quickAddInput.value=e.trim()}formatDueDate(t){let e=new Date,s=new Date(e);s.setDate(e.getDate()+1);let a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()),i=new Date(s.getFullYear(),s.getMonth(),s.getDate());return a.getTime()===n.getTime()?"\u4ECA\u5929":a.getTime()===i.getTime()?"\u660E\u5929":t.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}getDueDateClass(t){let e=new Date,s=new Date(e.getFullYear(),e.getMonth(),e.getDate()),a=new Date(t.getFullYear(),t.getMonth(),t.getDate());return a.getTime()<s.getTime()?"overdue":a.getTime()===s.getTime()?"today":""}async refreshTasks(){await this.loadAndDisplayTasks(),new g.Notice("\u4EFB\u52A1\u5DF2\u5237\u65B0")}createSubtasksSection(t,e){let s=t.createEl("div",{cls:"task-subtasks-container"}),a=s.createEl("div",{cls:"subtasks-header"}),n=e.items.filter(u=>u.status===2).length,i=e.items.length,o=a.createEl("button",{cls:"subtasks-toggle",text:`\u25BC ${i} \u4E2A\u5B50\u4EFB\u52A1`}),c=a.createEl("div",{cls:"subtask-progress-container"}),l=c.createEl("span",{cls:"subtask-progress",text:`${n}/${i}`});if(i>0){let m=c.createEl("div",{cls:"subtask-progress-bar-bg"}).createEl("div",{cls:"subtask-progress-bar"}),v=n/i*100;m.style.width=`${v}%`}let d=s.createEl("div",{cls:"subtasks-list"});e.items.forEach(u=>{this.createSubtaskItem(d,u,e.id)});let p=s.createEl("button",{cls:"add-subtask-btn",text:"+ \u6DFB\u52A0\u5B50\u4EFB\u52A1"});o.addEventListener("click",u=>{u.stopPropagation(),this.toggleSubtasks(d,o)}),p.addEventListener("click",u=>{u.stopPropagation(),this.showAddSubtaskInput(s,e)})}createSubtaskItem(t,e,s){let a=t.createEl("div",{cls:"subtask-item"});a.setAttribute("data-subtask-id",e.id);let i=a.createEl("div",{cls:"subtask-checkbox-wrapper"}).createEl("input",{cls:"subtask-checkbox",type:"checkbox"});i.checked=e.status===2;let c=a.createEl("div",{cls:"subtask-title-container"}).createEl("span",{cls:`subtask-title ${e.status===2?"completed":""}`,text:e.title}),l=a.createEl("div",{cls:"subtask-actions"}),d=l.createEl("button",{cls:"subtask-action-btn edit",text:"\u270F\uFE0F",attr:{title:"\u7F16\u8F91\u5B50\u4EFB\u52A1"}}),p=l.createEl("button",{cls:"subtask-action-btn delete",text:"\u{1F5D1}\uFE0F",attr:{title:"\u5220\u9664\u5B50\u4EFB\u52A1"}});i.addEventListener("change",u=>{u.stopPropagation(),this.toggleSubtaskStatus(e,s,i.checked)}),d.addEventListener("click",u=>{u.stopPropagation(),this.editSubtaskInline(a,e,s)}),p.addEventListener("click",u=>{u.stopPropagation(),this.deleteSubtask(e,s)}),c.addEventListener("dblclick",u=>{u.stopPropagation(),this.editSubtaskInline(a,e,s)})}toggleSubtasks(t,e){var a,n;t.hasClass("collapsed")?(t.removeClass("collapsed"),e.textContent=((a=e.textContent)==null?void 0:a.replace("\u25B6","\u25BC"))||""):(t.addClass("collapsed"),e.textContent=((n=e.textContent)==null?void 0:n.replace("\u25BC","\u25B6"))||"")}async toggleSubtaskStatus(t,e,s){try{let a=this.containerEl.querySelector(`[data-subtask-id="${t.id}"]`),n=a==null?void 0:a.querySelector(".subtask-title");s?n==null||n.addClass("completed"):n==null||n.removeClass("completed"),new g.Notice(s?"\u6B63\u5728\u6807\u8BB0\u5B50\u4EFB\u52A1\u5B8C\u6210...":"\u6B63\u5728\u6807\u8BB0\u5B50\u4EFB\u52A1\u672A\u5B8C\u6210...",1e3),await this.plugin.apiClient.updateTask(t.id,{status:s?2:0}),t.status=s?2:0,this.updateParentTaskProgress(e),new g.Notice(s?"\u2705 \u5B50\u4EFB\u52A1\u5DF2\u5B8C\u6210":"\u21A9\uFE0F \u5B50\u4EFB\u52A1\u5DF2\u6807\u8BB0\u4E3A\u672A\u5B8C\u6210")}catch(a){console.error("\u66F4\u65B0\u5B50\u4EFB\u52A1\u72B6\u6001\u5931\u8D25:",a);let n=this.containerEl.querySelector(`[data-subtask-id="${t.id}"]`),i=n==null?void 0:n.querySelector(".subtask-checkbox");i&&(i.checked=!s);let o=n==null?void 0:n.querySelector(".subtask-title");s?o==null||o.removeClass("completed"):o==null||o.addClass("completed"),new g.Notice("\u274C \u66F4\u65B0\u5B50\u4EFB\u52A1\u72B6\u6001\u5931\u8D25")}}editSubtaskInline(t,e,s){var c;let a=t.querySelector(".subtask-title");if(!a||a.style.display==="none")return;let n=document.createElement("input");n.type="text",n.value=e.title,n.className="subtask-title-input",a.style.display="none",(c=a.parentNode)==null||c.insertBefore(n,a),n.focus(),n.select();let i=async()=>{let l=n.value.trim();if(!l||l===e.title){o();return}try{n.disabled=!0,await this.plugin.apiClient.updateTask(e.id,{title:l}),e.title=l,a.textContent=l,a.style.display="",n.remove(),new g.Notice("\u2705 \u5B50\u4EFB\u52A1\u5DF2\u66F4\u65B0")}catch(d){console.error("\u66F4\u65B0\u5B50\u4EFB\u52A1\u5931\u8D25:",d),n.disabled=!1,new g.Notice("\u274C \u66F4\u65B0\u5B50\u4EFB\u52A1\u5931\u8D25")}},o=()=>{a.style.display="",n.remove()};n.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),i()):l.key==="Escape"&&(l.preventDefault(),o())}),n.addEventListener("blur",i)}showAddSubtaskInput(t,e){let s=t.querySelector(".add-subtask-input");if(s){s.focus();return}let a=t.createEl("div",{cls:"add-subtask-container"}),n=a.createEl("input",{cls:"add-subtask-input",type:"text",attr:{placeholder:"\u8F93\u5165\u5B50\u4EFB\u52A1\u5185\u5BB9..."}}),i=a.createEl("div",{cls:"add-subtask-buttons"}),o=i.createEl("button",{cls:"btn btn-primary btn-sm",text:"\u6DFB\u52A0"}),c=i.createEl("button",{cls:"btn btn-secondary btn-sm",text:"\u53D6\u6D88"});n.focus();let l=async()=>{let p=n.value.trim();if(!p){n.focus();return}try{o.disabled=!0,o.textContent="\u6DFB\u52A0\u4E2D...";let u=await this.plugin.apiClient.createTask({title:p,projectId:e.projectId,parentId:e.id,status:0});e.items||(e.items=[]),e.items.push(u),a.remove();let m=this.containerEl.querySelector(`[data-task-id="${e.id}"]`);if(m){let v=m.querySelector(".task-subtasks-container");if(v){v.remove();let D=m.querySelector(".task-main-content");D&&this.createSubtasksSection(D,e)}}new g.Notice("\u2705 \u5B50\u4EFB\u52A1\u5DF2\u6DFB\u52A0")}catch(u){console.error("\u6DFB\u52A0\u5B50\u4EFB\u52A1\u5931\u8D25:",u),o.disabled=!1,o.textContent="\u6DFB\u52A0",new g.Notice("\u274C \u6DFB\u52A0\u5B50\u4EFB\u52A1\u5931\u8D25")}},d=()=>{a.remove()};n.addEventListener("keydown",p=>{p.key==="Enter"?(p.preventDefault(),l()):p.key==="Escape"&&(p.preventDefault(),d())}),o.addEventListener("click",l),c.addEventListener("click",d)}async deleteSubtask(t,e){if(confirm(`\u786E\u5B9A\u8981\u5220\u9664\u5B50\u4EFB\u52A1 "${t.title}" \u5417\uFF1F`))try{let s=this.containerEl.querySelector(`[data-subtask-id="${t.id}"]`);s&&(s.style.transition="all 0.3s ease",s.style.opacity="0",s.style.transform="translateX(-100%)"),new g.Notice("\u{1F5D1}\uFE0F \u6B63\u5728\u5220\u9664\u5B50\u4EFB\u52A1...",1e3),await this.plugin.apiClient.deleteTask(t.id);let a=this.allTasks.find(n=>n.id===e);if(a&&a.items){let n=a.items.findIndex(i=>i.id===t.id);n!==-1&&a.items.splice(n,1)}setTimeout(()=>{if(s&&s.remove(),this.updateParentTaskProgress(e),a&&(!a.items||a.items.length===0)){let n=this.containerEl.querySelector(`[data-task-id="${e}"]`);if(n){let i=n.querySelector(".task-subtasks-container");i&&i.remove()}}},300),new g.Notice("\u2705 \u5B50\u4EFB\u52A1\u5DF2\u5220\u9664")}catch(s){console.error("\u5220\u9664\u5B50\u4EFB\u52A1\u5931\u8D25:",s);let a=this.containerEl.querySelector(`[data-subtask-id="${t.id}"]`);a&&(a.style.opacity="",a.style.transform=""),new g.Notice("\u274C \u5220\u9664\u5B50\u4EFB\u52A1\u5931\u8D25")}}updateParentTaskProgress(t){var i;let e=this.allTasks.find(o=>o.id===t);if(!e||!e.items)return;let s=e.items.filter(o=>o.status===2).length,a=e.items.length,n=this.containerEl.querySelector(`[data-task-id="${t}"]`);if(n){let o=n.querySelector(".subtask-progress");o&&(o.textContent=`${s}/${a}`);let c=n.querySelector(".subtask-progress-bar");if(c){let d=a>0?s/a*100:0;c.style.width=`${d}%`}let l=n.querySelector(".subtasks-toggle");if(l){let p=((i=l.textContent)==null?void 0:i.includes("\u25B6"))?"\u25B6":"\u25BC";l.textContent=`${p} ${a} \u4E2A\u5B50\u4EFB\u52A1`}}}showSmartSuggestions(){if(!this.quickAddInput)return;let t=this.quickAddInput.value.trim();if(!t){this.hideSuggestions();return}let e=$.getSuggestions(t),s=this.getProjectSuggestions(t);e.push(...s);let a=this.getTagSuggestions(t);e.push(...a),e.length>0?this.displaySuggestions(e):this.hideSuggestions()}getProjectSuggestions(t){return!t.includes("\u9879\u76EE")&&!t.includes("[")?[]:this.allProjects.filter(e=>!e.closed).map(e=>`[${e.name}]`).slice(0,3)}getTagSuggestions(t){return!t.includes("#")&&!t.includes("\u6807\u7B7E")?[]:["\u5DE5\u4F5C","\u5B66\u4E60","\u751F\u6D3B","\u5065\u5EB7","\u8D2D\u7269","\u9605\u8BFB","\u4F1A\u8BAE","\u63D0\u9192"].map(s=>`#${s}`).slice(0,4)}displaySuggestions(t){let e=this.containerEl.querySelector(".smart-suggestions-container");if(!e)return;e.innerHTML="",e.style.display="block";let s=e.createEl("div",{cls:"suggestions-list"}),a=s.createEl("div",{cls:"suggestions-title",text:"\u{1F9E0} \u667A\u80FD\u5EFA\u8BAE"});t.slice(0,5).forEach((o,c)=>{let l=s.createEl("div",{cls:"suggestion-item",text:o});l.addEventListener("click",()=>{this.applySuggestion(o)}),l.setAttribute("data-index",c.toString())});let n=s.createEl("div",{cls:"suggestions-examples"});n.createEl("div",{cls:"examples-title",text:"\u{1F4A1} \u793A\u4F8B\u683C\u5F0F:"}),["\u660E\u5929\u4E0B\u5348\u5F00\u4F1A #\u5DE5\u4F5C !!","\u4E70\u83DC \u4ECA\u665A7\u70B9\u524D [\u751F\u6D3B]","\u5B66\u4E60\u82F1\u8BED \u4E0B\u5468\u4E00 @\u5B66\u4E60\u8BA1\u5212"].forEach(o=>{n.createEl("div",{cls:"example-item",text:o}).addEventListener("click",()=>{this.quickAddInput&&(this.quickAddInput.value=o,this.quickAddInput.focus(),this.autoResizeTextarea(),this.hideSuggestions())})})}applySuggestion(t){if(!this.quickAddInput)return;let e=this.quickAddInput.value;this.quickAddInput.value=e+" "+t,this.quickAddInput.focus(),this.quickAddInput.selectionStart=this.quickAddInput.selectionEnd=this.quickAddInput.value.length,this.autoResizeTextarea(),this.hideSuggestions()}hideSuggestions(){let t=this.containerEl.querySelector(".smart-suggestions-container");t&&(t.style.display="none")}handleSuggestionsKeyboard(t){let e=this.containerEl.querySelector(".smart-suggestions-container");if(!e||e.style.display==="none")return;let s=e.querySelectorAll(".suggestion-item");if(s.length===0)return;let a=-1,n=e.querySelector(".suggestion-item.active");switch(n&&(a=parseInt(n.getAttribute("data-index")||"-1")),t.key){case"ArrowDown":t.preventDefault(),a=Math.min(a+1,s.length-1),this.highlightSuggestion(a);break;case"ArrowUp":t.preventDefault(),a=Math.max(a-1,0),this.highlightSuggestion(a);break;case"Tab":case"Enter":n&&(t.preventDefault(),this.applySuggestion(n.textContent||""));break;case"Escape":t.preventDefault(),this.hideSuggestions();break}}highlightSuggestion(t){let e=this.containerEl.querySelector(".smart-suggestions-container");if(!e)return;e.querySelectorAll(".suggestion-item").forEach((a,n)=>{n===t?a.addClass("active"):a.removeClass("active")})}async onClose(){}};var Y=require("obsidian");var A=class{static parseMarkdownTasks(r){let t=[],e=r.split(`
`);for(let s=0;s<e.length;s++){let n=e[s].match(/^(\s*)-?\s*\[([x\s])\]\s*(.+)$/);if(n){let[i,o,c,l]=n,d=this.parseTaskContent(l,s,i);d.completed=c.toLowerCase()==="x",d.projectHint=this.inferProjectFromContext(e,s),t.push(d)}}return t}static parseTaskContent(r,t,e){let s={title:r,completed:!1,line:t,originalText:e},a=r.match(this.SYNC_ID_REGEX);a&&(s.id=a[1],s.title=r.replace(this.SYNC_ID_REGEX,"").trim());let n=s.title.match(this.PRIORITY_REGEX);n&&(s.priority=this.parsePriority(n[0]),s.title=s.title.replace(this.PRIORITY_REGEX,"").trim());let i=s.title.match(this.DUE_DATE_REGEX);i&&(s.dueDate=i[1],s.title=s.title.replace(this.DUE_DATE_REGEX,"").trim());let o=[],c,l=new RegExp(this.TAG_REGEX);for(;(c=l.exec(s.title))!==null;)o.push(c[1]);return o.length>0&&(s.tags=o,s.title=s.title.replace(this.TAG_REGEX,"").trim()),s.title=s.title.trim(),s}static inferProjectFromContext(r,t){for(let e=t-1;e>=0;e--){let s=r[e].trim();if(s.match(/^#{1,6}\s+/))return s.replace(/^#+\s+/,"").trim();if(s===""&&e<t-5)break}}static parsePriority(r){switch(r){case"\u{1F534}":case"!!!":case"***":return 5;case"\u{1F7E1}":case"!!":case"**":return 3;case"\u{1F535}":case"!":case"*":return 1;default:return 0}}static taskToMarkdown(r,t=!0){let e=`- [${r.completed?"x":" "}] `;if(r.priority&&r.priority>0){let s=this.priorityToIcon(r.priority);e+=`${s} `}return e+=r.title,r.tags&&r.tags.length>0&&(e+=` ${r.tags.map(s=>`#${s}`).join(" ")}`),r.dueDate&&(e+=` @${r.dueDate}`),t&&r.id&&(e+=` <!-- dida-id: ${r.id} -->`),e}static priorityToIcon(r){switch(r){case 5:return"\u{1F534}";case 3:return"\u{1F7E1}";case 1:return"\u{1F535}";default:return""}}static tasksEqual(r,t){return r.title===t.title&&r.completed===t.completed&&r.priority===t.priority&&r.dueDate===t.dueDate&&JSON.stringify(r.tags)===JSON.stringify(t.tags)}static updateTaskInMarkdown(r,t){let e=r.split(`
`);return t.line>=0&&t.line<e.length&&(e[t.line]=this.taskToMarkdown(t,!0)),e.join(`
`)}static addTaskToMarkdown(r,t,e){let s=r.split(`
`);if(e){let a=s.findIndex(n=>n.trim()===`# ${e}`||n.trim()===`## ${e}`);if(a!==-1)return s.splice(a+1,0,this.taskToMarkdown(t,!0)),s.join(`
`)}return s.push(this.taskToMarkdown(t,!0)),s.join(`
`)}};A.TASK_REGEX=/^(\s*)-?\s*\[([x\s])\]\s*(.+)$/gm,A.SYNC_ID_REGEX=/<!--\s*dida-id:\s*([a-zA-Z0-9-]+)\s*-->/,A.PRIORITY_REGEX=/[]|!!|!|\*\*\*|\*\*|\*/,A.DUE_DATE_REGEX=/@(\d{4}-\d{2}-\d{2})/,A.TAG_REGEX=/#([^\s#]+)/g;var ot=class{constructor(r){this.isProcessingFile=new Map;this.lastSyncTimes=new Map;this.plugin=r}async syncFileToDidaTasks(r){let t={success:!1,tasksCreated:0,tasksUpdated:0,tasksDeleted:0,errors:[]};if(this.isProcessingFile.get(r.path))return t;try{this.isProcessingFile.set(r.path,!0);let e=await this.plugin.app.vault.read(r),s=A.parseMarkdownTasks(e);if(s.length===0)return t.success=!0,t;let a=this.extractSyncConfigFromFile(e,r);if(!a.projectId)return t.errors.push("\u672A\u627E\u5230\u540C\u6B65\u914D\u7F6E\u6216\u76EE\u6807\u9879\u76EE"),t;let i=(await this.plugin.apiClient.getProjectData(a.projectId)).tasks||[];await this.performSync(s,i,a.projectId,r,t),t.success=!0}catch(e){console.error("\u540C\u6B65\u6587\u4EF6\u5931\u8D25:",e),t.errors.push(e.message)}finally{this.isProcessingFile.set(r.path,!1)}return t}async performSync(r,t,e,s,a){var o;let n=!1,i=await this.plugin.app.vault.read(s);for(let c of r)try{if(c.id){let l=t.find(d=>d.id===c.id);if(l)this.needsUpdate(c,l)&&(await this.updateDidaTask(c,e),a.tasksUpdated++);else{let d=await this.createDidaTask(c,e);c.id=d.id,i=A.updateTaskInMarkdown(i,c),n=!0,a.tasksCreated++}}else{let l=await this.createDidaTask(c,e);c.id=l.id,i=A.updateTaskInMarkdown(i,c),n=!0,a.tasksCreated++}}catch(l){console.error("\u5904\u7406markdown\u4EFB\u52A1\u5931\u8D25:",l),a.errors.push(`\u4EFB\u52A1 "${c.title}": ${l.message}`)}if((o=this.plugin.settings.bidirectionalSync)!=null&&o.didaToMarkdown)for(let c of t)try{let l=r.find(d=>d.id===c.id);if(l)this.didaTaskHasUpdates(c,l)&&(this.updateMarkdownTaskFromDida(l,c),i=A.updateTaskInMarkdown(i,l),n=!0,a.tasksUpdated++);else{let d=this.didaTaskToMarkdownTask(c);i=A.addTaskToMarkdown(i,d,this.findBestSectionForTask(d)),n=!0,a.tasksCreated++}}catch(l){console.error("\u5904\u7406\u6EF4\u7B54\u6E05\u5355\u4EFB\u52A1\u5931\u8D25:",l),a.errors.push(`\u4EFB\u52A1 "${c.title}": ${l.message}`)}n&&await this.plugin.app.vault.modify(s,i)}async createDidaTask(r,t){let e={title:r.title,projectId:t,status:r.completed?2:0,priority:r.priority||0};return r.dueDate&&(e.dueDate=r.dueDate),r.tags&&r.tags.length>0&&(e.tags=r.tags),await this.plugin.apiClient.createTask(e)}async updateDidaTask(r,t){let e={title:r.title,status:r.completed?2:0,priority:r.priority||0};r.dueDate&&(e.dueDate=r.dueDate),r.tags&&(e.tags=r.tags),await this.plugin.apiClient.updateTask(r.id,e)}needsUpdate(r,t){return r.title!==t.title||(r.completed?2:0)!==t.status||(r.priority||0)!==t.priority||r.dueDate!==t.dueDate||JSON.stringify(r.tags||[])!==JSON.stringify(t.tags||[])}didaTaskToMarkdownTask(r){return{id:r.id,title:r.title,completed:r.status===2,line:-1,originalText:"",priority:r.priority,dueDate:r.dueDate,tags:r.tags}}didaTaskHasUpdates(r,t){return r.title!==t.title||r.status===2!==t.completed||r.priority!==(t.priority||0)||r.dueDate!==t.dueDate||JSON.stringify(r.tags||[])!==JSON.stringify(t.tags||[])}updateMarkdownTaskFromDida(r,t){r.title=t.title,r.completed=t.status===2,r.priority=t.priority,r.dueDate=t.dueDate,r.tags=t.tags}findBestSectionForTask(r){return r.projectHint?r.projectHint:r.priority&&r.priority>=5?"\u9AD8\u4F18\u5148\u7EA7\u4EFB\u52A1":r.completed?"\u5DF2\u5B8C\u6210\u4EFB\u52A1":"\u5F85\u529E\u4EFB\u52A1"}extractSyncConfigFromFile(r,t){let e=r.match(/^---\s*\n([\s\S]*?)\n---/);if(e)try{let n=e[1].match(/dida:\s*\n\s*projectId:\s*["']?([^"'\n]+)["']?/);if(n)return{projectId:n[1]}}catch(a){console.error("\u89E3\u6790\u524D\u7F6E\u5143\u6570\u636E\u5931\u8D25:",a)}let s=t.basename;return s.includes("\u9879\u76EE")||s.includes("Project"),{}}setupAutoSync(){this.plugin.registerEvent(this.plugin.app.vault.on("modify",async r=>{r instanceof Y.TFile&&r.extension==="md"&&await this.handleFileChange(r)})),this.plugin.registerEvent(this.plugin.app.vault.on("create",async r=>{r instanceof Y.TFile&&r.extension==="md"&&await this.handleFileChange(r)}))}async handleFileChange(r){let t=this.lastSyncTimes.get(r.path)||0,e=Date.now();e-t<2e3||(this.lastSyncTimes.set(r.path,e),setTimeout(async()=>{try{let s=await this.syncFileToDidaTasks(r);s.success&&(s.tasksCreated>0||s.tasksUpdated>0)&&new Y.Notice(`\u540C\u6B65\u5B8C\u6210: \u521B\u5EFA${s.tasksCreated}\u4E2A\uFF0C\u66F4\u65B0${s.tasksUpdated}\u4E2A\u4EFB\u52A1`),s.errors.length>0&&console.error("\u540C\u6B65\u9519\u8BEF:",s.errors)}catch(s){console.error("\u81EA\u52A8\u540C\u6B65\u5931\u8D25:",s)}},1e3))}};var ct=class extends f.Plugin{constructor(){super(...arguments);this.syncButton=null}isDevelopment(){var t;return z.isDevelopment()||((t=this.settings)==null?void 0:t.debugMode)===!0}async onload(){var t;G.setDevelopmentMode(this.isDevelopment()),S.info("DidaSync",`Loading Dida Sync Plugin v${this.manifest.version} (OAuth2)`),this.injectDidaStyleCSS(),await this.loadSettings(),(0,f.addIcon)("dida-sync",`
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L3 7V17L12 22L21 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 22V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 7L12 12L3 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `),this.apiClient=new tt(this),this.taskFormatter=new et,this.frontmatterParser=new st,this.bidirectionalSync=new ot(this),this.addSettingTab(new Q(this.app,this)),this.registerView(_,e=>new it(e,this)),this.registerView(U,e=>new nt(e,this)),this.addCommand({id:"sync-todos",name:"Sync Todos",icon:"dida-sync",callback:()=>this.syncTodos()}),this.addCommand({id:"bidirectional-sync-current-file",name:"\u53CC\u5411\u540C\u6B65\u5F53\u524D\u6587\u4EF6",icon:"sync",callback:()=>this.syncCurrentFileBidirectional()}),this.addCommand({id:"open-dida-style-task-view",name:"\u{1F389} \u6253\u5F00\u6EF4\u7B54\u4EFB\u52A1\u89C6\u56FE\uFF08\u65B0\u754C\u9762\uFF09",icon:"list-checks",callback:()=>this.activateDidaStyleTaskView()}),this.addCommand({id:"open-task-view",name:"\u6253\u5F00\u4EFB\u52A1\u89C6\u56FE\uFF08\u7ECF\u5178\uFF09",icon:"list-checks",callback:()=>this.activateTaskView()}),this.addCommand({id:"test-new-interface",name:"\u{1F9EA} \u6D4B\u8BD5\u65B0\u754C\u9762\u529F\u80FD",callback:()=>this.testNewInterface()}),this.addRibbonIcon("list-checks","\u6EF4\u7B54\u4EFB\u52A1",()=>{this.activateDidaStyleTaskView()}),this.addRibbonIcon("dida-sync","Sync Dida Todos",()=>{this.syncTodos()}),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.updateViewActions()})),this.registerEvent(this.app.workspace.on("file-open",()=>{setTimeout(()=>this.updateViewActions(),100)})),(t=this.settings.bidirectionalSync)!=null&&t.enabled&&this.bidirectionalSync.setupAutoSync()}onunload(){console.log("Unloading Dida Sync Plugin"),this.removeSyncButton();let t=document.getElementById("dida-sync-styles");t&&(t.remove(),console.log("\u2705 \u6EF4\u7B54\u6E05\u5355\u98CE\u683C CSS \u6837\u5F0F\u5DF2\u79FB\u9664"))}async loadSettings(){this.settings=Object.assign({},vt,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateDidaStyleTaskView(){console.log("\u{1F50D} \u5C1D\u8BD5\u6FC0\u6D3B\u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u4EFB\u52A1\u89C6\u56FE...");try{let{workspace:t}=this.app,e=t.getLeavesOfType(_)[0];if(!e){console.log("\u{1F4DD} \u521B\u5EFA\u65B0\u7684\u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u89C6\u56FE...");let s=t.getRightLeaf(!1);if(s)await s.setViewState({type:_,active:!0}),e=s;else{console.error("\u274C \u65E0\u6CD5\u83B7\u53D6\u53F3\u4FA7\u9762\u677F"),new f.Notice("\u65E0\u6CD5\u6253\u5F00\u4FA7\u8FB9\u680F\uFF0C\u8BF7\u786E\u4FDDObsidian\u754C\u9762\u6B63\u5E38");return}}e?(t.revealLeaf(e),this.taskView=e.view,console.log("\u2705 \u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u89C6\u56FE\u5DF2\u6FC0\u6D3B"),new f.Notice("\u{1F389} \u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u754C\u9762\u5DF2\u6253\u5F00\uFF01")):(console.error("\u274C \u65E0\u6CD5\u521B\u5EFA\u89C6\u56FE"),new f.Notice("\u65E0\u6CD5\u521B\u5EFA\u4EFB\u52A1\u89C6\u56FE\uFF0C\u8BF7\u68C0\u67E5\u63D2\u4EF6\u914D\u7F6E"))}catch(t){console.error("\u274C \u6FC0\u6D3B\u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u89C6\u56FE\u5931\u8D25:",t),new f.Notice("\u6253\u5F00\u754C\u9762\u5931\u8D25: "+t.message)}}async activateTaskView(){let{workspace:t}=this.app,e=t.getLeavesOfType(U)[0];if(!e){let s=t.getRightLeaf(!1);s&&(await s.setViewState({type:U,active:!0}),e=s)}e&&(t.revealLeaf(e),this.taskView=e.view)}async syncTodos(){let t=this.app.workspace.getActiveViewOfType(f.MarkdownView);if(!t){new f.Notice("No active markdown view");return}let e=t.file;if(!e){new f.Notice("No active file");return}if(!this.apiClient.getAuthClient().isAuthenticated()){new f.Notice("\u274C \u672A\u767B\u5F55\uFF0C\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u5B8C\u6210OAuth2\u6388\u6743"),this.app.setting.open();return}try{let a=await this.frontmatterParser.parse(e),n=this.frontmatterParser.extractSyncConfig(a);if(!n){new f.Notice('No sync configuration found in frontmatter. Add "dida:" section to your note frontmatter.');return}let i=new rt(this.app);i.open();try{i.updateStatus("Fetching tasks...");let o=await this.apiClient.getTasks(n);if(o.length===0){new f.Notice("No tasks found with current filters"),i.close();return}i.updateStatus(`Processing ${o.length} tasks...`);let c=await this.taskFormatter.formatTasks(o,this);await this.updateEditorContent(t.editor,c),new f.Notice(`Sync completed! ${o.length} tasks synchronized.`),this.settings.debugMode&&console.log("Dida sync completed:",{tasksCount:o.length,config:n})}finally{i.close()}}catch(a){new f.Notice(`Sync failed: ${a.message}`),console.error("Dida sync error:",a),this.settings.debugMode&&console.error("Dida sync debug info:",a)}}async updateEditorContent(t,e){let s=t.getValue(),a=this.taskFormatter.parseExistingContent(s),n;a.syncMarkers&&this.settings.preserveManualChanges?n=a.beforeSync+e+a.afterSync:a.beforeSync.trim()?n=a.beforeSync+`
`+e:n=e;let i=t.getCursor();t.setValue(n);let o=n.split(`
`).length;i.line<o&&t.setCursor(i)}updateViewActions(){this.removeSyncButton();let t=this.app.workspace.getActiveViewOfType(f.MarkdownView);t!=null&&t.file&&this.checkAndAddSyncButton(t.file)}async checkAndAddSyncButton(t){try{let e=await this.frontmatterParser.parse(t);this.frontmatterParser.extractSyncConfig(e)&&this.addSyncButtonToView()}catch(e){this.settings.debugMode&&console.error("Error checking sync config:",e)}}addSyncButtonToView(){let t=this.app.workspace.getActiveViewOfType(f.MarkdownView);if(!t||this.syncButton)return;let e=t.containerEl.querySelector(".view-header");if(e){let s=e.querySelector(".view-actions");s&&(this.syncButton=s.createEl("div",{cls:"view-action dida-sync-button",attr:{"aria-label":"Sync Dida Todos","data-tooltip-position":"top"}}),this.syncButton.innerHTML=`
                    <svg class="svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L3 7V17L12 22L21 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 22V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 7L12 12L3 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `,this.syncButton.addEventListener("click",()=>{this.syncTodos()}))}}async syncCurrentFileBidirectional(){let t=this.app.workspace.getActiveViewOfType(f.MarkdownView);if(!t||!t.file){new f.Notice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2Amarkdown\u6587\u4EF6");return}if(!this.apiClient.getAuthClient().isAuthenticated()){new f.Notice("\u274C \u672A\u767B\u5F55\uFF0C\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u5B8C\u6210OAuth2\u6388\u6743"),this.app.setting.open();return}try{new f.Notice("\u6B63\u5728\u8FDB\u884C\u53CC\u5411\u540C\u6B65...");let s=await this.bidirectionalSync.syncFileToDidaTasks(t.file);if(s.success){let a=[];s.tasksCreated>0&&a.push(`\u521B\u5EFA${s.tasksCreated}\u4E2A\u4EFB\u52A1`),s.tasksUpdated>0&&a.push(`\u66F4\u65B0${s.tasksUpdated}\u4E2A\u4EFB\u52A1`),s.tasksDeleted>0&&a.push(`\u5220\u9664${s.tasksDeleted}\u4E2A\u4EFB\u52A1`),a.length>0?new f.Notice(`\u53CC\u5411\u540C\u6B65\u5B8C\u6210\uFF1A${a.join("\uFF0C")}`):new f.Notice("\u53CC\u5411\u540C\u6B65\u5B8C\u6210\uFF1A\u6CA1\u6709\u53D8\u5316"),this.taskView&&await this.taskView.refreshTasks()}else new f.Notice(`\u53CC\u5411\u540C\u6B65\u5931\u8D25\uFF1A${s.errors.join("; ")}`);this.settings.debugMode&&console.log("\u53CC\u5411\u540C\u6B65\u7ED3\u679C:",s)}catch(s){new f.Notice(`\u53CC\u5411\u540C\u6B65\u5931\u8D25\uFF1A${s.message}`),console.error("\u53CC\u5411\u540C\u6B65\u9519\u8BEF:",s),this.settings.debugMode&&console.error("\u53CC\u5411\u540C\u6B65\u8BE6\u7EC6\u9519\u8BEF:",s)}}removeSyncButton(){this.syncButton&&(this.syncButton.remove(),this.syncButton=null)}injectDidaStyleCSS(){console.log("\u{1F3A8} \u6CE8\u5165\u6EF4\u7B54\u6E05\u5355\u98CE\u683C CSS \u6837\u5F0F...");let t=`
/* \u6EF4\u7B54\u6E05\u5355\u98CE\u683C\u7684\u4EFB\u52A1\u89C6\u56FE\u6837\u5F0F */
/* \u53C2\u8003\u6EF4\u7B54\u6E05\u5355\u7684\u8BBE\u8BA1\u7406\u5FF5\uFF1A\u7B80\u6D01\u3001\u6E05\u6670\u3001\u76F4\u89C2 */

.task-view-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--background-primary);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

/* ====== \u5934\u90E8\u533A\u57DF ====== */
.task-view-header {
    background: var(--background-primary);
    border-bottom: 1px solid var(--background-modifier-border);
    padding: 12px 16px;
    flex-shrink: 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

.header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.task-view-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-normal);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.dida-logo {
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #4A90FB 0%, #3B82F6 100%);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.quick-add-btn {
    background: linear-gradient(135deg, #4A90FB 0%, #3B82F6 100%);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(74, 144, 251, 0.3);
    display: flex;
    align-items: center;
    gap: 6px;
}

.quick-add-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(74, 144, 251, 0.4);
}

.quick-add-btn.active {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    box-shadow: 0 3px 6px rgba(74, 144, 251, 0.5);
}

.quick-add-btn::before {
    content: "+";
    font-size: 16px;
    font-weight: bold;
}

.refresh-btn {
    background: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
}

.refresh-btn:hover {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

/* \u641C\u7D22/\u7B5B\u9009\u5C55\u5F00\u6309\u94AE */
.toggle-search-btn {
    background: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    font-size: 16px;
}

.toggle-search-btn:hover {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

.toggle-search-btn.active {
    background: rgba(74, 144, 251, 0.1);
    color: #4A90FB;
    border-color: #4A90FB;
}

/* \u53EF\u6298\u53E0\u7684\u641C\u7D22\u548C\u7B5B\u9009\u533A\u57DF */
.collapsible-search-area {
    max-height: 500px;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), opacity 0.3s ease, margin 0.3s ease;
    opacity: 1;
    margin-top: 16px;
}

.collapsible-search-area.collapsed {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    margin-bottom: 0;
}

/* \u641C\u7D22\u680F */
.search-container {
    position: relative;
    margin-bottom: 16px;
}

.search-input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    border: 1px solid var(--background-modifier-border);
    border-radius: 24px;
    background: var(--background-secondary);
    color: var(--text-normal);
    font-size: 14px;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #4A90FB;
    box-shadow: 0 0 0 3px rgba(74, 144, 251, 0.1);
    background: var(--background-primary);
}

.search-input::placeholder {
    color: var(--text-muted);
}

.search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 16px;
    pointer-events: none;
}

/* \u5206\u7EC4\u65B9\u5F0F\u9009\u62E9\u5668 */
.groupby-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    justify-content: space-between; /* \u8BA9\u7EDF\u8BA1\u4FE1\u606F\u9760\u53F3 */
}

.groupby-container.compact {
    margin-bottom: 12px;
    padding: 8px 0;
}

.groupby-label {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 500;
}

.groupby-container.compact .groupby-label {
    font-size: 13px;
}

.groupby-select {
    padding: 8px 12px;
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    background: var(--background-secondary);
    color: var(--text-normal);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 160px;
}

.groupby-container.compact .groupby-select {
    padding: 6px 10px;
    font-size: 13px;
    min-width: 140px;
}

.groupby-select:focus {
    outline: none;
    border-color: #4A90FB;
    box-shadow: 0 0 0 3px rgba(74, 144, 251, 0.1);
}

.groupby-select:hover {
    background: var(--background-modifier-hover);
}

/* \u7B5B\u9009\u5668 */
.filters-container {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
}

.filter-chip {
    background: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    flex-shrink: 0;
}

.filter-chip.active {
    background: #4A90FB;
    color: white;
    border-color: #4A90FB;
}

.filter-chip:hover:not(.active) {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

/* ====== \u5185\u5BB9\u533A\u57DF ====== */
.task-content-area {
    flex: 1;
    overflow: hidden; /* \u9632\u6B62\u7236\u5BB9\u5668\u51FA\u73B0\u6EDA\u52A8\u6761 */
    padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 0; /* \u5173\u952E\uFF1A\u5141\u8BB8flex\u5B50\u5143\u7D20\u6B63\u786E\u6536\u7F29 */
}

/* Tab\u5BFC\u822A\u5934\u90E8\u5305\u88C5\u5668 */
.tabs-header-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--background-primary);
    border-bottom: 2px solid var(--background-modifier-border);
    padding: 8px 16px;
    gap: 16px;
}

/* \u7EDF\u8BA1\u4FE1\u606F */
.task-stats {
    background: linear-gradient(135deg, #4A90FB 0%, #3B82F6 100%);
    color: white;
    padding: 16px;
    margin: 0;
    text-align: center;
    font-size: 14px;
}

/* \u7D27\u51D1\u7EDF\u8BA1\u6837\u5F0F */
.task-stats.compact {
    background: transparent;
    padding: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.stat-compact {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    color: var(--text-muted);
    white-space: nowrap;
}

.stat-compact .stat-number {
    font-weight: 600;
    color: var(--text-normal);
    font-size: 14px;
}

.stats-row {
    display: flex;
    justify-content: center;
    gap: 24px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.stat-number {
    font-size: 20px;
    font-weight: bold;
}

.stat-label {
    font-size: 12px;
    opacity: 0.9;
}

/* ====== \u667A\u80FD\u5206\u7EC4 ====== */
.smart-groups {
    padding: 0;
    background: var(--background-primary);
    flex: 1; /* \u5360\u636E\u5269\u4F59\u7A7A\u95F4 */
    overflow-y: auto; /* \u4EFB\u52A1\u5217\u8868\u53EF\u4EE5\u7EB5\u5411\u6EDA\u52A8 */
    overflow-x: hidden; /* \u4E0D\u6A2A\u5411\u6EDA\u52A8 */
    min-height: 0; /* \u5173\u952E\uFF1A\u5141\u8BB8\u6B63\u786E\u6536\u7F29 */
}

/* Tab\u5BFC\u822A\u5BB9\u5668 */
.group-tabs-container {
    background: var(--background-primary);
    border-bottom: 2px solid var(--background-modifier-border);
    overflow: hidden;
    width: 100%; /* \u5360\u6EE1\u6574\u884C */
}

.group-tabs-wrapper {
    display: flex;
    gap: 0;
    overflow-x: auto; /* \u6A2A\u5411\u53EF\u6EDA\u52A8 */
    overflow-y: hidden;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    /* \u9690\u85CF\u6EDA\u52A8\u6761\u4F46\u4FDD\u6301\u53EF\u6EDA\u52A8 */
    scrollbar-width: thin;
    scrollbar-color: var(--interactive-accent) transparent;
}

.group-tabs-wrapper::-webkit-scrollbar {
    height: 3px;
}

.group-tabs-wrapper::-webkit-scrollbar-track {
    background: transparent;
}

.group-tabs-wrapper::-webkit-scrollbar-thumb {
    background: var(--interactive-accent);
    border-radius: 2px;
}

/* Tab\u6807\u7B7E\u6837\u5F0F */
.group-tab {
    flex-shrink: 0;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    background: var(--background-primary);
    position: relative;
}

.group-tab:hover {
    background: var(--background-modifier-hover);
}

.group-tab.active {
    border-bottom-color: var(--interactive-accent);
    background: var(--background-modifier-hover);
}

.group-tab-content {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.group-tab-icon {
    font-size: 16px;
}

.group-tab-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-normal);
}

.group-tab.active .group-tab-title {
    color: var(--interactive-accent);
    font-weight: 600;
}

.group-tab-count {
    background: var(--background-modifier-border);
    color: var(--text-muted);
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
}

.group-tab.active .group-tab-count {
    background: var(--interactive-accent);
    color: white;
}

/* Tab\u62D6\u62FD\u624B\u67C4 */
.group-tab-drag-handle {
    color: var(--text-muted);
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s ease;
    cursor: grab;
    user-select: none;
}

.group-tab:hover .group-tab-drag-handle {
    opacity: 1;
}

.group-tab-drag-handle:active {
    cursor: grabbing;
}

/* Tab\u62D6\u62FD\u72B6\u6001 */
.group-tab.dragging {
    opacity: 0.5;
    transform: rotate(2deg) scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
}

/* Tab\u62D6\u62FD\u60AC\u505C\u6307\u793A\u5668 */
.group-tab.drag-over-left::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--interactive-accent);
    animation: dragIndicatorPulse 1s infinite;
}

.group-tab.drag-over-right::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--interactive-accent);
    animation: dragIndicatorPulse 1s infinite;
}

@keyframes dragIndicatorPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* \u5F53\u524D\u6FC0\u6D3B\u5206\u7EC4\u7684\u4EFB\u52A1\u5217\u8868 */
.active-group-tasks {
    padding: 0;
    width: 100%;
}

.active-group-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--background-secondary);
    border-bottom: 1px solid var(--background-modifier-border);
    position: sticky;
    top: 0;
    z-index: 10;
}

.active-group-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-normal);
}

.task-count-badge {
    background: var(--interactive-accent);
    color: white;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 500;
}

.group-section {
    margin: 0;
    border-bottom: 1px solid var(--background-modifier-border);
    background: var(--background-primary);
}

.group-section:last-child {
    border-bottom: none;
}

.group-header {
    background: var(--background-secondary);
    padding: 16px 20px;
    border-bottom: 1px solid var(--background-modifier-border);
    position: sticky;
    top: 0;
    z-index: 10;
    cursor: pointer;
    transition: background 0.2s ease;
}

.group-header:hover {
    background: var(--background-modifier-hover);
}

.group-title-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
}

.group-collapse-icon {
    color: var(--text-muted);
    font-size: 12px;
    transition: transform 0.3s ease, color 0.2s ease;
    margin-right: 4px;
    user-select: none;
}

.group-header:hover .group-collapse-icon {
    color: var(--text-normal);
}

.group-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-normal);
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex: 1;
}

.group-count {
    background: var(--text-muted);
    color: var(--background-primary);
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 500;
    min-width: 20px;
    text-align: center;
}

.group-tasks {
    background: var(--background-primary);
    min-height: 50px;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), opacity 0.3s ease;
}

.group-tasks.collapsed {
    max-height: 0;
    min-height: 0;
    opacity: 0;
    padding: 0;
    border: none;
}

/* ====== \u4EFB\u52A1\u5361\u7247\uFF08\u6EF4\u7B54\u6E05\u5355\u98CE\u683C\uFF09====== */
.task-card {
    display: flex;
    align-items: flex-start;
    padding: 16px 20px;
    border-bottom: 1px solid var(--background-modifier-border);
    background: var(--background-primary);
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    min-height: 60px;
}

.task-card:hover {
    background: var(--background-modifier-hover);
}

.task-card.completed {
    opacity: 0.6;
}

.task-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
    z-index: 1000;
}

/* \u62D6\u62FD\u624B\u67C4 */
.task-drag-handle {
    color: var(--text-muted);
    font-size: 12px;
    margin-right: 8px;
    margin-top: 2px;
    cursor: grab;
    opacity: 0;
    transition: opacity 0.2s ease;
    line-height: 1;
    writing-mode: vertical-lr;
}

.task-card:hover .task-drag-handle {
    opacity: 1;
}

.task-drag-handle:hover {
    color: var(--text-normal);
}

.task-drag-handle:active {
    cursor: grabbing;
}

/* \u62D6\u62FD\u6295\u653E\u533A\u57DF */
.group-tasks.drop-target {
    background: rgba(74, 144, 251, 0.1);
    border: 2px dashed #4A90FB;
    border-radius: 8px;
}

.drag-drop-indicator {
    height: 2px;
    background: #4A90FB;
    border-radius: 1px;
    margin: 8px 0;
    position: relative;
    animation: dragIndicatorPulse 1s infinite;
}

.drag-drop-indicator::before {
    content: '';
    position: absolute;
    left: -4px;
    top: -3px;
    width: 8px;
    height: 8px;
    background: #4A90FB;
    border-radius: 50%;
}

@keyframes dragIndicatorPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.task-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: transparent;
    transition: background 0.2s ease;
}

.task-card.priority-high::before {
    background: #FF4757;
}

.task-card.priority-medium::before {
    background: #FFA726;
}

.task-card.priority-low::before {
    background: #42A5F5;
}

/* \u4EFB\u52A1\u590D\u9009\u6846 */
.task-checkbox-wrapper {
    margin-right: 16px;
    margin-top: 2px;
}

.task-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--text-muted);
    border-radius: 50%;
    background: transparent;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
    appearance: none;
    outline: none;
}

.task-checkbox:hover {
    border-color: #4A90FB;
    transform: scale(1.1);
}

.task-checkbox:checked {
    background: #4A90FB;
    border-color: #4A90FB;
}

.task-checkbox:checked::after {
    content: '\u2713';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

/* \u4EFB\u52A1\u5185\u5BB9 */
.task-main-content {
    flex: 1;
    min-width: 0;
}

.task-title {
    font-size: 15px;
    line-height: 1.4;
    color: var(--text-normal);
    margin: 0 0 8px 0;
    word-wrap: break-word;
    transition: all 0.3s ease;
}

.task-card.completed .task-title {
    text-decoration: line-through;
    color: var(--text-muted);
}

.task-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    flex-wrap: wrap;
}

.task-project {
    color: var(--text-muted);
    background: var(--background-secondary);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
}

.task-due-date {
    color: #4A90FB;
    background: rgba(74, 144, 251, 0.1);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
}

.task-due-date.overdue {
    color: #FF4757;
    background: rgba(255, 71, 87, 0.1);
}

.task-due-date.today {
    color: #FFA726;
    background: rgba(255, 167, 38, 0.1);
}

.task-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.task-tag {
    background: var(--interactive-accent);
    color: var(--text-on-accent);
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 500;
}

/* \u4EFB\u52A1\u64CD\u4F5C */
.task-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 12px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.task-card:hover .task-actions {
    opacity: 1;
}

.task-action-btn {
    background: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 6px;
    padding: 6px;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.2s ease;
    font-size: 14px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.task-action-btn:hover {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

.task-action-btn.delete:hover {
    background: rgba(255, 71, 87, 0.1);
    color: #FF4757;
    border-color: #FF4757;
}

/* ====== \u6B22\u8FCE\u548C\u9519\u8BEF\u6D88\u606F ====== */
.welcome-message, .error-message-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
}

.welcome-icon, .error-icon {
    font-size: 64px;
    margin-bottom: 20px;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

.welcome-title, .error-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-normal);
    margin: 0 0 12px 0;
}

.welcome-description, .error-description {
    font-size: 16px;
    color: var(--text-muted);
    margin: 0 0 20px 0;
    line-height: 1.6;
    max-width: 400px;
}

.retry-btn {
    background: linear-gradient(135deg, #4A90FB 0%, #3B82F6 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 16px;
}

.retry-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 144, 251, 0.4);
}

/* ====== \u7A7A\u72B6\u6001 ====== */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-normal);
    margin: 0 0 8px 0;
}

.empty-description {
    font-size: 14px;
    color: var(--text-muted);
    margin: 0;
    line-height: 1.5;
}

/* \u661F\u6807\u6309\u94AE\u7279\u6B8A\u6837\u5F0F */
.task-action-btn.star {
    color: #FFD700;
    transition: all 0.2s ease;
}

.task-action-btn.star:hover {
    transform: scale(1.2);
    background: rgba(255, 215, 0, 0.1);
    border-color: #FFD700;
}

/* \u5FEB\u901F\u6DFB\u52A0\u8868\u5355 */
.quick-add-form {
    background: var(--background-primary);
    border-top: 1px solid var(--background-modifier-border);
    padding: 12px 16px;
    position: sticky;
    bottom: 0;
    z-index: 50;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
    max-height: 200px;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0.0, 0.2, 1),
                padding 0.3s ease,
                opacity 0.3s ease,
                transform 0.3s ease;
    opacity: 1;
    transform: translateY(0);
}

.quick-add-form.collapsed {
    max-height: 0;
    padding: 0 16px;
    opacity: 0;
    transform: translateY(20px);
    border-top: none;
    box-shadow: none;
}

.add-input-container {
    display: flex;
    gap: 8px;
    align-items: flex-start;
}

.add-task-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--background-modifier-border);
    border-radius: 12px;
    background: var(--background-secondary);
    color: var(--text-normal);
    font-size: 14px;
    resize: none;
    min-height: 40px;
    max-height: 80px;
    box-sizing: border-box;
}

.add-task-input:focus {
    outline: none;
    border-color: #4A90FB;
    box-shadow: 0 0 0 3px rgba(74, 144, 251, 0.1);
}

.add-task-input::placeholder {
    color: var(--text-muted);
}

.add-options {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.add-option-btn {
    background: var(--background-secondary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 16px;
    padding: 4px 10px;
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.add-option-btn:hover {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

.add-option-btn.active {
    background: #4A90FB;
    color: white;
    border-color: #4A90FB;
}

/* ====== \u52A0\u8F7D\u72B6\u6001 ====== */
.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    gap: 16px;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--background-modifier-border);
    border-top: 3px solid #4A90FB;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: var(--text-muted);
    font-size: 14px;
}

/* ====== \u4EFB\u52A1\u5168\u9762\u7F16\u8F91\u6A21\u6001\u6846 ====== */
.task-edit-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(3px);
    animation: modalOverlayFadeIn 0.3s ease-out;
}

@keyframes modalOverlayFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.task-edit-modal {
    background: var(--background-primary);
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid var(--background-modifier-border);
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--background-modifier-border);
    background: var(--background-secondary);
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-normal);
    margin: 0;
}

.modal-close-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 24px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.modal-close-btn:hover {
    background: var(--background-modifier-hover);
    color: var(--text-normal);
}

.task-edit-form {
    padding: 24px;
    max-height: calc(90vh - 160px);
    overflow-y: auto;
}

.form-group {
    margin-bottom: 20px;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-normal);
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    background: var(--background-secondary);
    color: var(--text-normal);
    font-size: 14px;
    box-sizing: border-box;
    transition: all 0.3s ease;
    font-family: inherit;
    line-height: 1.6; /* \u589E\u52A0\u884C\u9AD8\u786E\u4FDD\u6587\u5B57\u4E0D\u88AB\u88C1\u5207 */
}

/* \u4E3Ainput\u7279\u522B\u8BBE\u7F6E\u6837\u5F0F */
.form-input {
    min-height: 44px;
    display: flex;
    align-items: center;
}

/* \u4E3Aselect\u7279\u522B\u8BBE\u7F6E\u6837\u5F0F */
.form-select {
    min-height: 44px; /* \u786E\u4FDD\u8DB3\u591F\u9AD8\u5EA6 */
    height: auto;
    line-height: 1.6;
    padding-top: 10px;
    padding-bottom: 10px;
    appearance: none; /* \u79FB\u9664\u9ED8\u8BA4\u6837\u5F0F */
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23888' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px; /* \u4E3A\u4E0B\u62C9\u7BAD\u5934\u7559\u51FA\u7A7A\u95F4 */
    cursor: pointer;
}

.form-select option {
    padding: 8px;
    line-height: 1.6;
    min-height: 32px;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #4A90FB;
    box-shadow: 0 0 0 3px rgba(74, 144, 251, 0.1);
    background: var(--background-primary);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
    line-height: 1.5;
}

.modal-buttons {
    padding: 20px 24px;
    border-top: 1px solid var(--background-modifier-border);
    background: var(--background-secondary);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 80px;
    font-family: inherit;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-cancel {
    background: var(--background-modifier-border);
    color: var(--text-normal);
}

.btn-cancel:hover:not(:disabled) {
    background: var(--background-modifier-hover);
}

.btn-primary {
    background: linear-gradient(135deg, #4A90FB 0%, #3B82F6 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(74, 144, 251, 0.3);
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(74, 144, 251, 0.4);
}

.btn-danger {
    background: #FF4757;
    color: white;
    box-shadow: 0 2px 4px rgba(255, 71, 87, 0.3);
}

.btn-danger:hover:not(:disabled) {
    background: #e74c3c;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(255, 71, 87, 0.4);
}

/* \u54CD\u5E94\u5F0F\u8BBE\u8BA1 */
@media (max-width: 768px) {
    .task-edit-modal {
        width: 95%;
        max-height: 95vh;
    }

    .modal-header, .modal-buttons {
        padding: 16px 20px;
    }

    .task-edit-form {
        padding: 20px;
    }

    .modal-buttons {
        flex-direction: column-reverse;
    }

    .btn {
        width: 100%;
    }
}

/* \u6EDA\u52A8\u6761\u6837\u5F0F */
.task-edit-form::-webkit-scrollbar {
    width: 8px;
}

.task-edit-form::-webkit-scrollbar-track {
    background: var(--background-secondary);
}

.task-edit-form::-webkit-scrollbar-thumb {
    background: var(--text-muted);
    border-radius: 4px;
}

.task-edit-form::-webkit-scrollbar-thumb:hover {
    background: var(--text-normal);
}

`,e=document.createElement("style");e.id="dida-sync-styles",e.textContent=t;let s=document.getElementById("dida-sync-styles");s&&s.remove(),document.head.appendChild(e),console.log("\u2705 \u6EF4\u7B54\u6E05\u5355\u98CE\u683C CSS \u6837\u5F0F\u6CE8\u5165\u5B8C\u6210"),console.log("\u{1F50D} CSS\u6837\u5F0F\u5143\u7D20\u5DF2\u6DFB\u52A0\u5230DOM\uFF0CID:",e.id)}async testNewInterface(){console.log("\u{1F9EA} \u5F00\u59CB\u6D4B\u8BD5\u65B0\u754C\u9762\u529F\u80FD...");try{if(!this.apiClient.getAuthClient().isAuthenticated()){new f.Notice("\u274C \u672A\u767B\u5F55\uFF0C\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u4F7F\u7528\u8D26\u53F7\u5BC6\u7801\u767B\u5F55");return}console.log("\u{1F4CB} \u6D4B\u8BD5API\u8FDE\u63A5...");let e=await this.apiClient.getProjects();console.log(`\u2705 \u6210\u529F\u83B7\u53D6 ${e.length} \u4E2A\u9879\u76EE`),await this.activateDidaStyleTaskView(),new f.Notice(`\u{1F389} \u6D4B\u8BD5\u6210\u529F\uFF01\u53D1\u73B0 ${e.length} \u4E2A\u9879\u76EE\uFF0C\u65B0\u754C\u9762\u5DF2\u6253\u5F00`)}catch(t){console.error("\u274C \u6D4B\u8BD5\u5931\u8D25:",t),new f.Notice(`\u274C \u6D4B\u8BD5\u5931\u8D25: ${t.message}`)}}};
